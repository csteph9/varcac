import{r as f,o as Ct,m as bt,c as r,a,u as e,w as l,b as p,e as s,t as o,R as lt,q as gt,C as q,g as Y,k as T,F as P,f as $,d as E,l as wt,p as kt,h as g,i as St,j as u}from"./index-DpVV47OG.js";import{C as Pt}from"./CBadge-_2hIcJnc.js";import{C as v}from"./CButton-y8u4-JDy.js";import{C as K}from"./CCardHeader-Bqpplymn.js";import{C as $t}from"./CForm-D20y0FM6.js";import{C as xt}from"./CFormSelect-BGe0uVA_.js";import{C as Dt,a as Q}from"./CRow-C4SP1EIB.js";import{C as R,a as z,b as O,c as H,d as U}from"./CModalTitle-Cjr-1VfR.js";import{C as j}from"./CSpinner-B-jNG_5h.js";import{a as at,b as J,c,d as nt,C as st,e as C}from"./CTable-8I02-EpL.js";const Nt={class:"p-3"},Lt={key:0,class:"py-3"},At={key:1},Tt={key:2},Et={class:"text-muted small"},It={class:"d-flex gap-2"},Mt={key:1,class:"text-muted"},Vt={key:0},Bt={key:1},Ft={key:0,class:"text-muted"},Rt={class:"d-flex align-items-center mb-2"},zt={class:"me-2"},Ot={key:0,class:"text-muted"},Ht={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},Ut={class:"text-muted"},jt={class:"mb-3"},Jt=["value"],Wt={key:0,class:"text-danger mt-2"},Gt={style:{"white-space":"pre-wrap","word-break":"break-word",margin:"0"}},qt={key:0,class:"text-muted"},Yt={key:1,class:"d-flex flex-column gap-2"},Kt=["checked","disabled","onChange"],oe={__name:"ParticipantDetail",setup(Qt){const b=gt(),it=St(),W=f(!0),m=f({participant:null,plans:[]}),x=f(!1),X=f([]),w=f(""),k=f({loading:!0,plans:[]}),I=async()=>{var i;W.value=!0;try{const{data:t}=await g.get(`/api/participants/${b.params.id}`,{withCredentials:!0}),n=Array.isArray(t.plans)?t.plans:[];for(const d of n)d.planId=d.planId??d.plan_id??((i=d.plan)==null?void 0:i.id)??d.cpId??d.cid??null;m.value={participant:t.participant??null,plans:n}}finally{W.value=!1}},ot=async()=>{const{data:i}=await g.get("/api/plans",{withCredentials:!0});X.value=i||[]},M=async()=>{k.value.loading=!0;try{const{data:i}=await g.get(`/api/participants/${b.params.id}/payout-history`,{withCredentials:!0});k.value.plans=(i==null?void 0:i.plans)||[]}finally{k.value.loading=!1}};Ct(async()=>{await Promise.all([I(),ot(),M()])}),bt(()=>b.params.id,async()=>{await Promise.all([I(),M()])});const ut=()=>{w.value="",x.value=!0},Z=async()=>{w.value&&(await g.post(`/api/participants/${b.params.id}/plans`,{planId:Number(w.value)},{withCredentials:!0}),x.value=!1,await Promise.all([I(),M()]))},dt=async i=>{confirm("Detach this plan from the participant?")&&(await g.delete(`/api/participants/${b.params.id}/plans/${i}`,{withCredentials:!0}),await Promise.all([I(),M()]))},D=f(!1),N=f(!1),V=f(""),rt=()=>{D.value=!0},pt=async()=>{var i,t;N.value=!0,V.value="";try{await g.delete(`/api/participants/${b.params.id}`,{withCredentials:!0}),it.push({name:"ParticipantsList"})}catch(n){V.value=((t=(i=n==null?void 0:n.response)==null?void 0:i.data)==null?void 0:t.error)||"Delete failed"}finally{N.value=!1,D.value=N.value}},h=i=>(Number.isFinite(Number(i))?Number(i):0).toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}),ft=i=>i?new Date(i).toLocaleString():"â€”",B=f(!1),tt=f(""),et=f("");function mt(i){if(i==null||i==="")return"(no payload)";try{if(typeof i=="string"){const t=i.trim();return t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")?JSON.stringify(JSON.parse(i),null,2):i}return JSON.stringify(i,null,2)}catch{return String(i)}}function vt(i,t,n){tt.value=`${i.planName} Â· ${t.periodStart} â†’ ${t.periodEnd} Â· ${n.outputLabel}`,et.value=mt(n.payload),B.value=!0}const L=f(!1),_=f(new Set),A=f(!1);function _t(i){i&&(_.value.has(i)?_.value.delete(i):_.value.add(i),_.value=new Set(_.value))}async function yt(){var i,t;if(!_.value.size){alert("Select at least one plan.");return}Array.from(_.value),A.value=!0;try{const n=Array.from(_.value),{data:d}=await g.post(`/api/participants/${b.params.id}/comp-statement`,{planIds:n},{withCredentials:!0,responseType:"blob"}),y=new Blob([d],{type:"application/html"}),F=URL.createObjectURL(y),S=document.createElement("a"),G=new Date,ct=`${G.getFullYear()}-${String(G.getMonth()+1).padStart(2,"0")}-${String(G.getDate()).padStart(2,"0")}`;S.href=F,S.download=`CompStatement_${m.value.participant.lastName}_${ct}.html`,document.body.appendChild(S),S.click(),S.remove(),URL.revokeObjectURL(F),L.value=!1}catch(n){console.error(n),alert(((t=(i=n==null?void 0:n.response)==null?void 0:i.data)==null?void 0:t.error)||(n==null?void 0:n.message)||"Failed to generate statement")}finally{A.value=!1}}return(i,t)=>(u(),r("div",Nt,[W.value?(u(),r("div",Lt,[a(e(j))])):m.value.participant?(u(),r("div",Tt,[a(e(Y),{class:"mb-3"},{default:l(()=>[a(e(K),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:l(()=>[p("span",null,[s(" Participant: "+o(m.value.participant.firstName)+" "+o(m.value.participant.lastName)+" ",1),p("span",Et,"(#"+o(m.value.participant.id)+")",1)]),p("div",It,[a(e(lt),{class:"btn btn-primary",to:{name:"ParticipantEdit",params:{id:e(b).params.id}}},{default:l(()=>t[10]||(t[10]=[s("Edit",-1)])),_:1,__:[10]},8,["to"]),a(e(v),{color:"danger",variant:"outline",onClick:rt},{default:l(()=>t[11]||(t[11]=[s("Delete",-1)])),_:1,__:[11]}),a(e(v),{color:"primary",size:"sm",onClick:ut},{default:l(()=>t[12]||(t[12]=[s("Attach Plan",-1)])),_:1,__:[12]}),a(e(v),{color:"warning",size:"sm",onClick:t[0]||(t[0]=n=>L.value=!0)},{default:l(()=>t[13]||(t[13]=[s("Comp Statement",-1)])),_:1,__:[13]})])]),_:1}),a(e(q),null,{default:l(()=>[a(e(Dt),null,{default:l(()=>[a(e(Q),{md:"4"},{default:l(()=>[t[14]||(t[14]=p("strong",null,"Email:",-1)),s(" "+o(m.value.participant.email),1)]),_:1,__:[14]}),a(e(Q),{md:"4"},{default:l(()=>[t[15]||(t[15]=p("strong",null,"ID:",-1)),s(" "+o(m.value.participant.id),1)]),_:1,__:[15]}),a(e(Q),{md:"4"},{default:l(()=>[t[16]||(t[16]=p("strong",null,"Created:",-1)),s(" "+o(new Date(m.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[16]})]),_:1})]),_:1})]),_:1}),a(e(Y),null,{default:l(()=>[a(e(K),{class:"fw-semibold"},{default:l(()=>t[17]||(t[17]=[s("Attached Plans",-1)])),_:1,__:[17]}),a(e(q),null,{default:l(()=>[m.value.plans.length?(u(),T(e(st),{key:0,hover:"",responsive:""},{default:l(()=>[a(e(at),null,{default:l(()=>[a(e(J),null,{default:l(()=>[a(e(c),null,{default:l(()=>t[18]||(t[18]=[s("Name",-1)])),_:1,__:[18]}),a(e(c),null,{default:l(()=>t[19]||(t[19]=[s("Version",-1)])),_:1,__:[19]}),a(e(c),null,{default:l(()=>t[20]||(t[20]=[s("Plan Effective",-1)])),_:1,__:[20]}),a(e(c),null,{default:l(()=>t[21]||(t[21]=[s("Attached",-1)])),_:1,__:[21]}),a(e(c),null,{default:l(()=>t[22]||(t[22]=[s("Actions",-1)])),_:1,__:[22]})]),_:1})]),_:1}),a(e(nt),null,{default:l(()=>[(u(!0),r(P,null,$(m.value.plans,n=>(u(),T(e(J),{key:n.id},{default:l(()=>[a(e(C),null,{default:l(()=>[s(o(n.name),1)]),_:2},1024),a(e(C),null,{default:l(()=>[s("v"+o(n.version),1)]),_:2},1024),a(e(C),null,{default:l(()=>[s(o(n.planEffectiveStart||"â€”")+" â†’ "+o(n.planEffectiveEnd||"â€”"),1)]),_:2},1024),a(e(C),null,{default:l(()=>[s(o(new Date(n.attachedAt).toLocaleString()),1)]),_:2},1024),a(e(C),null,{default:l(()=>[a(e(v),{color:"secondary",size:"sm",onClick:d=>dt(n.id)},{default:l(()=>t[23]||(t[23]=[s("Detach",-1)])),_:2,__:[23]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(u(),r("div",Mt,"No plans attached yet."))]),_:1})]),_:1}),a(e(Y),{class:"mt-3"},{default:l(()=>[a(e(K),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:l(()=>[t[25]||(t[25]=p("span",null,"Payout History (by Plan & Period)",-1)),a(e(lt),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:l(()=>t[24]||(t[24]=[s("View Plans",-1)])),_:1,__:[24]})]),_:1,__:[25]}),a(e(q),null,{default:l(()=>[k.value.loading?(u(),r("div",Vt,[a(e(j))])):(u(),r("div",Bt,[k.value.plans.length?E("",!0):(u(),r("div",Ft,"No payout history yet.")),(u(!0),r(P,null,$(k.value.plans,n=>(u(),r("div",{key:n.planId,class:"mb-4"},[p("div",Rt,[p("strong",zt,o(n.planName),1),a(e(Pt),{color:"secondary",class:"me-2"},{default:l(()=>[s("v"+o(n.planVersion),1)]),_:2},1024)]),a(e(st),{hover:"",responsive:"",small:""},{default:l(()=>[a(e(at),null,{default:l(()=>[a(e(J),null,{default:l(()=>[a(e(c),{style:{"min-width":"120px"}},{default:l(()=>t[26]||(t[26]=[s("Period",-1)])),_:1,__:[26]}),a(e(c),{style:{"min-width":"120px"}},{default:l(()=>t[27]||(t[27]=[s("Period End Date",-1)])),_:1,__:[27]}),a(e(c),{style:{"min-width":"160px","text-align":"center"}},{default:l(()=>t[28]||(t[28]=[s("Total Payout",-1)])),_:1,__:[28]}),a(e(c),null,{default:l(()=>t[29]||(t[29]=[s("Computations",-1)])),_:1,__:[29]})]),_:1})]),_:1}),a(e(nt),null,{default:l(()=>[(u(!0),r(P,null,$(n.periods,d=>(u(),T(e(J),{key:d.periodStart+"|"+d.periodEnd+"|"+(d.periodLabel||"")},{default:l(()=>[a(e(C),null,{default:l(()=>[p("div",null,[s(o(new Date(d.periodStart).toISOString().split("T")[0])+" â­¾ ",1),t[30]||(t[30]=p("br",null,null,-1)),s(o(new Date(d.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),a(e(C),null,{default:l(()=>[s(o(new Date(d.dueDate).toISOString().split("T")[0]),1),t[31]||(t[31]=p("br",null,null,-1)),d.periodLabel?(u(),r("small",Ot,o(d.periodLabel),1)):E("",!0)]),_:2,__:[31]},1024),a(e(C),{style:{"text-align":"center"}},{default:l(()=>[p("strong",null,o(h(d.total)),1)]),_:2},1024),a(e(C),null,{default:l(()=>[p("ul",Ht,[(u(!0),r(P,null,$(d.lines,(y,F)=>(u(),r("li",{key:y.id||F},[a(e(v),{size:"sm",color:"success",class:"ms-2",variant:"outline",shape:"rounded-3",disabled:!y.payload||y.payload==="",onClick:S=>vt(n,d,y),title:"View payload"},{default:l(()=>[p("strong",null,o(y.outputLabel),1)]),_:2},1032,["disabled","onClick"]),s(" â†’ "+o(h(y.amount))+" ",1),p("span",Ut,"Â â€¢ ("+o(ft(y.createdAt))+")",1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),a(e(U),{visible:x.value,onClose:t[3]||(t[3]=n=>x.value=!1),alignment:"center",backdrop:"static"},{default:l(()=>[a(e(R),null,{default:l(()=>[a(e(z),null,{default:l(()=>t[32]||(t[32]=[s("Attach Plan",-1)])),_:1,__:[32]})]),_:1}),a(e(O),null,{default:l(()=>[a(e($t),{onSubmit:wt(Z,["prevent"])},{default:l(()=>[p("div",jt,[a(e(kt),null,{default:l(()=>t[33]||(t[33]=[s("Select a plan",-1)])),_:1,__:[33]}),a(e(xt),{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=n=>w.value=n)},{default:l(()=>[t[34]||(t[34]=p("option",{value:""},"Select a planâ€¦",-1)),(u(!0),r(P,null,$(X.value,n=>(u(),r("option",{key:n.id,value:n.id},o(n.name)+" (v"+o(n.version)+")",9,Jt))),128))]),_:1,__:[34]},8,["modelValue"])])]),_:1})]),_:1}),a(e(H),null,{default:l(()=>[a(e(v),{color:"secondary",onClick:t[2]||(t[2]=n=>x.value=!1)},{default:l(()=>t[35]||(t[35]=[s("Cancel",-1)])),_:1,__:[35]}),a(e(v),{color:"primary",disabled:!w.value,onClick:Z},{default:l(()=>t[36]||(t[36]=[s("Attach",-1)])),_:1,__:[36]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(e(U),{visible:D.value,onClose:t[5]||(t[5]=n=>D.value=!1)},{default:l(()=>[a(e(R),null,{default:l(()=>[a(e(z),null,{default:l(()=>t[37]||(t[37]=[s("Delete participant?",-1)])),_:1,__:[37]})]),_:1}),a(e(O),null,{default:l(()=>[t[38]||(t[38]=s(" This cannot be undone. Continue? ",-1)),V.value?(u(),r("div",Wt,o(V.value),1)):E("",!0)]),_:1,__:[38]}),a(e(H),null,{default:l(()=>[a(e(v),{color:"secondary",onClick:t[4]||(t[4]=n=>D.value=!1)},{default:l(()=>t[39]||(t[39]=[s("Cancel",-1)])),_:1,__:[39]}),a(e(v),{color:"danger",disabled:N.value,onClick:pt},{default:l(()=>[N.value?(u(),T(e(j),{key:0,size:"sm",class:"me-2"})):E("",!0),t[40]||(t[40]=s(" Delete ",-1))]),_:1,__:[40]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(e(U),{visible:B.value,onClose:t[7]||(t[7]=n=>B.value=!1),size:"lg",alignment:"center",scrollable:""},{default:l(()=>[a(e(R),null,{default:l(()=>[a(e(z),null,{default:l(()=>[s(o(tt.value||"Payload"),1)]),_:1})]),_:1}),a(e(O),null,{default:l(()=>[p("pre",Gt,o(et.value),1)]),_:1}),a(e(H),null,{default:l(()=>[a(e(v),{color:"secondary",onClick:t[6]||(t[6]=n=>B.value=!1)},{default:l(()=>t[41]||(t[41]=[s("Close",-1)])),_:1,__:[41]})]),_:1})]),_:1},8,["visible"]),a(e(U),{visible:L.value,onClose:t[9]||(t[9]=n=>L.value=!1),alignment:"center",backdrop:"static"},{default:l(()=>[a(e(R),null,{default:l(()=>[a(e(z),null,{default:l(()=>t[42]||(t[42]=[s("Generate Comp Statement",-1)])),_:1,__:[42]})]),_:1}),a(e(O),null,{default:l(()=>[t[43]||(t[43]=p("div",{class:"mb-2 text-muted"},"Select plan(s) to include:",-1)),m.value.plans.length?(u(),r("div",Yt,[(u(!0),r(P,null,$(m.value.plans,n=>(u(),r("label",{key:n.id,class:"d-flex align-items-center gap-2"},[p("input",{type:"checkbox",checked:_.value.has(n.planId),disabled:!n.planId,onChange:d=>_t(n.planId)},null,40,Kt),p("span",null,o(n.name)+" (v"+o(n.version)+")",1)]))),128))])):(u(),r("div",qt,"This participant is not attached to any plans."))]),_:1,__:[43]}),a(e(H),null,{default:l(()=>[a(e(v),{color:"secondary",onClick:t[8]||(t[8]=n=>L.value=!1),disabled:A.value},{default:l(()=>t[44]||(t[44]=[s("Cancel",-1)])),_:1,__:[44]},8,["disabled"]),a(e(v),{color:"primary",onClick:yt,disabled:A.value||!_.value.size},{default:l(()=>[A.value?(u(),T(e(j),{key:0,size:"sm",class:"me-2"})):E("",!0),t[45]||(t[45]=s(" Generate Statement ",-1))]),_:1,__:[45]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(u(),r("div",At,"Not found."))]))}};export{oe as default};
