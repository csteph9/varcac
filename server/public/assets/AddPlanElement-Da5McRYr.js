import{s as A,v as b,r as c,c as B,a as o,w as t,u as a,e as s,C as M,l as z,b as i,p,x as I,t as _,k as g,d as $,g as U,i as D,j as C,h as L}from"./index-BjdMD8Sf.js";import{C as x}from"./CAlert-Bfb6qE6p.js";import{C as f}from"./CButton-BsLMoijN.js";import{C as O}from"./CCardHeader-Dp3QTvUe.js";import{C as P}from"./CForm-CiFz2s5p.js";import{C as T}from"./CFormInput-mKvw6nm5.js";import{C as W}from"./CFormSelect-DSmG05zI.js";import{C as V}from"./CFormTextarea-C9r7BjPZ.js";import{C as j,a as v}from"./CRow-AWveBr_1.js";const J={class:"p-3"},Z={class:"d-flex justify-content-between align-items-center"},q={class:"d-flex gap-2"},H={class:"mt-2"},K={class:"d-flex gap-2 mt-4"},se={__name:"AddPlanElement",setup(G){const k=D(),l=A({name:"",scope:"payout",formula:"",notes:""}),y=b(()=>/^[A-Za-z_][A-Za-z0-9_]*$/.test(l.name||"")),w=b(()=>!!l.name&&y.value),m=c(!1),u=c(""),d=c(""),E=/\b(globalThis|global|process|require|module|exports|Function|eval|constructor|__proto__|child_process|fs|import)\b/,R=()=>{m.value=!0,u.value="",d.value="";const n=String(l.formula||"").trim();if(!n){d.value="ok",u.value="Empty formula is allowed.",m.value=!1;return}if(E.test(n)){d.value="err",u.value="Blocked: forbidden token.",m.value=!1;return}try{const e=/\breturn\b/.test(n),r=/\b(?:const|let|var)\b/.test(n)||/;|\n/.test(n),N=e?n:r?(()=>{throw new Error("Multi-line formulas must include an explicit `return ...`")})():`return (${n});`;new Function("sum","avg","min","max","count","clamp","period","participantId","planId",`"use strict"; ${N}`),d.value="ok",u.value="Looks good. Syntax check passed."}catch(e){d.value="err",u.value=`Syntax error: ${(e==null?void 0:e.message)||e}`}finally{m.value=!1}},S=async()=>{const n={name:l.name,scope:l.scope,formula:l.formula||null,notes:l.notes||null};await L.post("/api/element-definitions",n,{withCredentials:!0}),alert("Element definition saved!"),k.push({name:"ElementsList"})},F=()=>{l.name="",l.scope="payout",l.formula="",l.notes="",u.value="",d.value=""};return(n,e)=>(C(),B("div",J,[o(a(U),null,{default:t(()=>[o(a(O),{class:"fw-semibold"},{default:t(()=>e[5]||(e[5]=[s("Add Plan Element",-1)])),_:1,__:[5]}),o(a(M),null,{default:t(()=>[o(a(P),{onSubmit:z(S,["prevent"])},{default:t(()=>[o(a(j),{class:"g-3"},{default:t(()=>[o(a(v),{md:"6"},{default:t(()=>[o(a(p),null,{default:t(()=>e[6]||(e[6]=[s("Element Name",-1)])),_:1,__:[6]}),o(a(T),{modelValue:l.name,"onUpdate:modelValue":e[0]||(e[0]=r=>l.name=r),placeholder:"NEW_ARR"},null,8,["modelValue"]),i("small",{class:I(y.value?"text-body-secondary":"text-danger")}," Must be a valid JS identifier. ",2)]),_:1}),o(a(v),{md:"6"},{default:t(()=>[o(a(p),null,{default:t(()=>e[7]||(e[7]=[s("Scope",-1)])),_:1,__:[7]}),o(a(W),{modelValue:l.scope,"onUpdate:modelValue":e[1]||(e[1]=r=>l.scope=r),options:[{label:"Per payout period",value:"payout"},{label:"Entire plan window",value:"plan"}]},null,8,["modelValue"]),e[8]||(e[8]=i("small",{class:"text-body-secondary"}," Controls the time range the formula operates on. ",-1))]),_:1,__:[8]}),o(a(v),{md:"12"},{default:t(()=>[i("div",Z,[o(a(p),{class:"mb-0"},{default:t(()=>e[9]||(e[9]=[s("Formula (JavaScript)",-1)])),_:1,__:[9]}),i("div",q,[o(a(f),{color:"secondary",variant:"outline",size:"sm",onClick:e[2]||(e[2]=r=>l.formula=(l.formula?l.formula+"\\n":"")+"0.05 * sum(NEW_ARR.value)")},{default:t(()=>e[10]||(e[10]=[s(" Insert example ",-1)])),_:1,__:[10]}),o(a(f),{color:"secondary",size:"sm",disabled:m.value,onClick:R},{default:t(()=>[s(_(m.value?"Validating…":"Validate syntax"),1)]),_:1},8,["disabled"])])]),o(a(V),{modelValue:l.formula,"onUpdate:modelValue":e[3]||(e[3]=r=>l.formula=r),rows:"6",placeholder:"e.g. 0.05 * sum(NEW_ARR.value)",style:{"font-family":"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace"}},null,8,["modelValue"]),i("div",H,[d.value==="ok"?(C(),g(a(x),{key:0,color:"success",class:"py-2"},{default:t(()=>[s(_(u.value),1)]),_:1})):d.value==="err"?(C(),g(a(x),{key:1,color:"danger",class:"py-2"},{default:t(()=>[s(_(u.value),1)]),_:1})):$("",!0)])]),_:1}),o(a(v),{md:"12"},{default:t(()=>[o(a(p),null,{default:t(()=>e[11]||(e[11]=[s("Notes",-1)])),_:1,__:[11]}),o(a(V),{modelValue:l.notes,"onUpdate:modelValue":e[4]||(e[4]=r=>l.notes=r),rows:"3",placeholder:"Optional notes…"},null,8,["modelValue"])]),_:1})]),_:1}),i("div",K,[o(a(f),{type:"submit",color:"primary",disabled:!w.value},{default:t(()=>e[12]||(e[12]=[s("Save",-1)])),_:1,__:[12]},8,["disabled"]),o(a(f),{type:"button",color:"secondary",onClick:F},{default:t(()=>e[13]||(e[13]=[s("Reset",-1)])),_:1,__:[13]})])]),_:1})]),_:1})]),_:1})]))}};export{se as default};
