import{r as f,o as Dt,m as At,v as R,c as r,a as l,u as e,w as a,b as m,e as o,t as i,R as dt,q as Lt,C as X,g as Z,k as I,F as P,f as $,d as E,l as Nt,p as rt,h as w,i as Tt,j as u}from"./index-BjdMD8Sf.js";import{C as Vt}from"./CBadge-CncueH7n.js";import{C as p}from"./CButton-BsLMoijN.js";import{C as h}from"./CCardHeader-Dp3QTvUe.js";import{C as It}from"./CForm-CiFz2s5p.js";import{C as Et}from"./CFormInput-mKvw6nm5.js";import{C as mt}from"./CFormSelect-DSmG05zI.js";import{C as Ft,a as tt}from"./CRow-AWveBr_1.js";import{C as O,a as U,b as H,c as j,d as J}from"./CModalTitle-Dtc4DiEZ.js";import{C as W}from"./CSpinner-CxWKgCdj.js";import{a as ft,b as q,c as C,d as pt,C as vt,e as b}from"./CTable-CqembosS.js";const zt={class:"p-3"},Mt={key:0,class:"py-3"},Bt={key:1},Rt={key:2},Ot={class:"text-muted small"},Ut={class:"d-flex gap-2"},Ht={key:1,class:"text-muted"},jt={key:0},Jt={key:1},Wt={key:0,class:"text-muted"},qt={class:"d-flex align-items-center mb-2"},Gt={class:"me-2"},Yt={key:0,class:"text-muted"},Kt={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},Qt={class:"text-muted"},Xt={class:"mb-3"},Zt=["value"],ht={key:0,class:"text-danger mt-2"},te={style:{"white-space":"pre-wrap","word-break":"break-word",margin:"0"}},ee={key:0,class:"text-muted"},le={key:1,class:"d-flex flex-column gap-2"},ae=["value","disabled"],ye={__name:"ParticipantDetail",setup(ne){const c=Lt(),_t=Tt(),G=f(!0),v=f({participant:null,plans:[]}),Y=f(""),x=f(!1),et=f([]),S=f(""),k=f({loading:!0,plans:[]}),F=async()=>{var s;G.value=!0;try{const{data:t}=await w.get(`/api/participants/${c.params.id}`,{withCredentials:!0}),n=Array.isArray(t.plans)?t.plans:[];for(const d of n)d.planId=d.planId??d.plan_id??((s=d.plan)==null?void 0:s.id)??d.cpId??d.cid??null;v.value={participant:t.participant??null,plans:n}}finally{G.value=!1}},yt=async()=>{const{data:s}=await w.get("/api/plans",{withCredentials:!0});et.value=s||[]},z=async()=>{k.value.loading=!0;try{const{data:s}=await w.get(`/api/participants/${c.params.id}/payout-history`,{withCredentials:!0});k.value.plans=(s==null?void 0:s.plans)||[]}finally{k.value.loading=!1}};Dt(async()=>{await Promise.all([F(),yt(),z()])}),At(()=>c.params.id,async()=>{await Promise.all([F(),z()])});const Ct=()=>{S.value="",x.value=!0},lt=async()=>{S.value&&(await w.post(`/api/participants/${c.params.id}/plans`,{planId:Number(S.value)},{withCredentials:!0}),x.value=!1,await Promise.all([F(),z()]))},bt=async s=>{console.log(s),confirm("Detach this plan from the participant? All historical calculations will be removed.")&&(await w.delete(`/api/participants/${c.params.id}/plans/${s}`,{withCredentials:!0}),await Promise.all([F(),z()]))},D=f(!1),A=f(!1),M=f(""),ct=()=>{D.value=!0},gt=async()=>{var s,t;A.value=!0,M.value="";try{await w.delete(`/api/participants/${c.params.id}`,{withCredentials:!0}),_t.push({name:"ParticipantsList"})}catch(n){M.value=((t=(s=n==null?void 0:n.response)==null?void 0:s.data)==null?void 0:t.error)||"Delete failed"}finally{A.value=!1,D.value=A.value}},at=s=>(Number.isFinite(Number(s))?Number(s):0).toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}),wt=s=>s?new Date(s).toLocaleString():"â€”",B=f(!1),nt=f(""),st=f("");function St(s){if(s==null||s==="")return"(no payload)";try{if(typeof s=="string"){const t=s.trim();return t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")?JSON.stringify(JSON.parse(s),null,2):s}return JSON.stringify(s,null,2)}catch{return String(s)}}function kt(s,t,n){nt.value=`${s.planName} Â· ${t.periodStart} â†’ ${t.periodEnd} Â· ${n.outputLabel}`,st.value=St(n.payload),B.value=!0}const L=f(!1),N=f(new Set),g=f(!1),T=R(()=>{var s;return Array.isArray((s=v.value)==null?void 0:s.plans)?v.value.plans:[]}),K=R(()=>{const s=Y.value.trim().toLowerCase();return s?T.value.filter(t=>`${(t==null?void 0:t.name)??""} v${(t==null?void 0:t.version)??""}`.toLowerCase().includes(s)):T.value}),Pt=R(()=>Math.min(K.value.length||1,8)),ot=R({get(){return Array.from(N.value)},set(s){N.value=new Set(Array.isArray(s)?s.filter(t=>t!=null):[])}});async function $t(){var t,n,d,y;if(!N.value.size){alert("Select at least one plan.");return}const s=Array.from(N.value);g.value=!0;try{const{data:_}=await w.post(`/api/participants/${c.params.id}/comp-statement`,{planIds:s},{withCredentials:!0,responseType:"blob"}),it=new Blob([_],{type:"application/html"}),ut=URL.createObjectURL(it),V=document.createElement("a"),Q=new Date,xt=`${Q.getFullYear()}-${String(Q.getMonth()+1).padStart(2,"0")}-${String(Q.getDate()).padStart(2,"0")}`;V.href=ut,V.download=`CompStatement_${((n=(t=v.value)==null?void 0:t.participant)==null?void 0:n.lastName)??"Participant"}_${xt}.html`,document.body.appendChild(V),V.click(),V.remove(),URL.revokeObjectURL(ut),L.value=!1}catch(_){console.error(_),alert(((y=(d=_==null?void 0:_.response)==null?void 0:d.data)==null?void 0:y.error)||(_==null?void 0:_.message)||"Failed to generate statement")}finally{g.value=!1}}return(s,t)=>(u(),r("div",zt,[G.value?(u(),r("div",Mt,[l(e(W))])):v.value.participant?(u(),r("div",Rt,[l(e(Z),{class:"mb-3"},{default:a(()=>[l(e(h),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:a(()=>[m("span",null,[o(" Participant: "+i(v.value.participant.firstName)+" "+i(v.value.participant.lastName)+" ",1),m("span",Ot,"(#"+i(v.value.participant.id)+")",1)]),m("div",Ut,[l(e(dt),{class:"btn btn-primary",to:{name:"ParticipantEdit",params:{id:e(c).params.id}}},{default:a(()=>t[12]||(t[12]=[o("Edit",-1)])),_:1,__:[12]},8,["to"]),l(e(p),{color:"danger",variant:"outline",onClick:ct},{default:a(()=>t[13]||(t[13]=[o("Delete",-1)])),_:1,__:[13]}),l(e(p),{color:"primary",size:"sm",onClick:Ct},{default:a(()=>t[14]||(t[14]=[o("Attach Plan",-1)])),_:1,__:[14]}),l(e(p),{color:"warning",size:"sm",onClick:t[0]||(t[0]=n=>L.value=!0)},{default:a(()=>t[15]||(t[15]=[o("Comp Statement",-1)])),_:1,__:[15]})])]),_:1}),l(e(X),null,{default:a(()=>[l(e(Ft),null,{default:a(()=>[l(e(tt),{md:"4"},{default:a(()=>[t[16]||(t[16]=m("strong",null,"Email:",-1)),o(" "+i(v.value.participant.email),1)]),_:1,__:[16]}),l(e(tt),{md:"4"},{default:a(()=>[t[17]||(t[17]=m("strong",null,"ID:",-1)),o(" "+i(v.value.participant.id),1)]),_:1,__:[17]}),l(e(tt),{md:"4"},{default:a(()=>[t[18]||(t[18]=m("strong",null,"Created:",-1)),o(" "+i(new Date(v.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[18]})]),_:1})]),_:1})]),_:1}),l(e(Z),null,{default:a(()=>[l(e(h),{class:"fw-semibold"},{default:a(()=>t[19]||(t[19]=[o("Attached Plans",-1)])),_:1,__:[19]}),l(e(X),null,{default:a(()=>[T.value.length?(u(),I(e(vt),{key:0,hover:"",responsive:""},{default:a(()=>[l(e(ft),null,{default:a(()=>[l(e(q),null,{default:a(()=>[l(e(C),null,{default:a(()=>t[20]||(t[20]=[o("Name",-1)])),_:1,__:[20]}),l(e(C),null,{default:a(()=>t[21]||(t[21]=[o("Version",-1)])),_:1,__:[21]}),l(e(C),null,{default:a(()=>t[22]||(t[22]=[o("Plan Effective",-1)])),_:1,__:[22]}),l(e(C),null,{default:a(()=>t[23]||(t[23]=[o("Attached",-1)])),_:1,__:[23]}),l(e(C),null,{default:a(()=>t[24]||(t[24]=[o("Actions",-1)])),_:1,__:[24]})]),_:1})]),_:1}),l(e(pt),null,{default:a(()=>[(u(!0),r(P,null,$(T.value,n=>(u(),I(e(q),{key:n.id},{default:a(()=>[l(e(b),null,{default:a(()=>[o(i(n.name),1)]),_:2},1024),l(e(b),null,{default:a(()=>[o("v"+i(n.version),1)]),_:2},1024),l(e(b),null,{default:a(()=>[o(i(n.planEffectiveStart||"â€”")+" â†’ "+i(n.planEffectiveEnd||"â€”"),1)]),_:2},1024),l(e(b),null,{default:a(()=>[o(i(new Date(n.attachedAt).toLocaleString()),1)]),_:2},1024),l(e(b),null,{default:a(()=>[l(e(p),{color:"secondary",size:"sm",onClick:d=>bt(n.planId)},{default:a(()=>t[25]||(t[25]=[o("Detach",-1)])),_:2,__:[25]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(u(),r("div",Ht,"No plans attached yet."))]),_:1})]),_:1}),l(e(Z),{class:"mt-3"},{default:a(()=>[l(e(h),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:a(()=>[t[27]||(t[27]=m("span",null,"Payout History (by Plan & Period)",-1)),l(e(dt),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:a(()=>t[26]||(t[26]=[o("View Plans",-1)])),_:1,__:[26]})]),_:1,__:[27]}),l(e(X),null,{default:a(()=>[k.value.loading?(u(),r("div",jt,[l(e(W))])):(u(),r("div",Jt,[k.value.plans.length?E("",!0):(u(),r("div",Wt,"No payout history yet.")),(u(!0),r(P,null,$(k.value.plans,n=>(u(),r("div",{key:n.planId,class:"mb-4"},[m("div",qt,[m("strong",Gt,i(n.planName),1),l(e(Vt),{color:"secondary",class:"me-2"},{default:a(()=>[o("v"+i(n.planVersion),1)]),_:2},1024)]),l(e(vt),{hover:"",responsive:"",small:""},{default:a(()=>[l(e(ft),null,{default:a(()=>[l(e(q),null,{default:a(()=>[l(e(C),{style:{"min-width":"120px"}},{default:a(()=>t[28]||(t[28]=[o("Period",-1)])),_:1,__:[28]}),l(e(C),{style:{"min-width":"120px"}},{default:a(()=>t[29]||(t[29]=[o("Period End Date",-1)])),_:1,__:[29]}),l(e(C),{style:{"min-width":"160px","text-align":"center"}},{default:a(()=>t[30]||(t[30]=[o("Total Payout",-1)])),_:1,__:[30]}),l(e(C),null,{default:a(()=>t[31]||(t[31]=[o("Computations",-1)])),_:1,__:[31]})]),_:1})]),_:1}),l(e(pt),null,{default:a(()=>[(u(!0),r(P,null,$(n.periods,d=>(u(),I(e(q),{key:d.periodStart+"|"+d.periodEnd+"|"+(d.periodLabel||"")},{default:a(()=>[l(e(b),null,{default:a(()=>[m("div",null,[o(i(new Date(d.periodStart).toISOString().split("T")[0])+" â­¾ ",1),t[32]||(t[32]=m("br",null,null,-1)),o(i(new Date(d.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),l(e(b),null,{default:a(()=>[o(i(new Date(d.dueDate).toISOString().split("T")[0]),1),t[33]||(t[33]=m("br",null,null,-1)),d.periodLabel?(u(),r("small",Yt,i(d.periodLabel),1)):E("",!0)]),_:2,__:[33]},1024),l(e(b),{style:{"text-align":"center"}},{default:a(()=>[m("strong",null,i(at(d.total)),1)]),_:2},1024),l(e(b),null,{default:a(()=>[m("ul",Kt,[(u(!0),r(P,null,$(d.lines,(y,_)=>(u(),r("li",{key:y.id||_},[l(e(p),{size:"sm",color:"success",class:"ms-2",variant:"outline",shape:"rounded-3",disabled:!y.payload||y.payload==="",onClick:it=>kt(n,d,y),title:"View payload"},{default:a(()=>[m("strong",null,i(y.outputLabel),1)]),_:2},1032,["disabled","onClick"]),o(" â†’ "+i(at(y.amount))+" ",1),m("span",Qt,"Â â€¢ ("+i(wt(y.createdAt))+")",1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),l(e(J),{visible:x.value,onClose:t[3]||(t[3]=n=>x.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(O),null,{default:a(()=>[l(e(U),null,{default:a(()=>t[34]||(t[34]=[o("Attach Plan",-1)])),_:1,__:[34]})]),_:1}),l(e(H),null,{default:a(()=>[l(e(It),{onSubmit:Nt(lt,["prevent"])},{default:a(()=>[m("div",Xt,[l(e(rt),null,{default:a(()=>t[35]||(t[35]=[o("Select a plan",-1)])),_:1,__:[35]}),l(e(mt),{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=n=>S.value=n)},{default:a(()=>[t[36]||(t[36]=m("option",{value:""},"Select a planâ€¦",-1)),(u(!0),r(P,null,$(et.value,n=>(u(),r("option",{key:n.id,value:n.id},i(n.name)+" (v"+i(n.version)+")",9,Zt))),128))]),_:1,__:[36]},8,["modelValue"])])]),_:1})]),_:1}),l(e(j),null,{default:a(()=>[l(e(p),{color:"secondary",onClick:t[2]||(t[2]=n=>x.value=!1)},{default:a(()=>t[37]||(t[37]=[o("Cancel",-1)])),_:1,__:[37]}),l(e(p),{color:"primary",disabled:!S.value,onClick:lt},{default:a(()=>t[38]||(t[38]=[o("Attach",-1)])),_:1,__:[38]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(J),{visible:D.value,onClose:t[5]||(t[5]=n=>D.value=!1)},{default:a(()=>[l(e(O),null,{default:a(()=>[l(e(U),null,{default:a(()=>t[39]||(t[39]=[o("Delete participant?",-1)])),_:1,__:[39]})]),_:1}),l(e(H),null,{default:a(()=>[t[40]||(t[40]=o(" This cannot be undone. Continue? ",-1)),M.value?(u(),r("div",ht,i(M.value),1)):E("",!0)]),_:1,__:[40]}),l(e(j),null,{default:a(()=>[l(e(p),{color:"secondary",onClick:t[4]||(t[4]=n=>D.value=!1)},{default:a(()=>t[41]||(t[41]=[o("Cancel",-1)])),_:1,__:[41]}),l(e(p),{color:"danger",disabled:A.value,onClick:gt},{default:a(()=>[A.value?(u(),I(e(W),{key:0,size:"sm",class:"me-2"})):E("",!0),t[42]||(t[42]=o(" Delete ",-1))]),_:1,__:[42]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(J),{visible:B.value,onClose:t[7]||(t[7]=n=>B.value=!1),size:"lg",alignment:"center",scrollable:""},{default:a(()=>[l(e(O),null,{default:a(()=>[l(e(U),null,{default:a(()=>[o(i(nt.value||"Payload"),1)]),_:1})]),_:1}),l(e(H),null,{default:a(()=>[m("pre",te,i(st.value),1)]),_:1}),l(e(j),null,{default:a(()=>[l(e(p),{color:"secondary",onClick:t[6]||(t[6]=n=>B.value=!1)},{default:a(()=>t[43]||(t[43]=[o("Close",-1)])),_:1,__:[43]})]),_:1})]),_:1},8,["visible"]),l(e(J),{visible:L.value,onClose:t[11]||(t[11]=n=>L.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(O),null,{default:a(()=>[l(e(U),null,{default:a(()=>t[44]||(t[44]=[o("Generate Comp Statement",-1)])),_:1,__:[44]})]),_:1}),l(e(H),null,{default:a(()=>[t[47]||(t[47]=m("div",{class:"mb-2 text-muted"},"Select plan(s) to include:",-1)),T.value.length?(u(),r("div",le,[l(e(Et),{modelValue:Y.value,"onUpdate:modelValue":t[8]||(t[8]=n=>Y.value=n),placeholder:"Filter plansâ€¦",class:"mb-2",disabled:g.value},null,8,["modelValue","disabled"]),l(e(rt),{for:"planSelect",class:"mb-1"},{default:a(()=>t[45]||(t[45]=[o("Plans",-1)])),_:1,__:[45]}),l(e(mt),{id:"planSelect",multiple:"",size:Pt.value,modelValue:ot.value,"onUpdate:modelValue":t[9]||(t[9]=n=>ot.value=n),disabled:g.value||!K.value.length,style:{"max-height":"260px",overflow:"auto"}},{default:a(()=>[(u(!0),r(P,null,$(K.value,n=>(u(),r("option",{key:n.id??n.planId,value:n.planId,disabled:!(n!=null&&n.planId)},i((n==null?void 0:n.name)??"Unnamed")+" (v"+i((n==null?void 0:n.version)??"?")+") ",9,ae))),128))]),_:1},8,["size","modelValue","disabled"]),t[46]||(t[46]=m("small",{class:"text-muted"},"Tip: hold Ctrl/Cmd (or Shift) to select multiple.",-1))])):(u(),r("div",ee," This participant is not attached to any plans. "))]),_:1,__:[47]}),l(e(j),null,{default:a(()=>[l(e(p),{color:"secondary",onClick:t[10]||(t[10]=n=>L.value=!1),disabled:g.value},{default:a(()=>t[48]||(t[48]=[o("Cancel",-1)])),_:1,__:[48]},8,["disabled"]),l(e(p),{color:"primary",onClick:$t,disabled:g.value||!N.value.size},{default:a(()=>[g.value?(u(),I(e(W),{key:0,size:"sm",class:"me-2"})):E("",!0),t[49]||(t[49]=o(" Generate Statement ",-1))]),_:1,__:[49]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(u(),r("div",Bt,"Not found."))]))}};export{ye as default};
