import{r as p,o as _t,m as vt,c as u,a as l,u as e,w as a,b as m,t as d,n as Ct,e as o,C as L,d as yt,g as I,k as D,F as b,f as T,l as J,p as K,h as _,q as ct,j as i}from"./index-DyVjuEV4.js";import{C as c}from"./CButton-Ob9G74z0.js";import{C as H}from"./CCardHeader-DbalRFEA.js";import{C as Q}from"./CForm-aOGSAZeI.js";import{C as X}from"./CFormSelect-Dk32yjlG.js";import{C as wt,a as U}from"./CRow-Bilq_s-I.js";import{C as Y,a as Z,b as h,c as tt,d as et}from"./CModalTitle-CM1iI8l4.js";import{C as at}from"./CSpinner-Dn5wfHZO.js";import{a as lt,b as M,c as C,d as nt,C as st,e as y}from"./CTable-Dyd9aalW.js";const bt={class:"p-3"},gt={key:0,class:"py-3"},kt={key:1},$t={key:2},Pt={class:"d-flex gap-2"},At={key:0},xt={key:1},Nt={key:0,class:"text-muted"},St={class:"badge text-bg-secondary"},Et={key:0},Dt={key:1},Tt={key:1,class:"text-muted"},Mt={class:"mb-3"},Vt={key:0},Ft={key:0,class:"text-muted"},Rt={class:"mb-3"},Bt=["value"],Lt={class:"mb-3"},It=["value"],Qt={__name:"PlanDetail",setup(Ht){const v=ct(),V=p(!0),f=p({plan:null,elements:[]}),N=p(!1),z=p([]),$=p(""),F=async()=>{V.value=!0;try{const{data:s}=await _.get(`/api/plans/${v.params.id}`,{withCredentials:!0});f.value={plan:s.plan??null,elements:Array.isArray(s.elements)?s.elements:s.elements||[]}}finally{V.value=!1}},ot=async()=>{const{data:s}=await _.get("/api/element-definitions",{withCredentials:!0});z.value=Array.isArray(s)?s:s.elements||[]},j=async()=>{$.value&&(await _.post(`/api/plans/${v.params.id}/elements`,{elementId:Number($.value)},{withCredentials:!0}),N.value=!1,await F())},P=p(!1),q=p([]),g=p(""),R=p([]),it=async()=>{const{data:s}=await _.get("/api/computations",{withCredentials:!0});q.value=Array.isArray(s)?s:s.computations||[]},S=async()=>{const{data:s}=await _.get(`/api/plans/${v.params.id}/computations`,{withCredentials:!0});R.value=Array.isArray(s)?s:s.computations||[]},ut=()=>{g.value="",P.value=!0},W=async()=>{g.value&&(await _.post(`/api/plans/${v.params.id}/computations`,{computationId:Number(g.value)},{withCredentials:!0}),P.value=!1,await S())},dt=async s=>{confirm("Remove this computation from the plan?")&&(await _.delete(`/api/plans/${v.params.id}/computations/${s}`,{withCredentials:!0}),await S())};p(!1);const rt=p({run:null,results:[]}),O=async()=>{const{data:s}=await _.get(`/api/plans/${v.params.id}/calculations`,{withCredentials:!0});rt.value=s},k=p({loading:!0,participants:[]}),B=async()=>{k.value.loading=!0;try{const{data:s}=await _.get(`/api/plans/${v.params.id}/payout-run-summary`,{withCredentials:!0});k.value.participants=(s==null?void 0:s.participants)||[]}finally{k.value.loading=!1}},E=p(!1),mt=async()=>{var s,t,A,n,w,x;if(confirm("This will purge and regenerate payouts for this plan from attached computations. Continue?")){E.value=!0;try{const{data:r}=await _.post(`/api/plans/${v.params.id}/run-computations`,{},{withCredentials:!0});alert(`Computations complete: inserted ${r.inserted} rows${(s=r.errors)!=null&&s.length?`; ${r.errors.length} errors`:""}. ${(t=r.errors)!=null&&t.length?`; ${r.errors[0].error}`:""}`),await B()}catch(r){console.error(r),alert(((n=(A=r==null?void 0:r.response)==null?void 0:A.data)==null?void 0:n.detail)||((x=(w=r==null?void 0:r.response)==null?void 0:w.data)==null?void 0:x.error)||"Run computations failed")}finally{E.value=!1}}};_t(async()=>{await Promise.all([F(),ot(),it(),S(),O(),B()])}),vt(()=>v.params.id,async()=>{await Promise.all([F(),S(),O(),B()])});const pt=s=>(Number.isFinite(Number(s))?Number(s):0).toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}),ft=s=>s?new Date(s).toLocaleString():"—";return(s,t)=>{const A=Ct("router-link");return i(),u("div",bt,[V.value?(i(),u("div",gt,[l(e(at))])):f.value.plan?(i(),u("div",$t,[l(e(I),{class:"mb-3"},{default:a(()=>[l(e(H),{class:"fw-semibold d-flex align-items-center justify-content-between gap-2 flex-wrap"},{default:a(()=>{var n,w,x,r,G;return[m("div",null," Plan: "+d(((w=(n=f.value.plan)==null?void 0:n.name)==null?void 0:w.trim())||"#"+(((x=f.value.plan)==null?void 0:x.id)??"—"))+" (v"+d(((G=(r=f.value.plan)==null?void 0:r.version)==null?void 0:G.trim())||"—")+") ",1),m("div",Pt,[l(A,{class:"btn btn-sm btn-outline-primary",to:{name:"PlanEdit",params:{id:f.value.plan.id}}},{default:a(()=>t[6]||(t[6]=[o("Edit",-1)])),_:1,__:[6]},8,["to"]),l(e(c),{color:"secondary",size:"sm",onClick:ut},{default:a(()=>t[7]||(t[7]=[o("Add Computation",-1)])),_:1,__:[7]}),l(e(c),{color:"info",size:"sm",disabled:E.value,onClick:mt},{default:a(()=>[E.value?(i(),u("span",At,"Running…")):(i(),u("span",xt,"Run Computations"))]),_:1},8,["disabled"])])]}),_:1}),l(e(L),null,{default:a(()=>[l(e(wt),{class:"mb-2"},{default:a(()=>[l(e(U),{md:"3"},{default:a(()=>[t[8]||(t[8]=m("strong",null,"Payout:",-1)),o(" "+d(f.value.plan.payoutFrequency||"—"),1)]),_:1,__:[8]}),l(e(U),{md:"3"},{default:a(()=>[t[9]||(t[9]=m("strong",null,"Effective Start:",-1)),o(" "+d(f.value.plan.effectiveStart||"—"),1)]),_:1,__:[9]}),l(e(U),{md:"3"},{default:a(()=>[t[10]||(t[10]=m("strong",null,"Effective End:",-1)),o(" "+d(f.value.plan.effectiveEnd||"—"),1)]),_:1,__:[10]})]),_:1}),f.value.plan.description?(i(),u("div",Nt,d(f.value.plan.description),1)):yt("",!0)]),_:1})]),_:1}),l(e(I),{class:"mt-3"},{default:a(()=>[l(e(H),{class:"fw-semibold"},{default:a(()=>t[11]||(t[11]=[o("Computations",-1)])),_:1,__:[11]}),l(e(L),null,{default:a(()=>[R.value.length?(i(),D(e(st),{key:0,hover:"",responsive:""},{default:a(()=>[l(e(lt),null,{default:a(()=>[l(e(M),null,{default:a(()=>[l(e(C),null,{default:a(()=>t[12]||(t[12]=[o("Name",-1)])),_:1,__:[12]}),l(e(C),null,{default:a(()=>t[13]||(t[13]=[o("Scope",-1)])),_:1,__:[13]}),l(e(C),null,{default:a(()=>t[14]||(t[14]=[o("Template",-1)])),_:1,__:[14]}),l(e(C),null,{default:a(()=>t[15]||(t[15]=[o("Actions",-1)])),_:1,__:[15]})]),_:1})]),_:1}),l(e(nt),null,{default:a(()=>[(i(!0),u(b,null,T(R.value,n=>(i(),D(e(M),{key:n.id},{default:a(()=>[l(e(y),{class:"fw-semibold"},{default:a(()=>[l(e(c),{color:"warning"},{default:a(()=>[l(A,{to:{name:"ComputationEdit",params:{id:n.id}},class:"text-decoration-none",title:`Edit ${n.name}`},{default:a(()=>[o(d(n.name),1)]),_:2},1032,["to","title"])]),_:2},1024)]),_:2},1024),l(e(y),null,{default:a(()=>[m("span",St,d(n.scope==="plan"?"Entire Plan Window":"Per Payout Period"),1)]),_:2},1024),l(e(y),{class:"text-truncate",style:{"max-width":"420px"}},{default:a(()=>[n.template?(i(),u("code",Et,d(n.template),1)):(i(),u("span",Dt,"—"))]),_:2},1024),l(e(y),null,{default:a(()=>[l(e(c),{size:"sm",color:"danger",onClick:w=>dt(n.id)},{default:a(()=>t[16]||(t[16]=[o("Remove",-1)])),_:2,__:[16]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(i(),u("div",Tt,"No computations attached yet."))]),_:1})]),_:1}),l(e(I),{class:"mt-3"},{default:a(()=>[l(e(H),{class:"fw-semibold"},{default:a(()=>t[17]||(t[17]=[o("Calculations (Latest Run)",-1)])),_:1,__:[17]}),l(e(L),null,{default:a(()=>[m("div",Mt,[t[23]||(t[23]=m("h6",{class:"mb-2"},"Participants with payouts (latest computations run)",-1)),k.value.loading?(i(),u("div",Vt,[l(e(at))])):(i(),u(b,{key:1},[k.value.participants.length?(i(),D(e(st),{key:1,hover:"",responsive:"",small:""},{default:a(()=>[l(e(lt),null,{default:a(()=>[l(e(M),null,{default:a(()=>[l(e(C),null,{default:a(()=>t[18]||(t[18]=[o("Participant",-1)])),_:1,__:[18]}),l(e(C),null,{default:a(()=>t[19]||(t[19]=[o("Total Amount",-1)])),_:1,__:[19]}),l(e(C),null,{default:a(()=>t[20]||(t[20]=[o("Lines",-1)])),_:1,__:[20]}),l(e(C),null,{default:a(()=>t[21]||(t[21]=[o("Period Window",-1)])),_:1,__:[21]}),l(e(C),null,{default:a(()=>t[22]||(t[22]=[o("Last Updated",-1)])),_:1,__:[22]})]),_:1})]),_:1}),l(e(nt),null,{default:a(()=>[(i(!0),u(b,null,T(k.value.participants,n=>(i(),D(e(M),{key:n.participantId,onClick:w=>s.$router.push({name:"ParticipantDetail",params:{id:n.participantId}}),style:{cursor:"pointer"}},{default:a(()=>[l(e(y),null,{default:a(()=>[n.firstName||n.lastName?(i(),u(b,{key:0},[o(d(n.firstName)+" "+d(n.lastName),1)],64)):(i(),u(b,{key:1},[o("#"+d(n.participantId),1)],64))]),_:2},1024),l(e(y),null,{default:a(()=>[m("strong",null,d(pt(n.totalAmount)),1)]),_:2},1024),l(e(y),null,{default:a(()=>[o(d(n.lines??n.lineCount),1)]),_:2},1024),l(e(y),null,{default:a(()=>[o(d(n.firstPeriodStart)+" → "+d(n.lastPeriodEnd),1)]),_:2},1024),l(e(y),null,{default:a(()=>[o(d(ft(n.lastCreatedAt)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})):(i(),u("div",Ft,"No payouts found for the latest run."))],64))])]),_:1})]),_:1}),l(e(et),{visible:N.value,onClose:t[2]||(t[2]=n=>N.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(Y),null,{default:a(()=>[l(e(Z),null,{default:a(()=>t[24]||(t[24]=[o("Add Existing Element",-1)])),_:1,__:[24]})]),_:1}),l(e(h),null,{default:a(()=>[l(e(Q),{onSubmit:J(j,["prevent"])},{default:a(()=>[m("div",Rt,[l(e(K),null,{default:a(()=>t[25]||(t[25]=[o("Choose an existing element definition",-1)])),_:1,__:[25]}),l(e(X),{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=n=>$.value=n)},{default:a(()=>[t[26]||(t[26]=m("option",{value:"",disabled:""},"Select an element…",-1)),(i(!0),u(b,null,T(z.value,n=>(i(),u("option",{key:n.id,value:n.id},d(n.name),9,Bt))),128))]),_:1,__:[26]},8,["modelValue"])]),t[27]||(t[27]=m("div",{class:"text-muted"},[o("Don’t see it? Create it in "),m("strong",null,"Add Plan Element"),o(", then come back.")],-1))]),_:1,__:[27]})]),_:1}),l(e(tt),null,{default:a(()=>[l(e(c),{color:"secondary",onClick:t[1]||(t[1]=n=>N.value=!1)},{default:a(()=>t[28]||(t[28]=[o("Cancel",-1)])),_:1,__:[28]}),l(e(c),{color:"primary",onClick:j,disabled:!$.value},{default:a(()=>t[29]||(t[29]=[o("Attach",-1)])),_:1,__:[29]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(et),{visible:P.value,onClose:t[5]||(t[5]=n=>P.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(Y),null,{default:a(()=>[l(e(Z),null,{default:a(()=>t[30]||(t[30]=[o("Add Computation",-1)])),_:1,__:[30]})]),_:1}),l(e(h),null,{default:a(()=>[l(e(Q),{onSubmit:J(W,["prevent"])},{default:a(()=>[m("div",Lt,[l(e(K),null,{default:a(()=>t[31]||(t[31]=[o("Choose a computation",-1)])),_:1,__:[31]}),l(e(X),{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=n=>g.value=n)},{default:a(()=>[t[32]||(t[32]=m("option",{value:"0"},"Select a computation…",-1)),(i(!0),u(b,null,T(q.value,n=>(i(),u("option",{key:n.id,value:n.id},d(n.name)+" ("+d(n.scope==="plan"?"Plan":"Payout")+") ",9,It))),128))]),_:1,__:[32]},8,["modelValue"])])]),_:1})]),_:1}),l(e(tt),null,{default:a(()=>[l(e(c),{color:"secondary",onClick:t[4]||(t[4]=n=>P.value=!1)},{default:a(()=>t[33]||(t[33]=[o("Cancel",-1)])),_:1,__:[33]}),l(e(c),{color:"primary",onClick:W,disabled:!g.value},{default:a(()=>t[34]||(t[34]=[o("Attach",-1)])),_:1,__:[34]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(i(),u("div",kt,"Not found."))])}}};export{Qt as default};
