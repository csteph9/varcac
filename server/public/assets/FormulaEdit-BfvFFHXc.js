import{r as m,o as F,c as p,d as n,a,b as t,u as l,e as r,C as N,m as S,f as k,s as v,q as B,t as O,h as E,i as y,v as U,j as L,k as f}from"./index-CFGD_Gi7.js";import{C as R}from"./CButton-Bar-IVn5.js";import{C as $}from"./CCardHeader-j1dVyNP9.js";import{C as D}from"./CForm-8Di4je1x.js";import{C as x}from"./CFormInput-vGO62AtJ.js";import{C as V}from"./CFormTextarea-_3z2L8bv.js";import{C as H,a as _}from"./CRow-CQIQrd1B.js";import{C as M}from"./CSpinner-B_QOP7IZ.js";import{_ as T}from"./FormulaGlossary-DRNyVz--.js";const j={class:"p-3"},q={class:"row g-3"},A={class:"col-lg-6"},G={key:0},I={key:1},P={class:"d-flex gap-2 mt-4"},W={key:0,class:"text-danger mt-3"},z={class:"col-lg-6"},te={__name:"FormulaEdit",setup(K){const b=U(),J=L(),c=m(!0),C=m(!1),i=m(null),o=m({name:"",expression:"",description:"",variablesJson:""});F(async()=>{c.value=!0,i.value=null;try{const{data:s}=await y.get(`/api/formulas/${b.params.id}`,{withCredentials:!0});o.value={name:s.name||"",expression:s.expression||"",description:s.description||"",variablesJson:s.variablesJson?typeof s.variablesJson=="string"?s.variablesJson:JSON.stringify(s.variablesJson,null,2):""}}catch(s){i.value="Failed to load formula.",console.error(s)}finally{c.value=!1}});const g=({expression:s,variablesJson:e})=>{o.value.expression=s;try{o.value.variablesJson=JSON.stringify(JSON.parse(e),null,2)}catch{o.value.variablesJson=e}},w=async()=>{var s,e;C.value=!0,i.value=null;try{await y.put(`/api/formulas/${b.params.id}`,{name:o.value.name,expression:o.value.expression,description:o.value.description||null,variablesJson:o.value.variablesJson?JSON.parse(o.value.variablesJson):null},{withCredentials:!0}),J.push({name:"FormulasList"})}catch(d){console.error(d),i.value=((e=(s=d==null?void 0:d.response)==null?void 0:s.data)==null?void 0:e.error)||"Failed to save."}finally{C.value=!1}};return(s,e)=>{const d=B("router-link");return f(),p("div",j,[n("div",q,[n("div",A,[a(l(E),null,{default:t(()=>[a(l($),{class:"fw-semibold"},{default:t(()=>e[4]||(e[4]=[r("Edit Formula",-1)])),_:1,__:[4]}),a(l(N),null,{default:t(()=>[c.value?(f(),p("div",G,[a(l(M))])):(f(),p("div",I,[a(l(D),{onSubmit:S(w,["prevent"])},{default:t(()=>[a(l(H),{class:"g-3"},{default:t(()=>[a(l(_),{md:"12"},{default:t(()=>[a(l(v),null,{default:t(()=>e[5]||(e[5]=[r("Name",-1)])),_:1,__:[5]}),a(l(x),{modelValue:o.value.name,"onUpdate:modelValue":e[0]||(e[0]=u=>o.value.name=u),placeholder:"e.g. Percent With Cap"},null,8,["modelValue"])]),_:1}),a(l(_),{md:"12"},{default:t(()=>[a(l(v),null,{default:t(()=>e[6]||(e[6]=[r("Expression",-1)])),_:1,__:[6]}),a(l(x),{modelValue:o.value.expression,"onUpdate:modelValue":e[1]||(e[1]=u=>o.value.expression=u),placeholder:"e.g. clamp(value * rate / 100, 0, cap)"},null,8,["modelValue"]),e[7]||(e[7]=n("small",{class:"text-muted"},[r(" Vars: "),n("code",null,"value"),r(", "),n("code",null,"rate"),r(", plus any you declare below. Helpers: "),n("code",null,"clamp(x,lo,hi)"),r(", "),n("code",null,"min"),r(", "),n("code",null,"max"),r(", "),n("code",null,"round(x,d)"),r(". ")],-1))]),_:1,__:[7]}),a(l(_),{md:"12"},{default:t(()=>[a(l(v),null,{default:t(()=>e[8]||(e[8]=[r("Variables JSON (optional)",-1)])),_:1,__:[8]}),a(l(V),{rows:"4",modelValue:o.value.variablesJson,"onUpdate:modelValue":e[2]||(e[2]=u=>o.value.variablesJson=u),placeholder:'e.g. ["rate","cap"] or {"cap":20000}'},null,8,["modelValue"])]),_:1}),a(l(_),{md:"12"},{default:t(()=>[a(l(v),null,{default:t(()=>e[9]||(e[9]=[r("Description (optional)",-1)])),_:1,__:[9]}),a(l(V),{rows:"3",modelValue:o.value.description,"onUpdate:modelValue":e[3]||(e[3]=u=>o.value.description=u)},null,8,["modelValue"])]),_:1})]),_:1}),n("div",P,[a(l(R),{type:"submit",color:"primary",disabled:C.value},{default:t(()=>e[10]||(e[10]=[r("Save",-1)])),_:1,__:[10]},8,["disabled"]),a(d,{class:"btn btn-secondary",to:{name:"FormulasList"}},{default:t(()=>e[11]||(e[11]=[r("Cancel",-1)])),_:1,__:[11]})]),i.value?(f(),p("div",W,O(i.value),1)):k("",!0)]),_:1})]))]),_:1})]),_:1})]),n("div",z,[a(T,{onApply:g})])])])}}};export{te as default};
