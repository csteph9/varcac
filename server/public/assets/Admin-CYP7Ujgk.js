import{r as d,v as B,c as G,a as l,w as s,u as t,g as P,e as u,C as $,k as g,d as w,b as o,t as R,l as A,p as E,x as U,h as T,j as b}from"./index-DY2iYVHx.js";import{C as I}from"./CAlert-DmuhYrdh.js";import{C as L}from"./CButton-CBg_h1uZ.js";import{C as H}from"./CCardHeader-CxJUXy8l.js";import{C as D}from"./CForm-DPT3EXTc.js";import{C as K}from"./CFormCheck-_XpsjDfQ.js";import{C as M}from"./CFormInput-cfDnsWz9.js";import{a as F,C as J}from"./CRow-CoYbaDgy.js";import{C as N}from"./CSpinner-FP7r2lwx.js";const Q={class:"p-3"},W={class:"mb-4"},X={class:"mb-3"},Y={class:"mb-2"},Z={class:"mb-3",style:{"max-width":"360px"}},de={__name:"Admin",setup(ee){const C=d(!1),y=d(!1),m=d(""),i=d(""),c=d(!1),p=d(""),h=d(null),f=d(null);function j(n){var e,a;f.value=((a=(e=n==null?void 0:n.target)==null?void 0:e.files)==null?void 0:a[0])??null}function q(n=""){const e=String(n||"");let a=e.match(/filename\*=(?:UTF-8'')?([^;]+)/i);return a&&a[1]?decodeURIComponent(a[1].replace(/(^"|"$)/g,"")).trim():(a=e.match(/filename=([^;]+)/i),a&&a[1]?a[1].replace(/(^"|"$)/g,"").trim():"varcac_db_backup.varcac")}const k=B(()=>c.value&&p.value.trim()==="ERASE"),x=B(()=>!!f.value),z=B(()=>k.value&&x.value&&!y.value),S=async()=>{var n,e;m.value="",i.value="",C.value=!0;try{const a=await T.get("/api/admin/backup",{responseType:"blob",withCredentials:!0,transformResponse:[O=>O]}),_=new Blob([a.data],{type:a.headers["content-type"]||"application/octet-stream"}),r=window.URL.createObjectURL(_),v=document.createElement("a");v.href=r,v.download=q(a.headers["content-disposition"]),document.body.appendChild(v),v.click(),v.remove(),window.URL.revokeObjectURL(r),m.value="Backup generated."}catch(a){console.error(a),i.value=((e=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:e.error)||"Backup failed"}finally{C.value=!1}},V=async()=>{var n,e,a,_;if(m.value="",i.value="",!f.value){i.value="Please choose a backup file.";return}if(!k.value){i.value="Please confirm by checking the box and typing ERASE.";return}y.value=!0;try{const r=new FormData;r.append("dump",f.value),r.append("confirm",p.value),await T.post("/api/admin/restore",r,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"}}),m.value="Restore complete.",p.value="",c.value=!1,f.value=null,h.value&&(h.value.value="")}catch(r){console.error(r),i.value=((e=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:e.detail)||((_=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:_.error)||"Restore failed"}finally{y.value=!1}};return(n,e)=>(b(),G("div",Q,[l(t(J),{class:"g-4"},{default:s(()=>[l(t(F),{md:"12"},{default:s(()=>[l(t(P),null,{default:s(()=>[l(t(H),{class:"fw-semibold"},{default:s(()=>e[2]||(e[2]=[u("Admin · Database Backup & Restore",-1)])),_:1,__:[2]}),l(t($),null,{default:s(()=>[m.value?(b(),g(t(I),{key:0,color:"success",class:"mb-3"},{default:s(()=>[u(R(m.value),1)]),_:1})):w("",!0),i.value?(b(),g(t(I),{key:1,color:"danger",class:"mb-3"},{default:s(()=>[u(R(i.value),1)]),_:1})):w("",!0),o("div",W,[e[6]||(e[6]=o("h6",{class:"mb-3"},"Backup",-1)),l(t(D),{class:"row gy-2 gx-3 align-items-end",onSubmit:A(S,["prevent"])},{default:s(()=>[l(t(F),{md:"4"},{default:s(()=>[l(t(E),null,{default:s(()=>e[3]||(e[3]=[u("Generate database backup",-1)])),_:1,__:[3]}),e[4]||(e[4]=o("p",{class:"text-muted mb-2"},[u(" The file name is set by the server and ends with "),o("code",null,".varcac"),u(". ")],-1))]),_:1,__:[4]}),l(t(F),{md:"3"},{default:s(()=>[l(t(L),{disabled:C.value,color:"primary",class:"mt-3",onClick:S},{default:s(()=>[C.value?(b(),g(t(N),{key:0,size:"sm",class:"me-2"})):w("",!0),e[5]||(e[5]=u(" Generate Backup ",-1))]),_:1,__:[5]},8,["disabled"])]),_:1})]),_:1})]),e[12]||(e[12]=o("hr",{class:"my-4"},null,-1)),o("div",null,[e[10]||(e[10]=o("h6",{class:"mb-3"},"Restore",-1)),e[11]||(e[11]=o("p",{class:"text-danger small mb-3"}," ⚠️ Restoring will overwrite the current database with the contents of your backup file. ",-1)),l(t(D),{onSubmit:A(V,["prevent"])},{default:s(()=>[o("div",X,[l(t(E),null,{default:s(()=>e[7]||(e[7]=[u("Backup file",-1)])),_:1,__:[7]}),o("input",{ref_key:"fileInput",ref:h,class:"form-control",type:"file",accept:".varcac,.sql,application/octet-stream,application/sql,text/sql",onChange:j},null,544),o("div",{class:U(["form-text",{"text-danger":!x.value}])},R(x.value?"File ready.":"Choose the backup file you downloaded earlier."),3)]),o("div",Y,[l(t(K),{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=a=>c.value=a),checked:c.value,label:"I understand this will permanently overwrite the database."},null,8,["modelValue","checked"])]),o("div",Z,[l(t(E),null,{default:s(()=>e[8]||(e[8]=[u("Type ",-1),o("code",null,"ERASE",-1),u(" to enable Restore",-1)])),_:1,__:[8]}),l(t(M),{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=a=>p.value=a),placeholder:"ERASE"},null,8,["modelValue"]),o("div",{class:U(["form-text",{"text-danger":!k.value}])},R(k.value?"Ready.":"Check the box and type ERASE (all caps)."),3)]),l(t(L),{disabled:!z.value,color:"danger",onClick:V},{default:s(()=>[y.value?(b(),g(t(N),{key:0,size:"sm",class:"me-2"})):w("",!0),e[9]||(e[9]=u(" Restore from Backup ",-1))]),_:1,__:[9]},8,["disabled"])]),_:1})])]),_:1,__:[12]})]),_:1})]),_:1})]),_:1})]))}};export{de as default};
