import{r as m,v as Q,o as De,m as $e,c as r,a,u as t,w as s,b as p,e as n,t as d,R as ye,q as Te,C as W,g as X,F as w,f as L,k as B,d as q,p as se,h as g,i as Ne,j as i,x as Ve}from"./index-DY2iYVHx.js";import{C as Me}from"./CBadge-JabYyPYg.js";import{C}from"./CButton-CBg_h1uZ.js";import{C as Z}from"./CCardHeader-CxJUXy8l.js";import{C as Fe}from"./CForm-DPT3EXTc.js";import{C as ze}from"./CFormInput-cfDnsWz9.js";import{C as ne}from"./CFormSelect-CedCeGDc.js";import{C as Re,a as oe}from"./CRow-CoYbaDgy.js";import{C as ie,a as re,b as ue,c as de,d as pe}from"./CModalTitle-B7lcmOHR.js";import{C as N}from"./CSpinner-FP7r2lwx.js";import{a as _e,b as ee,c as S,d as ge,C as Ce,e as k}from"./CTable-DhNDncwx.js";const Ue={class:"p-3"},Ee={key:0,class:"py-3"},Be={key:1},qe={key:2},He={class:"text-muted small"},Oe={class:"d-flex gap-2"},je={key:0},he={key:0,class:"text-muted"},Ge={key:1},Ye={class:"d-flex flex-wrap"},Je={key:1,class:"text-muted"},Ke={key:0},Qe={key:1},We={key:0,class:"text-muted"},Xe={class:"d-flex align-items-center mb-2"},Ze={class:"me-2"},et={key:0,class:"text-muted"},tt={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},lt={class:"me-2"},at={class:"text-muted ms-2"},st={key:0,class:"text-muted"},nt={key:1,class:"d-flex flex-column gap-2"},ot=["value","disabled"],it=["value"],rt={key:0,class:"text-muted"},ut={key:1,class:"text-danger"},dt={key:2,class:"text-muted"},pt={class:"mb-3"},mt=["value"],ft={key:0,class:"text-danger mt-2"},vt="badge rounded-pill text-bg-secondary me-2 mb-2",Lt={__name:"ParticipantDetail",setup(ct){const c=Te(),be=Ne(),te=m(!0),_=m({participant:null,plans:[]}),le=m(""),V=m(!1),me=m([]),M=m(""),D=m({loading:!0,plans:[]}),$=m({loading:!0,allInputs:[],plans:[]});m(!1),m(""),m("");const H=m(!1),O=m(!1),j=m(""),F=m(!1),A=m(!1),z=m(new Set),fe=Q({get:()=>[...z.value],set:o=>{z.value=new Set(o.map(Number).filter(e=>Number.isFinite(e)))}}),we=Q(()=>Math.min(10,Math.max(4,ae.value.length))),R=m(["ACTUAL"]),y=m([]),h=m(!0),G=m(""),ve=o=>{const e=Number(o??0);return Number.isFinite(e)?e.toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}):"â€”"},U=Q(()=>{var e;return(((e=_.value)==null?void 0:e.plans)||[]).map(l=>{var u;return{...l,planId:l.planId??l.plan_id??((u=l.plan)==null?void 0:u.id)??l.cpId??l.cid??null}}).filter(l=>l.planId)}),ae=Q(()=>{const o=(le.value||"").toLowerCase().trim();return o?U.value.filter(e=>String(e.name||"").toLowerCase().includes(o)||String(e.version||"").toLowerCase().includes(o)):U.value}),Y=async()=>{var o;te.value=!0;try{const{data:e}=await g.get(`/api/participants/${c.params.id}`,{withCredentials:!0}),l=Array.isArray(e.plans)?e.plans:[];for(const u of l)u.planId=u.planId??u.plan_id??((o=u.plan)==null?void 0:o.id)??u.cpId??u.cid??null;_.value={participant:e.participant??null,plans:l}}finally{te.value=!1}},Se=async()=>{const{data:o}=await g.get("/api/plans",{withCredentials:!0});me.value=o||[]},J=async()=>{D.value.loading=!0;try{const{data:o}=await g.get(`/api/participants/${c.params.id}/payout-history`,{withCredentials:!0});D.value.plans=(o==null?void 0:o.plans)||[]}finally{D.value.loading=!1}},K=async()=>{$.value.loading=!0;try{const{data:o}=await g.get(`/api/participants/${c.params.id}/required-source-inputs`,{withCredentials:!0});$.value={loading:!1,allInputs:Array.isArray(o==null?void 0:o.allInputs)?o.allInputs:[],plans:Array.isArray(o==null?void 0:o.plans)?o.plans:[]}}catch(o){console.error(o),$.value={loading:!1,allInputs:[],plans:[]}}};async function ce(){var o,e;G.value="",h.value=!0,y.value=[];try{try{const{data:f}=await g.get("/api/source-data/scopes",{withCredentials:!0,params:{participantId:c.params.id}}),b=Array.isArray(f)?f:Array.isArray(f==null?void 0:f.scopes)?f.scopes:[];if(b.length){y.value=Array.from(new Set(b.map(x=>String(x||"").trim()))).sort();return}}catch{}const l=5e3;let u=new Set,v=0;const P=500;let E=1/0;for(;v<E&&v<l;){const{data:f}=await g.get("/api/source-data",{withCredentials:!0,params:{participantId:c.params.id,limit:P,offset:v}}),b=f||{},x=Array.isArray(b)?b:b.records||[];E=Number(b.total??x.length??0)||0;for(const I of x){const T=(I.recordScope??I.record_scope??"").toString().trim();T&&u.add(T)}if(v+=P,!x.length)break}y.value=Array.from(u).sort(),y.value.length||(y.value=["ACTUAL"])}catch(l){console.error(l),G.value=((e=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:e.error)||"Failed to load record scopes",y.value.length||(y.value=["ACTUAL"])}finally{h.value=!1;const l=new Set((R.value||[]).map(u=>String(u||"").trim()).filter(Boolean));if(l.size){const u=new Set([...y.value,...l]);y.value=Array.from(u).sort()}}}De(async()=>{await Promise.all([Y(),Se(),J(),K(),ce()])}),$e(()=>c.params.id,async()=>{await Promise.all([Y(),J(),K(),ce()])}),m(!1);const ke=async()=>{M.value&&(await g.post(`/api/participants/${c.params.id}/plans`,{planId:Number(M.value)},{withCredentials:!0}),V.value=!1,await Promise.all([Y(),J(),K()]))},Ae=async o=>{confirm("Detach this plan from the participant? All historical calculations will be removed.")&&(await g.delete(`/api/participants/${c.params.id}/plans/${o}`,{withCredentials:!0}),await Promise.all([Y(),J(),K()]))},xe=()=>{j.value="",H.value=!0},Ie=async()=>{var o,e;O.value=!0;try{await g.delete(`/api/participants/${c.params.id}`,{withCredentials:!0}),be.push({name:"ParticipantsList"})}catch(l){console.error(l),j.value=((e=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:e.error)||"Failed to delete"}finally{O.value=!1}},Le=async()=>{var u,v,P,E;if(!z.value.size)return;const o=Array.from(z.value),e=Array.isArray(R.value)?R.value.map(f=>String(f||"").trim()).filter(Boolean):[],l=e.length?e:["ACTUAL"];A.value=!0;try{const{data:f}=await g.post(`/api/participants/${c.params.id}/comp-statement`,{planIds:o,recordScopes:l},{withCredentials:!0,responseType:"blob"}),b=new Blob([f],{type:"text/html"}),x=URL.createObjectURL(b),I=document.createElement("a"),T=new Date,Pe=`${T.getFullYear()}-${String(T.getMonth()+1).padStart(2,"0")}-${String(T.getDate()).padStart(2,"0")}`;I.href=x,I.download=`CompStatement_${((v=(u=_.value)==null?void 0:u.participant)==null?void 0:v.lastName)??"Participant"}_${Pe}.html`,document.body.appendChild(I),I.click(),I.remove(),URL.revokeObjectURL(x),F.value=!1}catch(f){console.error(f),alert(((E=(P=f==null?void 0:f.response)==null?void 0:P.data)==null?void 0:E.error)||(f==null?void 0:f.message)||"Failed to generate statement")}finally{A.value=!1}};return(o,e)=>(i(),r("div",Ue,[te.value?(i(),r("div",Ee,[a(t(N))])):_.value.participant?(i(),r("div",qe,[a(t(X),{class:"mb-3"},{default:s(()=>[a(t(Z),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:s(()=>[p("span",null,[n(" Participant: "+d(_.value.participant.firstName)+" "+d(_.value.participant.lastName)+" ",1),p("span",He,"(#"+d(_.value.participant.id)+")",1)]),p("div",Oe,[a(t(ye),{class:"btn btn-primary",to:{name:"ParticipantEdit",params:{id:t(c).params.id}}},{default:s(()=>e[12]||(e[12]=[n("Edit",-1)])),_:1,__:[12]},8,["to"]),a(t(C),{color:"danger",variant:"outline",onClick:xe},{default:s(()=>e[13]||(e[13]=[n("Delete",-1)])),_:1,__:[13]}),a(t(C),{color:"primary",size:"sm",onClick:e[0]||(e[0]=l=>V.value=!0)},{default:s(()=>e[14]||(e[14]=[n("Attach Plan",-1)])),_:1,__:[14]}),a(t(C),{color:"warning",size:"sm",onClick:e[1]||(e[1]=l=>F.value=!0)},{default:s(()=>e[15]||(e[15]=[n("Comp Statement",-1)])),_:1,__:[15]})])]),_:1}),a(t(W),null,{default:s(()=>[a(t(Re),null,{default:s(()=>[a(t(oe),{md:"4"},{default:s(()=>[e[16]||(e[16]=p("strong",null,"Email:",-1)),n(" "+d(_.value.participant.email),1)]),_:1,__:[16]}),a(t(oe),{md:"4"},{default:s(()=>[e[17]||(e[17]=p("strong",null,"ID:",-1)),n(" "+d(_.value.participant.id),1)]),_:1,__:[17]}),a(t(oe),{md:"4"},{default:s(()=>[e[18]||(e[18]=p("strong",null,"Created:",-1)),n(" "+d(new Date(_.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[18]})]),_:1})]),_:1})]),_:1}),a(t(X),{class:"mb-3"},{default:s(()=>[a(t(Z),{class:"fw-semibold"},{default:s(()=>e[19]||(e[19]=[n("Required Source Data Inputs",-1)])),_:1,__:[19]}),a(t(W),null,{default:s(()=>[$.value.loading?(i(),r("div",je,[a(t(N))])):(i(),r(w,{key:1},[$.value.allInputs.length?(i(),r("div",Ge,[e[20]||(e[20]=p("h6",{class:"mb-2"},"All required labels for this participant",-1)),p("div",Ye,[(i(!0),r(w,null,L($.value.allInputs,l=>(i(),r("span",{key:"all-"+l,class:Ve(vt)},d(l),1))),128))])])):(i(),r("div",he," No source data requirements detected for this participantâ€™s attached plans. "))],64))]),_:1})]),_:1}),a(t(X),null,{default:s(()=>[a(t(Z),{class:"fw-semibold"},{default:s(()=>e[21]||(e[21]=[n("Attached Plans",-1)])),_:1,__:[21]}),a(t(W),null,{default:s(()=>[U.value.length?(i(),B(t(Ce),{key:0,hover:"",responsive:""},{default:s(()=>[a(t(_e),null,{default:s(()=>[a(t(ee),null,{default:s(()=>[a(t(S),null,{default:s(()=>e[22]||(e[22]=[n("Name",-1)])),_:1,__:[22]}),a(t(S),null,{default:s(()=>e[23]||(e[23]=[n("Version",-1)])),_:1,__:[23]}),a(t(S),null,{default:s(()=>e[24]||(e[24]=[n("Plan Effective",-1)])),_:1,__:[24]}),a(t(S),null,{default:s(()=>e[25]||(e[25]=[n("Attached",-1)])),_:1,__:[25]}),a(t(S),null,{default:s(()=>e[26]||(e[26]=[n("Actions",-1)])),_:1,__:[26]})]),_:1})]),_:1}),a(t(ge),null,{default:s(()=>[(i(!0),r(w,null,L(U.value,l=>(i(),B(t(ee),{key:l.planId},{default:s(()=>[a(t(k),null,{default:s(()=>[n(d(l.name),1)]),_:2},1024),a(t(k),null,{default:s(()=>[n("v"+d(l.version),1)]),_:2},1024),a(t(k),null,{default:s(()=>[n(d(l.planEffectiveStart||"â€”")+" â†’ "+d(l.planEffectiveEnd||"â€”"),1)]),_:2},1024),a(t(k),null,{default:s(()=>[n(d(new Date(l.attachedAt).toLocaleString()),1)]),_:2},1024),a(t(k),null,{default:s(()=>[a(t(C),{color:"secondary",size:"sm",onClick:u=>Ae(l.planId)},{default:s(()=>e[27]||(e[27]=[n("Detach",-1)])),_:2,__:[27]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(i(),r("div",Je,"No plans attached yet."))]),_:1})]),_:1}),a(t(X),{class:"mt-3"},{default:s(()=>[a(t(Z),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:s(()=>[e[29]||(e[29]=p("span",null,"Payout History (by Plan & Period)",-1)),a(t(ye),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:s(()=>e[28]||(e[28]=[n("View Plans",-1)])),_:1,__:[28]})]),_:1,__:[29]}),a(t(W),null,{default:s(()=>[D.value.loading?(i(),r("div",Ke,[a(t(N))])):(i(),r("div",Qe,[D.value.plans.length?q("",!0):(i(),r("div",We,"No payout history yet.")),(i(!0),r(w,null,L(D.value.plans,l=>(i(),r("div",{key:l.planId,class:"mb-4"},[p("div",Xe,[p("strong",Ze,d(l.planName),1),a(t(Me),{color:"secondary",class:"me-2"},{default:s(()=>[n("v"+d(l.planVersion),1)]),_:2},1024)]),a(t(Ce),{hover:"",responsive:"",small:""},{default:s(()=>[a(t(_e),null,{default:s(()=>[a(t(ee),null,{default:s(()=>[a(t(S),{style:{"min-width":"120px"}},{default:s(()=>e[30]||(e[30]=[n("Period",-1)])),_:1,__:[30]}),a(t(S),{style:{"min-width":"120px"}},{default:s(()=>e[31]||(e[31]=[n("Period End Date",-1)])),_:1,__:[31]}),a(t(S),{style:{"min-width":"160px","text-align":"center"}},{default:s(()=>e[32]||(e[32]=[n("Total Payout",-1)])),_:1,__:[32]}),a(t(S),null,{default:s(()=>e[33]||(e[33]=[n("Computations",-1)])),_:1,__:[33]})]),_:1})]),_:1}),a(t(ge),null,{default:s(()=>[(i(!0),r(w,null,L(l.periods,u=>(i(),B(t(ee),{key:u.periodStart+"|"+u.periodEnd+"|"+(u.periodLabel||"")},{default:s(()=>[a(t(k),null,{default:s(()=>[p("div",null,[n(d(new Date(u.periodStart).toISOString().split("T")[0])+" â­¾ ",1),e[34]||(e[34]=p("br",null,null,-1)),n(d(new Date(u.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),a(t(k),null,{default:s(()=>[n(d(new Date(u.dueDate).toISOString().split("T")[0]),1),e[35]||(e[35]=p("br",null,null,-1)),u.periodLabel?(i(),r("small",et,d(u.periodLabel),1)):q("",!0)]),_:2,__:[35]},1024),a(t(k),{style:{"text-align":"center"}},{default:s(()=>[p("strong",null,d(ve(u.total)),1)]),_:2},1024),a(t(k),null,{default:s(()=>[p("ul",tt,[(i(!0),r(w,null,L(u.lines,(v,P)=>(i(),r("li",{key:v.outputLabel+"|"+P},[p("span",lt,d(v.outputLabel),1),p("strong",null,d(ve(v.amount)),1),p("small",at,d(new Date(v.createdAt).toLocaleString()),1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),a(t(pe),{visible:F.value,onClose:e[6]||(e[6]=l=>F.value=!1),alignment:"center",backdrop:"static"},{default:s(()=>[a(t(ie),null,{default:s(()=>[a(t(re),null,{default:s(()=>e[36]||(e[36]=[n("Generate Comp Statement",-1)])),_:1,__:[36]})]),_:1}),a(t(ue),null,{default:s(()=>[e[41]||(e[41]=p("div",{class:"mb-2 text-muted"},"Select plan(s) and record scope(s) to include:",-1)),U.value.length?(i(),r("div",nt,[a(t(ze),{modelValue:le.value,"onUpdate:modelValue":e[2]||(e[2]=l=>le.value=l),placeholder:"Filter plansâ€¦",class:"mb-2",disabled:A.value},null,8,["modelValue","disabled"]),a(t(se),{for:"planSelectMulti",class:"mb-1"},{default:s(()=>e[37]||(e[37]=[n("Plans",-1)])),_:1,__:[37]}),a(t(ne),{id:"planSelectMulti",multiple:"",size:we.value,modelValue:fe.value,"onUpdate:modelValue":e[3]||(e[3]=l=>fe.value=l),disabled:A.value||!ae.value.length,style:{"max-height":"260px",overflow:"auto"}},{default:s(()=>[(i(!0),r(w,null,L(ae.value,l=>(i(),r("option",{key:l.id??l.planId,value:l.planId,disabled:!(l!=null&&l.planId)},d((l==null?void 0:l.name)??"Unnamed")+" (v"+d((l==null?void 0:l.version)??"?")+") ",9,ot))),128))]),_:1},8,["size","modelValue","disabled"]),a(t(se),{for:"scopeSelectMulti",class:"mb-1 mt-3"},{default:s(()=>e[38]||(e[38]=[n("Record Scopes",-1)])),_:1,__:[38]}),a(t(ne),{id:"scopeSelectMulti",multiple:"",size:Math.min(8,Math.max(4,(y.value||[]).length||4)),modelValue:R.value,"onUpdate:modelValue":e[4]||(e[4]=l=>R.value=l),disabled:A.value||h.value,style:{"max-height":"220px",overflow:"auto"}},{default:s(()=>[(i(!0),r(w,null,L(y.value,l=>(i(),r("option",{key:l,value:l},d(l),9,it))),128))]),_:1},8,["size","modelValue","disabled"]),h.value?(i(),r("small",rt,[a(t(N),{size:"sm",class:"me-1"}),e[39]||(e[39]=n("Loading record scopesâ€¦ ",-1))])):G.value?(i(),r("small",ut,d(G.value),1)):(i(),r("small",dt,e[40]||(e[40]=[n(" Select one or more scopes (defaults to ",-1),p("strong",null,"ACTUAL",-1),n(" if none selected). ",-1)])))])):(i(),r("div",st," This participant is not attached to any plans. "))]),_:1,__:[41]}),a(t(de),null,{default:s(()=>[a(t(C),{color:"secondary",onClick:e[5]||(e[5]=l=>F.value=!1),disabled:A.value},{default:s(()=>e[42]||(e[42]=[n("Cancel",-1)])),_:1,__:[42]},8,["disabled"]),a(t(C),{color:"primary",onClick:Le,disabled:A.value||!z.value.size},{default:s(()=>[A.value?(i(),B(t(N),{key:0,size:"sm",class:"me-2"})):q("",!0),e[43]||(e[43]=n(" Generate Statement ",-1))]),_:1,__:[43]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(t(pe),{visible:V.value,onClose:e[9]||(e[9]=l=>V.value=!1)},{default:s(()=>[a(t(ie),null,{default:s(()=>[a(t(re),null,{default:s(()=>e[44]||(e[44]=[n("Attach Plan",-1)])),_:1,__:[44]})]),_:1}),a(t(ue),null,{default:s(()=>[a(t(Fe),null,{default:s(()=>[p("div",pt,[a(t(se),{for:"planSelectSingle"},{default:s(()=>e[45]||(e[45]=[n("Available Plans",-1)])),_:1,__:[45]}),a(t(ne),{id:"planSelectSingle",modelValue:M.value,"onUpdate:modelValue":e[7]||(e[7]=l=>M.value=l)},{default:s(()=>[e[46]||(e[46]=p("option",{value:""},"Select a planâ€¦",-1)),(i(!0),r(w,null,L(me.value,l=>(i(),r("option",{key:l.id,value:l.id},d(l.name)+" (v"+d(l.version)+")",9,mt))),128))]),_:1,__:[46]},8,["modelValue"])])]),_:1})]),_:1}),a(t(de),null,{default:s(()=>[a(t(C),{color:"secondary",onClick:e[8]||(e[8]=l=>V.value=!1)},{default:s(()=>e[47]||(e[47]=[n("Cancel",-1)])),_:1,__:[47]}),a(t(C),{color:"primary",disabled:!M.value,onClick:ke},{default:s(()=>e[48]||(e[48]=[n("Attach",-1)])),_:1,__:[48]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(t(pe),{visible:H.value,onClose:e[11]||(e[11]=l=>H.value=!1)},{default:s(()=>[a(t(ie),null,{default:s(()=>[a(t(re),null,{default:s(()=>e[49]||(e[49]=[n("Delete participant?",-1)])),_:1,__:[49]})]),_:1}),a(t(ue),null,{default:s(()=>[e[50]||(e[50]=n(" This cannot be undone. Continue? ",-1)),j.value?(i(),r("div",ft,d(j.value),1)):q("",!0)]),_:1,__:[50]}),a(t(de),null,{default:s(()=>[a(t(C),{color:"secondary",onClick:e[10]||(e[10]=l=>H.value=!1)},{default:s(()=>e[51]||(e[51]=[n("Cancel",-1)])),_:1,__:[51]}),a(t(C),{color:"danger",disabled:O.value,onClick:Ie},{default:s(()=>[O.value?(i(),B(t(N),{key:0,size:"sm",class:"me-2"})):q("",!0),e[52]||(e[52]=n(" Delete ",-1))]),_:1,__:[52]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(i(),r("div",Be,"Not found."))]))}};export{Lt as default};
