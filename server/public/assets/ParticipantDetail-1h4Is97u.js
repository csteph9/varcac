import{r as m,o as Ct,m as bt,c as r,a as l,u as e,w as a,b as p,e as s,t as i,R as lt,q as gt,C as q,g as Y,k as E,F as $,f as x,d as I,l as wt,p as kt,h as k,i as St,n as Pt,j as u}from"./index-C5PjdH1u.js";import{C as $t}from"./CBadge-CjTtDowk.js";import{C as _}from"./CButton-CmOQe7lx.js";import{C as K}from"./CCardHeader-ZktOyhiF.js";import{C as xt}from"./CForm-CUo11SnN.js";import{C as Dt}from"./CFormSelect-BQ4o_mjU.js";import{C as Nt,a as Q}from"./CRow-BjL7ivIQ.js";import{C as z,a as O,b as H,c as U,d as j}from"./CModalTitle-CBJsrESb.js";import{C as J}from"./CSpinner-CajLDNd3.js";import{a as at,b as W,c as b,d as nt,C as st,e as g}from"./CTable-BpxxO1kN.js";const Lt={class:"p-3"},At={key:0,class:"py-3"},Tt={key:1},Et={key:2},It={class:"text-muted small"},Bt={class:"d-flex gap-2"},Rt={key:1,class:"text-muted"},Mt={key:0},Vt={key:1},Ft={key:0,class:"text-muted"},zt={class:"d-flex align-items-center mb-2"},Ot={class:"me-2"},Ht={key:0,class:"text-muted"},Ut={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},jt={class:"text-muted"},Jt={class:"mb-3"},Wt=["value"],Gt={key:0,class:"text-danger mt-2"},qt={style:{"white-space":"pre-wrap","word-break":"break-word",margin:"0"}},Yt={key:0,class:"text-muted"},Kt={key:1,class:"d-flex flex-column gap-2"},Qt=["checked","disabled","onChange"],ue={__name:"ParticipantDetail",setup(Xt){const C=gt(),ot=St(),G=m(!0),v=m({participant:null,plans:[]}),D=m(!1),X=m([]),S=m(""),P=m({loading:!0,plans:[]}),B=async()=>{var o;G.value=!0;try{const{data:t}=await k.get(`/api/participants/${C.params.id}`,{withCredentials:!0}),d=Array.isArray(t.plans)?t.plans:[];for(const n of d)n.planId=n.planId??n.plan_id??((o=n.plan)==null?void 0:o.id)??n.cpId??n.cid??null;v.value={participant:t.participant??null,plans:d}}finally{G.value=!1}},it=async()=>{const{data:o}=await k.get("/api/plans",{withCredentials:!0});X.value=o||[]},R=async()=>{P.value.loading=!0;try{const{data:o}=await k.get(`/api/participants/${C.params.id}/payout-history`,{withCredentials:!0});P.value.plans=(o==null?void 0:o.plans)||[]}finally{P.value.loading=!1}};Ct(async()=>{await Promise.all([B(),it(),R()])}),bt(()=>C.params.id,async()=>{await Promise.all([B(),R()])});const ut=()=>{S.value="",D.value=!0},Z=async()=>{S.value&&(await k.post(`/api/participants/${C.params.id}/plans`,{planId:Number(S.value)},{withCredentials:!0}),D.value=!1,await Promise.all([B(),R()]))},dt=async o=>{confirm("Detach this plan from the participant?")&&(await k.delete(`/api/participants/${C.params.id}/plans/${o}`,{withCredentials:!0}),await Promise.all([B(),R()]))},N=m(!1),L=m(!1),M=m(""),rt=()=>{N.value=!0},pt=async()=>{var o,t;L.value=!0,M.value="";try{await k.delete(`/api/participants/${C.params.id}`,{withCredentials:!0}),ot.push({name:"ParticipantsList"})}catch(d){M.value=((t=(o=d==null?void 0:d.response)==null?void 0:o.data)==null?void 0:t.error)||"Delete failed"}finally{L.value=!1,N.value=L.value}},h=o=>(Number.isFinite(Number(o))?Number(o):0).toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}),ft=o=>o?new Date(o).toLocaleString():"â€”",V=m(!1),tt=m(""),et=m("");function mt(o){if(o==null||o==="")return"(no payload)";try{if(typeof o=="string"){const t=o.trim();return t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")?JSON.stringify(JSON.parse(o),null,2):o}return JSON.stringify(o,null,2)}catch{return String(o)}}function vt(o,t,d){tt.value=`${o.planName} Â· ${t.periodStart} â†’ ${t.periodEnd} Â· ${d.outputLabel}`,et.value=mt(d.payload),V.value=!0}const A=m(!1),y=m(new Set),T=m(!1);function _t(o){o&&(y.value.has(o)?y.value.delete(o):y.value.add(o),y.value=new Set(y.value))}async function yt(){var o,t;if(!y.value.size){alert("Select at least one plan.");return}Array.from(y.value),T.value=!0;try{const d=Array.from(y.value),{data:n}=await k.post(`/api/participants/${C.params.id}/comp-statement`,{planIds:d},{withCredentials:!0,responseType:"blob"}),f=new Blob([n],{type:"application/html"}),c=URL.createObjectURL(f),w=document.createElement("a"),F=new Date,ct=`${F.getFullYear()}-${String(F.getMonth()+1).padStart(2,"0")}-${String(F.getDate()).padStart(2,"0")}`;w.href=c,w.download=`CompStatement_${C.params.id}_${ct}.html`,document.body.appendChild(w),w.click(),w.remove(),URL.revokeObjectURL(c),A.value=!1}catch(d){console.error(d),alert(((t=(o=d==null?void 0:d.response)==null?void 0:o.data)==null?void 0:t.error)||(d==null?void 0:d.message)||"Failed to generate statement")}finally{T.value=!1}}return(o,t)=>{const d=Pt("BR");return u(),r("div",Lt,[G.value?(u(),r("div",At,[l(e(J))])):v.value.participant?(u(),r("div",Et,[l(e(Y),{class:"mb-3"},{default:a(()=>[l(e(K),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:a(()=>[p("span",null,[s(" Participant: "+i(v.value.participant.firstName)+" "+i(v.value.participant.lastName)+" ",1),p("span",It,"(#"+i(v.value.participant.id)+")",1)]),p("div",Bt,[l(e(lt),{class:"btn btn-primary",to:{name:"ParticipantEdit",params:{id:e(C).params.id}}},{default:a(()=>t[10]||(t[10]=[s("Edit",-1)])),_:1,__:[10]},8,["to"]),l(e(_),{color:"danger",variant:"outline",onClick:rt},{default:a(()=>t[11]||(t[11]=[s("Delete",-1)])),_:1,__:[11]}),l(e(_),{color:"primary",size:"sm",onClick:ut},{default:a(()=>t[12]||(t[12]=[s("Attach Plan",-1)])),_:1,__:[12]}),l(e(_),{color:"warning",size:"sm",onClick:t[0]||(t[0]=n=>A.value=!0)},{default:a(()=>t[13]||(t[13]=[s("Comp Statement",-1)])),_:1,__:[13]})])]),_:1}),l(e(q),null,{default:a(()=>[l(e(Nt),null,{default:a(()=>[l(e(Q),{md:"4"},{default:a(()=>[t[14]||(t[14]=p("strong",null,"Email:",-1)),s(" "+i(v.value.participant.email),1)]),_:1,__:[14]}),l(e(Q),{md:"4"},{default:a(()=>[t[15]||(t[15]=p("strong",null,"ID:",-1)),s(" "+i(v.value.participant.id),1)]),_:1,__:[15]}),l(e(Q),{md:"4"},{default:a(()=>[t[16]||(t[16]=p("strong",null,"Created:",-1)),s(" "+i(new Date(v.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[16]})]),_:1})]),_:1})]),_:1}),l(e(Y),null,{default:a(()=>[l(e(K),{class:"fw-semibold"},{default:a(()=>t[17]||(t[17]=[s("Attached Plans",-1)])),_:1,__:[17]}),l(e(q),null,{default:a(()=>[v.value.plans.length?(u(),E(e(st),{key:0,hover:"",responsive:""},{default:a(()=>[l(e(at),null,{default:a(()=>[l(e(W),null,{default:a(()=>[l(e(b),null,{default:a(()=>t[18]||(t[18]=[s("Name",-1)])),_:1,__:[18]}),l(e(b),null,{default:a(()=>t[19]||(t[19]=[s("Version",-1)])),_:1,__:[19]}),l(e(b),null,{default:a(()=>t[20]||(t[20]=[s("Plan Effective",-1)])),_:1,__:[20]}),l(e(b),null,{default:a(()=>t[21]||(t[21]=[s("Attached",-1)])),_:1,__:[21]}),l(e(b),null,{default:a(()=>t[22]||(t[22]=[s("Actions",-1)])),_:1,__:[22]})]),_:1})]),_:1}),l(e(nt),null,{default:a(()=>[(u(!0),r($,null,x(v.value.plans,n=>(u(),E(e(W),{key:n.id},{default:a(()=>[l(e(g),null,{default:a(()=>[s(i(n.name),1)]),_:2},1024),l(e(g),null,{default:a(()=>[s("v"+i(n.version),1)]),_:2},1024),l(e(g),null,{default:a(()=>[s(i(n.planEffectiveStart||"â€”")+" â†’ "+i(n.planEffectiveEnd||"â€”"),1)]),_:2},1024),l(e(g),null,{default:a(()=>[s(i(new Date(n.attachedAt).toLocaleString()),1)]),_:2},1024),l(e(g),null,{default:a(()=>[l(e(_),{color:"secondary",size:"sm",onClick:f=>dt(n.id)},{default:a(()=>t[23]||(t[23]=[s("Detach",-1)])),_:2,__:[23]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(u(),r("div",Rt,"No plans attached yet."))]),_:1})]),_:1}),l(e(Y),{class:"mt-3"},{default:a(()=>[l(e(K),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:a(()=>[t[25]||(t[25]=p("span",null,"Payout History (by Plan & Period)",-1)),l(e(lt),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:a(()=>t[24]||(t[24]=[s("View Plans",-1)])),_:1,__:[24]})]),_:1,__:[25]}),l(e(q),null,{default:a(()=>[P.value.loading?(u(),r("div",Mt,[l(e(J))])):(u(),r("div",Vt,[P.value.plans.length?I("",!0):(u(),r("div",Ft,"No payout history yet.")),(u(!0),r($,null,x(P.value.plans,n=>(u(),r("div",{key:n.planId,class:"mb-4"},[p("div",zt,[p("strong",Ot,i(n.planName),1),l(e($t),{color:"secondary",class:"me-2"},{default:a(()=>[s("v"+i(n.planVersion),1)]),_:2},1024)]),l(e(st),{hover:"",responsive:"",small:""},{default:a(()=>[l(e(at),null,{default:a(()=>[l(e(W),null,{default:a(()=>[l(e(b),{style:{"min-width":"120px"}},{default:a(()=>t[26]||(t[26]=[s("Period",-1)])),_:1,__:[26]}),l(e(b),{style:{"min-width":"120px"}},{default:a(()=>t[27]||(t[27]=[s("Period End Date",-1)])),_:1,__:[27]}),l(e(b),{style:{"min-width":"160px","text-align":"center"}},{default:a(()=>t[28]||(t[28]=[s("Total Payout",-1)])),_:1,__:[28]}),l(e(b),null,{default:a(()=>t[29]||(t[29]=[s("Computations",-1)])),_:1,__:[29]})]),_:1})]),_:1}),l(e(nt),null,{default:a(()=>[(u(!0),r($,null,x(n.periods,f=>(u(),E(e(W),{key:f.periodStart+"|"+f.periodEnd+"|"+(f.periodLabel||"")},{default:a(()=>[l(e(g),null,{default:a(()=>[p("div",null,[s(i(new Date(f.periodStart).toISOString().split("T")[0])+" â­¾ ",1),l(d),s(i(new Date(f.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),l(e(g),null,{default:a(()=>[s(i(new Date(f.dueDate).toISOString().split("T")[0]),1),l(d),f.periodLabel?(u(),r("small",Ht,i(f.periodLabel),1)):I("",!0)]),_:2},1024),l(e(g),{style:{"text-align":"center"}},{default:a(()=>[p("strong",null,i(h(f.total)),1)]),_:2},1024),l(e(g),null,{default:a(()=>[p("ul",Ut,[(u(!0),r($,null,x(f.lines,(c,w)=>(u(),r("li",{key:c.id||w},[l(e(_),{size:"sm",color:"success",class:"ms-2",variant:"outline",shape:"rounded-3",disabled:!c.payload||c.payload==="",onClick:F=>vt(n,f,c),title:"View payload"},{default:a(()=>[p("strong",null,i(c.outputLabel),1)]),_:2},1032,["disabled","onClick"]),s(" â†’ "+i(h(c.amount))+" ",1),p("span",jt,"Â â€¢ ("+i(ft(c.createdAt))+")",1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),l(e(j),{visible:D.value,onClose:t[3]||(t[3]=n=>D.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(z),null,{default:a(()=>[l(e(O),null,{default:a(()=>t[30]||(t[30]=[s("Attach Plan",-1)])),_:1,__:[30]})]),_:1}),l(e(H),null,{default:a(()=>[l(e(xt),{onSubmit:wt(Z,["prevent"])},{default:a(()=>[p("div",Jt,[l(e(kt),null,{default:a(()=>t[31]||(t[31]=[s("Select a plan",-1)])),_:1,__:[31]}),l(e(Dt),{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=n=>S.value=n)},{default:a(()=>[t[32]||(t[32]=p("option",{value:""},"Select a planâ€¦",-1)),(u(!0),r($,null,x(X.value,n=>(u(),r("option",{key:n.id,value:n.id},i(n.name)+" (v"+i(n.version)+")",9,Wt))),128))]),_:1,__:[32]},8,["modelValue"])])]),_:1})]),_:1}),l(e(U),null,{default:a(()=>[l(e(_),{color:"secondary",onClick:t[2]||(t[2]=n=>D.value=!1)},{default:a(()=>t[33]||(t[33]=[s("Cancel",-1)])),_:1,__:[33]}),l(e(_),{color:"primary",disabled:!S.value,onClick:Z},{default:a(()=>t[34]||(t[34]=[s("Attach",-1)])),_:1,__:[34]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(j),{visible:N.value,onClose:t[5]||(t[5]=n=>N.value=!1)},{default:a(()=>[l(e(z),null,{default:a(()=>[l(e(O),null,{default:a(()=>t[35]||(t[35]=[s("Delete participant?",-1)])),_:1,__:[35]})]),_:1}),l(e(H),null,{default:a(()=>[t[36]||(t[36]=s(" This cannot be undone. Continue? ",-1)),M.value?(u(),r("div",Gt,i(M.value),1)):I("",!0)]),_:1,__:[36]}),l(e(U),null,{default:a(()=>[l(e(_),{color:"secondary",onClick:t[4]||(t[4]=n=>N.value=!1)},{default:a(()=>t[37]||(t[37]=[s("Cancel",-1)])),_:1,__:[37]}),l(e(_),{color:"danger",disabled:L.value,onClick:pt},{default:a(()=>[L.value?(u(),E(e(J),{key:0,size:"sm",class:"me-2"})):I("",!0),t[38]||(t[38]=s(" Delete ",-1))]),_:1,__:[38]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(j),{visible:V.value,onClose:t[7]||(t[7]=n=>V.value=!1),size:"lg",alignment:"center",scrollable:""},{default:a(()=>[l(e(z),null,{default:a(()=>[l(e(O),null,{default:a(()=>[s(i(tt.value||"Payload"),1)]),_:1})]),_:1}),l(e(H),null,{default:a(()=>[p("pre",qt,i(et.value),1)]),_:1}),l(e(U),null,{default:a(()=>[l(e(_),{color:"secondary",onClick:t[6]||(t[6]=n=>V.value=!1)},{default:a(()=>t[39]||(t[39]=[s("Close",-1)])),_:1,__:[39]})]),_:1})]),_:1},8,["visible"]),l(e(j),{visible:A.value,onClose:t[9]||(t[9]=n=>A.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(z),null,{default:a(()=>[l(e(O),null,{default:a(()=>t[40]||(t[40]=[s("Generate Comp Statement",-1)])),_:1,__:[40]})]),_:1}),l(e(H),null,{default:a(()=>[t[41]||(t[41]=p("div",{class:"mb-2 text-muted"},"Select plan(s) to include:",-1)),v.value.plans.length?(u(),r("div",Kt,[(u(!0),r($,null,x(v.value.plans,n=>(u(),r("label",{key:n.id,class:"d-flex align-items-center gap-2"},[p("input",{type:"checkbox",checked:y.value.has(n.planId),disabled:!n.planId,onChange:f=>_t(n.planId)},null,40,Qt),p("span",null,i(n.name)+" (v"+i(n.version)+")",1)]))),128))])):(u(),r("div",Yt,"This participant is not attached to any plans."))]),_:1,__:[41]}),l(e(U),null,{default:a(()=>[l(e(_),{color:"secondary",onClick:t[8]||(t[8]=n=>A.value=!1),disabled:T.value},{default:a(()=>t[42]||(t[42]=[s("Cancel",-1)])),_:1,__:[42]},8,["disabled"]),l(e(_),{color:"primary",onClick:yt,disabled:T.value||!y.value.size},{default:a(()=>[T.value?(u(),E(e(J),{key:0,size:"sm",class:"me-2"})):I("",!0),t[43]||(t[43]=s(" Generate Statement ",-1))]),_:1,__:[43]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(u(),r("div",Tt,"Not found."))])}}};export{ue as default};
