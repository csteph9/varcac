import{r as i,c as N,a as l,w as t,u as a,g as O,e as n,C as j,k as w,d as g,b as o,t as B,l as A,p as S,h as q,j as f}from"./index-DyVjuEV4.js";import{C as F}from"./CAlert-CqwVlYNo.js";import{C as U}from"./CButton-Ob9G74z0.js";import{C as z}from"./CCardHeader-DbalRFEA.js";import{C as D}from"./CForm-aOGSAZeI.js";import{C as $}from"./CFormCheck-B6WCwGk7.js";import{C as I}from"./CFormInput-CDOwCgWK.js";import{a as x,C as G}from"./CRow-Bilq_s-I.js";import{C as T}from"./CSpinner-Dn5wfHZO.js";const H={class:"p-3"},M={class:"mb-4"},P={class:"text-muted"},J={class:"mb-3"},K={class:"mb-2"},Q={class:"mb-3",style:{"max-width":"320px"}},re={__name:"Admin",setup(W){const v=i(!1),b=i(!1),m=i(""),u=i(""),k=i("varcac_db_backup"),L=()=>new Date().toISOString().slice(0,10),C=i(!1),R=i(""),E=i(null),V=async()=>{var p,e;m.value="",u.value="",v.value=!0;try{const s=await q.get("/api/admin/backup",{responseType:"blob",withCredentials:!0}),_=new Blob([s.data],{type:"application/sql"}),c=window.URL.createObjectURL(_),d=document.createElement("a"),y=(k.value||"db_backup").replace(/[^\w.-]/g,"_");d.href=c,d.download=`${y}-${L()}.sql`,document.body.appendChild(d),d.click(),d.remove(),window.URL.revokeObjectURL(c),m.value="Backup generated."}catch(s){console.error(s),u.value=((e=(p=s==null?void 0:s.response)==null?void 0:p.data)==null?void 0:e.error)||"Backup failed"}finally{v.value=!1}},h=async()=>{var e,s,_,c,d,y;if(m.value="",u.value="",!C.value||R.value!=="ERASE"){u.value="To restore, check the confirmation and type ERASE.";return}const p=(s=(e=E.value)==null?void 0:e.files)==null?void 0:s[0];if(!p){u.value="Please choose a .sql file to upload.";return}b.value=!0;try{const r=new FormData;r.append("dump",p),r.append("confirm","ERASE"),await q.post("/api/admin/restore",r,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"}}),m.value="Restore complete."}catch(r){console.error(r),u.value=((c=(_=r==null?void 0:r.response)==null?void 0:_.data)==null?void 0:c.detail)||((y=(d=r==null?void 0:r.response)==null?void 0:d.data)==null?void 0:y.error)||"Restore failed"}finally{b.value=!1}};return(p,e)=>(f(),N("div",H,[l(a(G),{class:"g-4"},{default:t(()=>[l(a(x),{md:"12"},{default:t(()=>[l(a(O),null,{default:t(()=>[l(a(z),{class:"fw-semibold"},{default:t(()=>e[3]||(e[3]=[n("Admin · Database Backup & Restore",-1)])),_:1,__:[3]}),l(a(j),null,{default:t(()=>[m.value?(f(),w(a(F),{key:0,color:"success",class:"mb-3"},{default:t(()=>[n(B(m.value),1)]),_:1})):g("",!0),u.value?(f(),w(a(F),{key:1,color:"danger",class:"mb-3"},{default:t(()=>[n(B(u.value),1)]),_:1})):g("",!0),o("div",M,[e[7]||(e[7]=o("h6",{class:"mb-3"},"Backup",-1)),l(a(D),{class:"row gy-2 gx-3 align-items-end",onSubmit:A(V,["prevent"])},{default:t(()=>[l(a(x),{md:"4"},{default:t(()=>[l(a(S),null,{default:t(()=>e[4]||(e[4]=[n("Filename prefix",-1)])),_:1,__:[4]}),e[5]||(e[5]=o("p",null,"Recommended use: Store your back-up files on your local intranet / file share after you complete each comp cycle run.",-1)),l(a(I),{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=s=>k.value=s),placeholder:"varcac_db_backup"},null,8,["modelValue"]),o("small",P,"Final filename: "+B((k.value||"db_backup").replace(/[^\w.-]/g,"_"))+"-"+B(new Date().toISOString().slice(0,10))+".sql",1)]),_:1,__:[5]}),l(a(x),{md:"3"},{default:t(()=>[l(a(U),{disabled:v.value,color:"primary",class:"mt-3",onClick:V},{default:t(()=>[v.value?(f(),w(a(T),{key:0,size:"sm",class:"me-2"})):g("",!0),e[6]||(e[6]=n(" Generate Backup ",-1))]),_:1,__:[6]},8,["disabled"])]),_:1})]),_:1})]),e[13]||(e[13]=o("hr",{class:"my-4"},null,-1)),o("div",null,[e[11]||(e[11]=o("h6",{class:"mb-3"},"Restore",-1)),e[12]||(e[12]=o("p",{class:"text-danger small mb-3"}," ⚠️ Restoring will overwrite the current database with the contents of your backup file. ",-1)),l(a(D),{onSubmit:A(h,["prevent"])},{default:t(()=>[o("div",J,[l(a(S),null,{default:t(()=>e[8]||(e[8]=[n("Backup .sql file",-1)])),_:1,__:[8]}),o("input",{ref_key:"fileInput",ref:E,class:"form-control",type:"file",accept:".sql,text/sql"},null,512)]),o("div",K,[l(a($),{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=s=>C.value=s),checked:C.value,label:"I understand this will permanently overwrite the database."},null,8,["modelValue","checked"])]),o("div",Q,[l(a(S),null,{default:t(()=>e[9]||(e[9]=[n("Type ",-1),o("code",null,"ERASE",-1),n(" to confirm",-1)])),_:1,__:[9]}),l(a(I),{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=s=>R.value=s),placeholder:"ERASE"},null,8,["modelValue"])]),l(a(U),{disabled:b.value,color:"danger",onClick:h},{default:t(()=>[b.value?(f(),w(a(T),{key:0,size:"sm",class:"me-2"})):g("",!0),e[10]||(e[10]=n(" Restore from Backup ",-1))]),_:1,__:[10]},8,["disabled"])]),_:1})])]),_:1,__:[13]})]),_:1})]),_:1})]),_:1})]))}};export{re as default};
