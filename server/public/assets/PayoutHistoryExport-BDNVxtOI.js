import{r as m,o as W,v as q,c as g,b as p,a as n,w as r,u as s,g as j,e as f,C as E,k as O,d as R,t as w,p as L,F as B,f as N,h as k,j as v}from"./index-CvVN3E1C.js";import{C as G}from"./CAlert-DAtuXBMd.js";import{C as F}from"./CButton-BTssrhK7.js";import{C as U}from"./CCardHeader-BChnrtWq.js";import{C as I}from"./CFormSelect-CLA5qttS.js";import{a as $,C as J}from"./CRow-DVSi5Bvt.js";import{C as K}from"./CSpinner-BQ14nvNv.js";const Q={class:"px-3 py-4"},X={class:"mb-3"},Y=["value"],Z={class:"mb-3"},ee=["value"],ae={class:"d-flex align-items-center gap-2"},te={class:"ms-auto small text-muted"},pe={__name:"PayoutHistoryExport",setup(le){const c=m(!0),y=m(!1),_=m(""),P=m([]),S=m([]),x=m([]),A=m([]);async function V(){var i,e,t,o;c.value=!0,_.value="";try{const[l,u]=await Promise.all([k.get("/api/participants",{withCredentials:!0,params:{limit:1e4}}),k.get("/api/plans",{withCredentials:!0,params:{limit:1e4}})]),b=Array.isArray((i=l.data)==null?void 0:i.records)?l.data.records:Array.isArray(l.data)?l.data:[],C=Array.isArray((e=u.data)==null?void 0:e.records)?u.data.records:Array.isArray(u.data)?u.data:[],h=a=>{if(a.name&&a.name.trim())return a.name.trim();const d=[a.first_name,a.last_name].filter(Boolean).map(M=>String(M).trim());return d.length?d.join(" "):`${a.lastName}, ${a.firstName} `};P.value=b.map(a=>({value:a.id,label:h(a)})),S.value=C.map(a=>({value:a.id,label:a.name?`${a.name}`:String(a.id)}))}catch(l){_.value=((o=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:o.error)||l.message||"Failed to load options."}finally{c.value=!1}}W(V);const D=q(()=>!c.value&&!y.value);function z(i){if(!Array.isArray(i)||!i.length)return`No data
`;const e={participant_id:"Participant",plan_id:"Plan",period_start:"Period Start",period_end:"Period End",period_label:"Period",due_date:"Due Date",output_label:"Computation",amount:"Amount"},t=["id","participant_id","plan_id","period_label","period_start","period_end","due_date","label","output_label","amount","currency","created_at","updated_at"].filter(a=>i.some(d=>Object.prototype.hasOwnProperty.call(d,a))),o=new Set;for(const a of i)Object.keys(a||{}).forEach(d=>o.add(d));const l=[...o].filter(a=>!t.includes(a)).sort(),u=[...t,...l],b=a=>{if(a==null)return"";const d=String(a);return/[",\r\n]/.test(d)?`"${d.replace(/"/g,'""')}"`:d},C=u.map(a=>b(e[a]||a)).join(","),h=i.map(a=>u.map(d=>b(a[d])).join(","));return[C,...h].join(`\r
`)+`\r
`}function H(i,e){const t=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(t),l=document.createElement("a");l.href=o,l.download=i,l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o)}async function T(){var i,e;y.value=!0,_.value="";try{const t={};x.value.length&&(t.participantIds=x.value.join(",")),A.value.length&&(t.planIds=A.value.join(","));const{data:o}=await k.get("/api/payout-history",{withCredentials:!0,params:t}),l=Array.isArray(o==null?void 0:o.records)?o.records:Array.isArray(o)?o:[],u=z(l),C=`payout_history_export_${new Date().toISOString().replace(/[-:]/g,"").replace(/\..+/,"")}.csv`;H(C,u)}catch(t){_.value=((e=(i=t==null?void 0:t.response)==null?void 0:i.data)==null?void 0:e.error)||t.message||"Failed to export CSV."}finally{y.value=!1}}return(i,e)=>(v(),g("div",Q,[e[9]||(e[9]=p("h1",{class:"h4 mb-3"},"Payout History Export",-1)),n(s(J),{class:"g-4"},{default:r(()=>[n(s($),{xs:"12",lg:"6"},{default:r(()=>[n(s(j),null,{default:r(()=>[n(s(U),{class:"fw-semibold"},{default:r(()=>e[2]||(e[2]=[f("Filters",-1)])),_:1,__:[2]}),n(s(E),null,{default:r(()=>[_.value?(v(),O(s(G),{key:0,color:"danger",class:"mb-3"},{default:r(()=>[f(w(_.value),1)]),_:1})):R("",!0),p("div",X,[n(s(L),null,{default:r(()=>e[3]||(e[3]=[f("Participants ",-1),p("span",{class:"text-muted small"},"(select at least one)",-1)])),_:1,__:[3]}),n(s(I),{multiple:!0,size:"sm",modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=t=>x.value=t),disabled:c.value},{default:r(()=>[(v(!0),g(B,null,N(P.value,t=>(v(),g("option",{key:t.value,value:t.value},w(t.label),9,Y))),128))]),_:1},8,["modelValue","disabled"])]),p("div",Z,[n(s(L),null,{default:r(()=>e[4]||(e[4]=[f("Plans ",-1),p("span",{class:"text-muted small"},"(select at least one)",-1)])),_:1,__:[4]}),n(s(I),{multiple:!0,size:"sm",modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=t=>A.value=t),disabled:c.value},{default:r(()=>[(v(!0),g(B,null,N(S.value,t=>(v(),g("option",{key:t.value,value:t.value},w(t.label),9,ee))),128))]),_:1},8,["modelValue","disabled"])]),p("div",ae,[n(s(F),{color:"primary",disabled:!D.value,onClick:T},{default:r(()=>[y.value?(v(),O(s(K),{key:0,size:"sm",class:"me-2"})):R("",!0),e[5]||(e[5]=f(" Export CSV ",-1))]),_:1,__:[5]},8,["disabled"]),n(s(F),{color:"secondary",variant:"outline",disabled:c.value||y.value,onClick:V},{default:r(()=>e[6]||(e[6]=[f(" Refresh Options ",-1)])),_:1,__:[6]},8,["disabled"]),p("div",te,w(c.value?"Loading optionsâ€¦":""),1)])]),_:1})]),_:1})]),_:1}),n(s($),{xs:"12",lg:"6"},{default:r(()=>[n(s(j),null,{default:r(()=>[n(s(U),{class:"fw-semibold"},{default:r(()=>e[7]||(e[7]=[f("What gets exported?",-1)])),_:1,__:[7]}),n(s(E),null,{default:r(()=>e[8]||(e[8]=[p("p",{class:"mb-2"}," This exports payout data for selected filters. ",-1)])),_:1,__:[8]})]),_:1})]),_:1})]),_:1})]))}};export{pe as default};
