import{r as v,o as ae,v as w,m as te,c as O,a as l,w as t,u as a,b as S,e as o,t as c,n as ue,C as oe,k as z,p as V,F as ne,f as de,g as se,h as $,L as I,j as A}from"./index-DY2iYVHx.js";import{C as b}from"./CButton-CBg_h1uZ.js";import{C as re}from"./CCardHeader-CxJUXy8l.js";import{C as H}from"./CFormCheck-_XpsjDfQ.js";import{C as T}from"./CFormInput-cfDnsWz9.js";import{C as ie,a as x}from"./CRow-CoYbaDgy.js";import{C as fe}from"./CSpinner-FP7r2lwx.js";import{a as ve,b as j,c as _,d as me,C as ce,e as C}from"./CTable-DhNDncwx.js";const pe={class:"p-3"},_e={class:"text-muted"},Ce={class:"d-flex gap-2"},ge={key:0,class:"py-3"},be={class:"d-flex justify-content-between align-items-center mt-3"},ye={class:"d-flex align-items-center gap-2"},Le={__name:"SourceDataList",setup(ke){const M=v(!0),d=v([]),m=v(0),D=v(""),R=v(""),L=v(""),F=v(""),P=v(""),p=v(200),r=v(0),s=v(new Set),q=v(null);async function g(){M.value=!0;try{const{data:n}=await $.get("/api/source-data",{withCredentials:!0,params:{participantId:D.value||void 0,recordScope:R.value||void 0,label:L.value||void 0,from:F.value||void 0,to:P.value||void 0,limit:p.value,offset:r.value}}),e=n||{},f=Array.isArray(e)?e:e.records||[];d.value=f.map(i=>({...i,recordScope:i.recordScope??i.record_scope??null})),m.value=e.total??d.value.length;const u=new Set(d.value.map(i=>i.id));for(const i of[...s.value])!u.has(i)&&m.value<=p.value&&s.value.delete(i)}finally{M.value=!1,await I(),y()}}ae(g);const N=w(()=>Math.floor(r.value/p.value)+1),h=w(()=>Math.max(Math.ceil((m.value||1)/p.value),1));function W(){r.value+p.value<m.value&&(r.value+=p.value,g())}function G(){r.value-p.value>=0&&(r.value-=p.value,g())}function J(){r.value=0,g()}function K(){D.value="",R.value="",L.value="",F.value="",P.value="",r.value=0,g()}async function Q(n){var e,f;if(n&&confirm("Delete this source data record? This cannot be undone."))try{await $.delete(`/api/source-data/${n}`,{withCredentials:!0});const u=d.value.length;d.value=d.value.filter(i=>i.id!==n),s.value.delete(n),m.value>0&&(m.value=Math.max(0,m.value-(u!==d.value.length?1:0))),d.value.length===0&&r.value>0?(r.value=Math.max(0,r.value-p.value),await g()):(await I(),y())}catch(u){console.error(u),alert(((f=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:f.error)||"Delete failed")}}const B=w(()=>d.value.map(n=>n.id)),U=w(()=>s.value.size),E=w(()=>B.value.length>0&&B.value.every(n=>s.value.has(n))),X=w(()=>!E.value&&B.value.some(n=>s.value.has(n)));function y(){var n,e;if((e=(n=q.value)==null?void 0:n.$el)!=null&&e.querySelector){const f=q.value.$el.querySelector('input[type="checkbox"]');f&&(f.indeterminate=X.value)}}te([d,s],()=>I().then(y));function Y(n,e){n&&(e?s.value.add(n):s.value.delete(n))}function Z(n){for(const e of B.value)n?s.value.add(e):s.value.delete(e);y()}function ee(){s.value.clear(),y()}async function le(){var e,f;const n=[...s.value];if(n.length&&confirm(`Delete ${n.length} selected record(s)? This cannot be undone.`))try{await $.delete("/api/source-data",{withCredentials:!0,data:{ids:n}});const u=d.value.length,i=new Set(n);d.value=d.value.filter(k=>!i.has(k.id)),n.forEach(k=>s.value.delete(k)),m.value>0&&(m.value=Math.max(0,m.value-(u-d.value.length))),d.value.length===0&&r.value>0?(r.value=Math.max(0,r.value-p.value),await g()):(await I(),y())}catch(u){console.error(u),alert(((f=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:f.error)||"Bulk delete failed")}}return(n,e)=>{const f=ue("router-link");return A(),O("div",pe,[l(a(se),null,{default:t(()=>[l(a(re),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:t(()=>[S("div",null,[e[6]||(e[6]=o(" Source Data ",-1)),S("small",_e,"("+c(m.value)+" total)",1)]),S("div",Ce,[l(a(b),{color:"danger",variant:"outline",disabled:!U.value,onClick:le},{default:t(()=>[o(" Delete Selected ("+c(U.value)+") ",1)]),_:1},8,["disabled"]),l(a(b),{color:"secondary",variant:"ghost",disabled:!U.value,onClick:ee},{default:t(()=>e[7]||(e[7]=[o(" Clear Selection ",-1)])),_:1,__:[7]},8,["disabled"]),l(f,{class:"btn btn-primary",to:{name:"SourceDataAdd"}},{default:t(()=>e[8]||(e[8]=[o("Add One",-1)])),_:1,__:[8]}),l(f,{class:"btn btn-outline-primary",to:{name:"SourceDataBulkLoad"}},{default:t(()=>e[9]||(e[9]=[o("Bulk Load (CSV)",-1)])),_:1,__:[9]})])]),_:1}),l(a(oe),null,{default:t(()=>[l(a(ie),{class:"g-3 mb-3"},{default:t(()=>[l(a(x),{md:"2"},{default:t(()=>[l(a(V),{class:"mb-1"},{default:t(()=>e[10]||(e[10]=[o("Participant ID",-1)])),_:1,__:[10]}),l(a(T),{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=u=>D.value=u),placeholder:"e.g., 101"},null,8,["modelValue"])]),_:1}),l(a(x),{md:"2"},{default:t(()=>[l(a(V),{class:"mb-1"},{default:t(()=>e[11]||(e[11]=[o("Record Scope",-1)])),_:1,__:[11]}),l(a(T),{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=u=>R.value=u),placeholder:"ACTUAL, FCST, FORECAST, ..."},null,8,["modelValue"])]),_:1}),l(a(x),{md:"3"},{default:t(()=>[l(a(V),{class:"mb-1"},{default:t(()=>e[12]||(e[12]=[o("Label",-1)])),_:1,__:[12]}),l(a(T),{modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=u=>L.value=u),placeholder:"NEW_ARR, RETAIN_NR, ..."},null,8,["modelValue"])]),_:1}),l(a(x),{md:"2"},{default:t(()=>[l(a(V),{class:"mb-1"},{default:t(()=>e[13]||(e[13]=[o("From",-1)])),_:1,__:[13]}),l(a(T),{type:"date",modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=u=>F.value=u)},null,8,["modelValue"])]),_:1}),l(a(x),{md:"2"},{default:t(()=>[l(a(V),{class:"mb-1"},{default:t(()=>e[14]||(e[14]=[o("To",-1)])),_:1,__:[14]}),l(a(T),{type:"date",modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=u=>P.value=u)},null,8,["modelValue"])]),_:1}),l(a(x),{md:"3",class:"d-flex align-items-end gap-2"},{default:t(()=>[l(a(b),{color:"primary",onClick:J},{default:t(()=>e[15]||(e[15]=[o("Apply",-1)])),_:1,__:[15]}),l(a(b),{color:"secondary",variant:"outline",onClick:K},{default:t(()=>e[16]||(e[16]=[o("Clear",-1)])),_:1,__:[16]})]),_:1})]),_:1}),M.value?(A(),O("div",ge,[l(a(fe))])):(A(),z(a(ce),{key:1,hover:"",responsive:""},{default:t(()=>[l(a(ve),null,{default:t(()=>[l(a(j),null,{default:t(()=>[l(a(_),{style:{width:"44px"}},{default:t(()=>[l(a(H),{ref_key:"selectAllRef",ref:q,checked:E.value,onChange:e[5]||(e[5]=u=>Z(u.target.checked)),"aria-label":"Select all on page"},null,8,["checked"])]),_:1}),l(a(_),null,{default:t(()=>e[17]||(e[17]=[o("Participant ID",-1)])),_:1,__:[17]}),l(a(_),null,{default:t(()=>e[18]||(e[18]=[o("Record Scope",-1)])),_:1,__:[18]}),l(a(_),null,{default:t(()=>e[19]||(e[19]=[o("Label",-1)])),_:1,__:[19]}),l(a(_),null,{default:t(()=>e[20]||(e[20]=[o("Description",-1)])),_:1,__:[20]}),l(a(_),null,{default:t(()=>e[21]||(e[21]=[o("Date",-1)])),_:1,__:[21]}),l(a(_),null,{default:t(()=>e[22]||(e[22]=[o("Value",-1)])),_:1,__:[22]}),l(a(_),null,{default:t(()=>e[23]||(e[23]=[o("Created",-1)])),_:1,__:[23]}),l(a(_),{style:{"min-width":"160px"}},{default:t(()=>e[24]||(e[24]=[o("Actions",-1)])),_:1,__:[24]})]),_:1})]),_:1}),l(a(me),null,{default:t(()=>[(A(!0),O(ne,null,de(d.value,(u,i)=>(A(),z(a(j),{key:u.id??i},{default:t(()=>[l(a(C),null,{default:t(()=>[l(a(H),{checked:s.value.has(u.id),onChange:k=>Y(u.id,k.target.checked),"aria-label":`Select row ${u.id}`},null,8,["checked","onChange","aria-label"])]),_:2},1024),l(a(C),null,{default:t(()=>[o(c(u.participantId),1)]),_:2},1024),l(a(C),null,{default:t(()=>[o(c(u.recordScope??"ACTUAL"),1)]),_:2},1024),l(a(C),{class:"fw-semibold"},{default:t(()=>[o(c(u.label),1)]),_:2},1024),l(a(C),{class:"text-truncate",style:{"max-width":"360px"}},{default:t(()=>[o(c(u.description||"—"),1)]),_:2},1024),l(a(C),null,{default:t(()=>[o(c(u.date),1)]),_:2},1024),l(a(C),null,{default:t(()=>[o(c(u.value),1)]),_:2},1024),l(a(C),null,{default:t(()=>[o(c(u.createdAt?new Date(u.createdAt).toLocaleString():"—"),1)]),_:2},1024),l(a(C),{class:"d-flex gap-2"},{default:t(()=>[l(a(b),{size:"sm",color:"danger",onClick:k=>Q(u.id)},{default:t(()=>e[25]||(e[25]=[o("Delete",-1)])),_:2,__:[25]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})),S("div",be,[S("div",null,"Page "+c(N.value)+" / "+c(h.value),1),S("div",ye,[l(a(b),{size:"sm",disabled:N.value<=1,onClick:G},{default:t(()=>e[26]||(e[26]=[o("Prev",-1)])),_:1,__:[26]},8,["disabled"]),l(a(b),{size:"sm",disabled:N.value>=h.value,onClick:W},{default:t(()=>e[27]||(e[27]=[o("Next",-1)])),_:1,__:[27]},8,["disabled"])])])]),_:1})]),_:1})])}}};export{Le as default};
