import{r as m,v as E,o as $,c as y,a as t,w as l,u as a,b as c,d as b,e as d,t as v,C as I,k as x,l as M,p as S,x as K,n as W,g as Z,h as N,q,i as H,j as i}from"./index-CxdI3lLW.js";import{C as A}from"./CAlert-DLub3ZpF.js";import{C as L}from"./CButton-DFB6vORy.js";import{C as J}from"./CCardHeader-CsnVADFo.js";import{C as P}from"./CForm-Cp8CU7xA.js";import{C as G}from"./CFormInput-Cjk4ZOBs.js";import{C as Q}from"./CFormSelect-rxPPt2KY.js";import{C as X,a as h}from"./CRow-CPLmsUDa.js";import{C as j}from"./CSpinner-CMtn1tpZ.js";import{j as Y,o as ee,T as ae}from"./index-CRs8EG3m.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={class:"p-3"},oe={key:0,class:"text-muted"},se={key:0},ne={key:0,class:"py-3"},ue={key:1},de={class:"d-flex justify-content-between align-items-center"},re={class:"d-flex gap-2"},ie={class:"mt-2"},me={class:"d-flex gap-2 mt-4"},pe={__name:"ComputationEdit",setup(ce){const T=q(),U=H(),k=m(!0),w=m(!1),p=m(""),s=m({name:"",scope:"payout",template:""}),f=m({createdAt:null,updatedAt:null}),z=E(()=>/^[A-Za-z_][A-Za-z0-9_]*$/.test(s.value.name||"")),B=E(()=>!!s.value.name&&z.value),g=m(!1),_=m(""),C=m(""),F=[Y({jsx:!1,typescript:!1}),ee],V={autofocus:!1,indentWithTab:!0,tabSize:2};function D(){g.value=!0,_.value="",C.value="";try{window._&&typeof window._.template=="function"&&window._.template(s.value.template||""),C.value="ok",_.value="Template looks OK."}catch(u){C.value="err",_.value=`Template error: ${(u==null?void 0:u.message)||u}`}finally{g.value=!1}}async function O(){var u,e;k.value=!0,p.value="";try{const{data:n}=await N.get(`/api/computations/${T.params.id}`,{withCredentials:!0}),o=(n==null?void 0:n.computation)||n||{};s.value={name:o.name||"",scope:o.scope||"payout",template:o.template||""},f.value={createdAt:o.createdAt||null,updatedAt:o.updatedAt||null}}catch(n){p.value=((e=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:e.error)||"Failed to load computation"}finally{k.value=!1}}async function R(){var u,e,n,o;if(B.value){w.value=!0,p.value="";try{await N.put(`/api/computations/${T.params.id}`,{name:s.value.name,scope:s.value.scope,template:s.value.template||null},{withCredentials:!0}),U.push({name:"ComputationList"})}catch(r){p.value=((e=(u=r==null?void 0:r.response)==null?void 0:u.data)==null?void 0:e.detail)||((o=(n=r==null?void 0:r.response)==null?void 0:n.data)==null?void 0:o.error)||(r==null?void 0:r.message)||"Save failed"}finally{w.value=!1}}}return $(O),(u,e)=>{const n=W("router-link");return i(),y("div",le,[t(a(Z),null,{default:l(()=>[t(a(J),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:l(()=>[e[3]||(e[3]=c("span",null,"Edit Computation",-1)),f.value.createdAt?(i(),y("small",oe,[d(" Created: "+v(new Date(f.value.createdAt).toLocaleString())+" ",1),f.value.updatedAt?(i(),y("span",se," • Updated: "+v(new Date(f.value.updatedAt).toLocaleString()),1)):b("",!0)])):b("",!0)]),_:1,__:[3]}),t(a(I),null,{default:l(()=>[k.value?(i(),y("div",ne,[t(a(j))])):(i(),y("div",ue,[p.value?(i(),x(a(A),{key:0,color:"danger",class:"mb-3"},{default:l(()=>[d(v(p.value),1)]),_:1})):b("",!0),t(a(P),{onSubmit:M(R,["prevent"])},{default:l(()=>[t(a(X),{class:"g-3"},{default:l(()=>[t(a(h),{md:"6"},{default:l(()=>[t(a(S),null,{default:l(()=>e[4]||(e[4]=[d("Name",-1)])),_:1,__:[4]}),t(a(G),{modelValue:s.value.name,"onUpdate:modelValue":e[0]||(e[0]=o=>s.value.name=o),placeholder:"RETENTION_BONUS"},null,8,["modelValue"]),c("small",{class:K(z.value?"text-body-secondary":"text-danger")},"Valid JS identifier recommended.",2)]),_:1}),t(a(h),{md:"6"},{default:l(()=>[t(a(S),null,{default:l(()=>e[5]||(e[5]=[d("Scope",-1)])),_:1,__:[5]}),t(a(Q),{modelValue:s.value.scope,"onUpdate:modelValue":e[1]||(e[1]=o=>s.value.scope=o),options:[{label:"Per payout period",value:"payout"},{label:"Entire plan window",value:"plan"}]},null,8,["modelValue"])]),_:1}),t(a(h),{md:"12"},{default:l(()=>[c("div",de,[t(a(S),{class:"mb-0"},{default:l(()=>e[6]||(e[6]=[d("Lodash Template",-1)])),_:1,__:[6]}),c("div",re,[t(a(L),{color:"secondary",size:"sm",disabled:g.value,onClick:D},{default:l(()=>[d(v(g.value?"Validating…":"Validate"),1)]),_:1},8,["disabled"])])]),t(a(ae),{modelValue:s.value.template,"onUpdate:modelValue":e[2]||(e[2]=o=>s.value.template=o),extensions:F,autofocus:V.autofocus,"indent-with-tab":V.indentWithTab,"tab-size":V.tabSize,placeholder:"Use Lodash template syntax, e.g. Total: <%= total %>",style:{height:"300px",border:"1px solid var(--cui-border-color, #dee2e6)","border-radius":"0.375rem",overflow:"hidden"}},null,8,["modelValue","autofocus","indent-with-tab","tab-size"]),c("div",ie,[C.value==="ok"?(i(),x(a(A),{key:0,color:"success",class:"py-2"},{default:l(()=>[d(v(_.value),1)]),_:1})):C.value==="err"?(i(),x(a(A),{key:1,color:"danger",class:"py-2"},{default:l(()=>[d(v(_.value),1)]),_:1})):b("",!0)])]),_:1})]),_:1}),c("div",me,[t(a(L),{type:"submit",color:"primary",disabled:!B.value||w.value},{default:l(()=>[w.value?(i(),x(a(j),{key:0,size:"sm",class:"me-2"})):b("",!0),e[7]||(e[7]=d(" Save ",-1))]),_:1,__:[7]},8,["disabled"]),t(n,{class:"btn btn-secondary",to:{name:"ComputationList"}},{default:l(()=>e[8]||(e[8]=[d("Cancel",-1)])),_:1,__:[8]})])]),_:1})]))]),_:1})]),_:1})])}}},Se=te(pe,[["__scopeId","data-v-30610459"]]);export{Se as default};
