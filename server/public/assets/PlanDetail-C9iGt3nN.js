import{r as f,n as Ct,o as yt,w as bt,c as u,a as l,u as e,b as a,d as p,t as r,p as gt,q as wt,e as o,C as z,f as kt,h as O,l as M,F as S,g as V,m as J,s as K,i as C,v as At,k as i}from"./index-CFGD_Gi7.js";import{C as y}from"./CButton-Bar-IVn5.js";import{C as H}from"./CCardHeader-j1dVyNP9.js";import{C as Q}from"./CForm-8Di4je1x.js";import{C as X}from"./CFormSelect-BXUyUJls.js";import{C as St,a as q}from"./CRow-CQIQrd1B.js";import{C as Y,a as Z,b as tt,c as et,d as at}from"./CModalTitle-BJzK3tic.js";import{C as lt}from"./CSpinner-B_QOP7IZ.js";import{a as nt,b as F,c as b,d as st,C as ot,e as g}from"./CTable-D8-Qdao0.js";const xt={class:"p-3"},Pt={key:0,class:"py-3"},$t={key:1},Nt={key:2},Dt={class:"d-flex align-items-center gap-2"},Et=["title"],Tt={class:"d-flex gap-2"},It={key:0},ht={key:1},Mt={key:0},Vt={key:1},Ft={key:0,class:"text-muted"},Rt={class:"badge text-bg-secondary"},Bt={key:0},Lt={key:1},Ut={key:1,class:"text-muted"},zt={class:"mb-3"},Ot={key:0},Ht={key:0,class:"text-muted"},qt={class:"mb-3"},Wt=["value"],jt={class:"mb-3"},Gt=["value"],ne={__name:"PlanDetail",setup(Jt){const c=At(),R=f(!0),m=f({plan:null,elements:[]}),E=f(!1),it=f([]),$=f("");function ut(s){if(!s)return s;const t=Number(s.isActive??s.is_active??1);return{...s,isActive:t}}const B=async()=>{R.value=!0;try{const{data:s}=await C.get(`/api/plans/${c.params.id}`,{withCredentials:!0}),t=ut(s.plan??null);m.value={plan:t,elements:Array.isArray(s.elements)?s.elements:s.elements||[]}}finally{R.value=!1}},W=async()=>{$.value&&(await C.post(`/api/plans/${c.params.id}/elements`,{elementId:Number($.value)},{withCredentials:!0}),E.value=!1,await B())},N=f(!1),j=f([]),x=f(""),L=f([]),rt=async()=>{const{data:s}=await C.get("/api/computations",{withCredentials:!0});j.value=Array.isArray(s)?s:s.computations||[]},T=async()=>{const{data:s}=await C.get(`/api/plans/${c.params.id}/computations`,{withCredentials:!0});L.value=Array.isArray(s)?s:s.computations||[]},dt=()=>{x.value="",N.value=!0},G=async()=>{x.value&&(await C.post(`/api/plans/${c.params.id}/computations`,{computationId:Number(x.value)},{withCredentials:!0}),N.value=!1,await T())},pt=async s=>{confirm("Remove this computation from the plan?")&&(await C.delete(`/api/plans/${c.params.id}/computations/${s}`,{withCredentials:!0}),await T())};f(!1),f({run:null,results:[]});const mt=async()=>{},P=f({loading:!0,participants:[]}),U=async()=>{P.value.loading=!0;try{const{data:s}=await C.get(`/api/plans/${c.params.id}/payout-run-summary`,{withCredentials:!0});P.value.participants=(s==null?void 0:s.participants)||[]}finally{P.value.loading=!1}},I=f(!1),ft=async()=>{var s,t,v,n,_,k;if(confirm("This will purge and regenerate payouts for this plan from attached computations. Continue?")){I.value=!0;try{const{data:d}=await C.post(`/api/plans/${c.params.id}/run-computations`,{},{withCredentials:!0});alert(`Computations complete: inserted ${d.inserted} rows${(s=d.errors)!=null&&s.length?`; ${d.errors.length} errors`:""}. ${(t=d.errors)!=null&&t.length?`; ${d.errors[0].error}`:""}`),await U()}catch(d){console.error(d),alert(((n=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:n.detail)||((k=(_=d==null?void 0:d.response)==null?void 0:_.data)==null?void 0:k.error)||"Run computations failed")}finally{I.value=!1}}},h=f(!1),w=Ct(()=>{var s,t,v,n;return Number(((t=(s=m.value)==null?void 0:s.plan)==null?void 0:t.isActive)??((n=(v=m.value)==null?void 0:v.plan)==null?void 0:n.is_active)??1)===1}),vt=async()=>{var v,n,_,k,d,D;if(!((n=(v=m.value)==null?void 0:v.plan)!=null&&n.id))return;const s=w.value?0:1,t=w.value?"Archive this plan?":"Unarchive this plan?";if(confirm(t)){h.value=!0;try{await C.patch(`/api/plans/${c.params.id}/active`,{isActive:s},{withCredentials:!0}),m.value.plan.isActive=s,m.value.plan.is_active=s}catch(A){console.error(A),alert(((k=(_=A==null?void 0:A.response)==null?void 0:_.data)==null?void 0:k.detail)||((D=(d=A==null?void 0:A.response)==null?void 0:d.data)==null?void 0:D.error)||"Update failed")}finally{h.value=!1}}};yt(async()=>{await Promise.all([B(),rt(),T(),U()])}),bt(()=>c.params.id,async()=>{await Promise.all([B(),T(),mt(),U()])});const _t=s=>(Number.isFinite(Number(s))?Number(s):0).toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}),ct=s=>s?new Date(s).toLocaleString():"—";return(s,t)=>{const v=wt("router-link");return i(),u("div",xt,[R.value?(i(),u("div",Pt,[l(e(lt))])):m.value.plan?(i(),u("div",Nt,[l(e(O),{class:"mb-3"},{default:a(()=>[l(e(H),{class:"fw-semibold d-flex align-items-center justify-content-between gap-2 flex-wrap"},{default:a(()=>{var n,_,k,d,D;return[p("div",Dt,[p("span",null," Plan: "+r(((_=(n=m.value.plan)==null?void 0:n.name)==null?void 0:_.trim())||"#"+(((k=m.value.plan)==null?void 0:k.id)??"—"))+" (v"+r(((D=(d=m.value.plan)==null?void 0:d.version)==null?void 0:D.trim())||"—")+") ",1),p("span",{class:gt(["badge",w.value?"text-bg-success":"text-bg-secondary"]),title:w.value?"Active":"Archived"},r(w.value?"Active":"Archived"),11,Et)]),p("div",Tt,[l(v,{class:"btn btn-sm btn-outline-primary",to:{name:"PlanEdit",params:{id:m.value.plan.id}}},{default:a(()=>t[6]||(t[6]=[o("Edit",-1)])),_:1,__:[6]},8,["to"]),l(e(y),{color:"secondary",size:"sm",onClick:dt},{default:a(()=>t[7]||(t[7]=[o("Add Computation",-1)])),_:1,__:[7]}),l(e(y),{color:"info",size:"sm",disabled:I.value,onClick:ft},{default:a(()=>[I.value?(i(),u("span",It,"Running…")):(i(),u("span",ht,"Run Computations"))]),_:1},8,["disabled"]),l(e(y),{color:w.value?"warning":"success",size:"sm",disabled:h.value,onClick:vt,title:w.value?"Archive (set inactive)":"Unarchive (set active)"},{default:a(()=>[h.value?(i(),u("span",Mt,"Saving…")):(i(),u("span",Vt,r(w.value?"Archive":"Unarchive"),1))]),_:1},8,["color","disabled","title"])])]}),_:1}),l(e(z),null,{default:a(()=>[l(e(St),{class:"mb-2"},{default:a(()=>[l(e(q),{md:"3"},{default:a(()=>[t[8]||(t[8]=p("strong",null,"Payout:",-1)),o(" "+r(m.value.plan.payoutFrequency||"—"),1)]),_:1,__:[8]}),l(e(q),{md:"3"},{default:a(()=>[t[9]||(t[9]=p("strong",null,"Effective Start:",-1)),o(" "+r(new Date(m.value.plan.effectiveStart).toISOString().split("T")[0]||"—"),1)]),_:1,__:[9]}),l(e(q),{md:"3"},{default:a(()=>[t[10]||(t[10]=p("strong",null,"Effective End:",-1)),o(" "+r(new Date(m.value.plan.effectiveEnd).toISOString().split("T")[0]||"—"),1)]),_:1,__:[10]})]),_:1}),m.value.plan.description?(i(),u("div",Ft,r(m.value.plan.description),1)):kt("",!0)]),_:1})]),_:1}),l(e(O),{class:"mt-3"},{default:a(()=>[l(e(H),{class:"fw-semibold"},{default:a(()=>t[11]||(t[11]=[o("Computations",-1)])),_:1,__:[11]}),l(e(z),null,{default:a(()=>[L.value.length?(i(),M(e(ot),{key:0,hover:"",responsive:""},{default:a(()=>[l(e(nt),null,{default:a(()=>[l(e(F),null,{default:a(()=>[l(e(b),null,{default:a(()=>t[12]||(t[12]=[o("Name",-1)])),_:1,__:[12]}),l(e(b),null,{default:a(()=>t[13]||(t[13]=[o("Scope",-1)])),_:1,__:[13]}),l(e(b),null,{default:a(()=>t[14]||(t[14]=[o("Template",-1)])),_:1,__:[14]}),l(e(b),null,{default:a(()=>t[15]||(t[15]=[o("Actions",-1)])),_:1,__:[15]})]),_:1})]),_:1}),l(e(st),null,{default:a(()=>[(i(!0),u(S,null,V(L.value,n=>(i(),M(e(F),{key:n.id},{default:a(()=>[l(e(g),{class:"fw-semibold"},{default:a(()=>[l(e(y),{color:"warning"},{default:a(()=>[l(v,{to:{name:"ComputationEdit",params:{id:n.id}},class:"text-decoration-none",title:`Edit ${n.name}`},{default:a(()=>[o(r(n.name),1)]),_:2},1032,["to","title"])]),_:2},1024)]),_:2},1024),l(e(g),null,{default:a(()=>[p("span",Rt,r(n.scope==="plan"?"Entire Plan Window":"Per Payout Period"),1)]),_:2},1024),l(e(g),{class:"text-truncate",style:{"max-width":"420px"}},{default:a(()=>[n.template?(i(),u("code",Bt,r(n.template),1)):(i(),u("span",Lt,"—"))]),_:2},1024),l(e(g),null,{default:a(()=>[l(e(y),{size:"sm",color:"danger",onClick:_=>pt(n.id)},{default:a(()=>t[16]||(t[16]=[o("Remove",-1)])),_:2,__:[16]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(i(),u("div",Ut,"No computations attached yet."))]),_:1})]),_:1}),l(e(O),{class:"mt-3"},{default:a(()=>[l(e(H),{class:"fw-semibold"},{default:a(()=>t[17]||(t[17]=[o("Calculations (Latest Run)",-1)])),_:1,__:[17]}),l(e(z),null,{default:a(()=>[p("div",zt,[t[23]||(t[23]=p("h6",{class:"mb-2"},"Participants with payouts (latest computations run)",-1)),P.value.loading?(i(),u("div",Ot,[l(e(lt))])):(i(),u(S,{key:1},[P.value.participants.length?(i(),M(e(ot),{key:1,hover:"",responsive:"",small:""},{default:a(()=>[l(e(nt),null,{default:a(()=>[l(e(F),null,{default:a(()=>[l(e(b),null,{default:a(()=>t[18]||(t[18]=[o("Participant",-1)])),_:1,__:[18]}),l(e(b),null,{default:a(()=>t[19]||(t[19]=[o("Total Amount",-1)])),_:1,__:[19]}),l(e(b),null,{default:a(()=>t[20]||(t[20]=[o("Lines",-1)])),_:1,__:[20]}),l(e(b),null,{default:a(()=>t[21]||(t[21]=[o("Period Window",-1)])),_:1,__:[21]}),l(e(b),null,{default:a(()=>t[22]||(t[22]=[o("Last Updated",-1)])),_:1,__:[22]})]),_:1})]),_:1}),l(e(st),null,{default:a(()=>[(i(!0),u(S,null,V(P.value.participants,n=>(i(),M(e(F),{key:n.participantId,onClick:_=>s.$router.push({name:"ParticipantDetail",params:{id:n.participantId}}),style:{cursor:"pointer"}},{default:a(()=>[l(e(g),null,{default:a(()=>[n.firstName||n.lastName?(i(),u(S,{key:0},[o(r(n.firstName)+" "+r(n.lastName),1)],64)):(i(),u(S,{key:1},[o("#"+r(n.participantId),1)],64))]),_:2},1024),l(e(g),null,{default:a(()=>[p("strong",null,r(_t(n.totalAmount)),1)]),_:2},1024),l(e(g),null,{default:a(()=>[o(r(n.lines??n.lineCount),1)]),_:2},1024),l(e(g),null,{default:a(()=>[o(r(new Date(n.firstPeriodStart).toISOString().split("T")[0])+" → "+r(new Date(n.lastPeriodEnd).toISOString().split("T")[0]),1)]),_:2},1024),l(e(g),null,{default:a(()=>[o(r(ct(n.lastCreatedAt)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})):(i(),u("div",Ht,"No payouts found for the latest run."))],64))])]),_:1})]),_:1}),l(e(at),{visible:E.value,onClose:t[2]||(t[2]=n=>E.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(Y),null,{default:a(()=>[l(e(Z),null,{default:a(()=>t[24]||(t[24]=[o("Add Existing Element",-1)])),_:1,__:[24]})]),_:1}),l(e(tt),null,{default:a(()=>[l(e(Q),{onSubmit:J(W,["prevent"])},{default:a(()=>[p("div",qt,[l(e(K),null,{default:a(()=>t[25]||(t[25]=[o("Choose an existing element definition",-1)])),_:1,__:[25]}),l(e(X),{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=n=>$.value=n)},{default:a(()=>[t[26]||(t[26]=p("option",{value:"",disabled:""},"Select an element…",-1)),(i(!0),u(S,null,V(it.value,n=>(i(),u("option",{key:n.id,value:n.id},r(n.name),9,Wt))),128))]),_:1,__:[26]},8,["modelValue"])]),t[27]||(t[27]=p("div",{class:"text-muted"},[o("Don’t see it? Create it in "),p("strong",null,"Add Plan Element"),o(", then come back.")],-1))]),_:1,__:[27]})]),_:1}),l(e(et),null,{default:a(()=>[l(e(y),{color:"secondary",onClick:t[1]||(t[1]=n=>E.value=!1)},{default:a(()=>t[28]||(t[28]=[o("Cancel",-1)])),_:1,__:[28]}),l(e(y),{color:"primary",onClick:W,disabled:!$.value},{default:a(()=>t[29]||(t[29]=[o("Attach",-1)])),_:1,__:[29]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(at),{visible:N.value,onClose:t[5]||(t[5]=n=>N.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(Y),null,{default:a(()=>[l(e(Z),null,{default:a(()=>t[30]||(t[30]=[o("Add Computation",-1)])),_:1,__:[30]})]),_:1}),l(e(tt),null,{default:a(()=>[l(e(Q),{onSubmit:J(G,["prevent"])},{default:a(()=>[p("div",jt,[l(e(K),null,{default:a(()=>t[31]||(t[31]=[o("Choose a computation",-1)])),_:1,__:[31]}),l(e(X),{modelValue:x.value,"onUpdate:modelValue":t[3]||(t[3]=n=>x.value=n)},{default:a(()=>[t[32]||(t[32]=p("option",{value:"0"},"Select a computation…",-1)),(i(!0),u(S,null,V(j.value,n=>(i(),u("option",{key:n.id,value:n.id},r(n.name)+" ("+r(n.scope==="plan"?"Plan":"Payout")+") ",9,Gt))),128))]),_:1,__:[32]},8,["modelValue"])])]),_:1})]),_:1}),l(e(et),null,{default:a(()=>[l(e(y),{color:"secondary",onClick:t[4]||(t[4]=n=>N.value=!1)},{default:a(()=>t[33]||(t[33]=[o("Cancel",-1)])),_:1,__:[33]}),l(e(y),{color:"primary",onClick:G,disabled:!x.value},{default:a(()=>t[34]||(t[34]=[o("Attach",-1)])),_:1,__:[34]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(i(),u("div",$t,"Not found."))])}}};export{ne as default};
