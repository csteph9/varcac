import{r as i,n as T,c as J,a as o,b as r,u as l,h as Q,e as n,C as W,l as w,f as h,d as t,t as R,m as S,s as V,p as U,i as L,k as p}from"./index-DPzvZzfM.js";import{C as j}from"./CAlert-HWKGY5e-.js";import{C as O}from"./CButton-CxoqXei-.js";import{C as X}from"./CCardHeader-CyVR9a-w.js";import{C as z}from"./CForm-23VFcb4J.js";import{C as G}from"./CFormCheck-DQs4Swf6.js";import{C as K}from"./CFormInput-BuocEiCo.js";import{a as I,C as Z}from"./CRow-VS3LaBfk.js";import{C as q}from"./CSpinner-4RQXIVOv.js";const ee={class:"p-3"},ae={class:"mb-4"},le={class:"mb-4"},te={class:"mb-3"},se={class:"mb-2"},oe={class:"mb-3",style:{"max-width":"360px"}},re={class:"mb-2"},ne={class:"mb-3",style:{"max-width":"360px"}},Ce={__name:"Admin",setup(ue){const _=i(!1),g=i(!1),x=i(!1),m=i(""),d=i(""),f=i(!1),v=i(""),A=i(null),b=i(null),y=i(!1),C=i("");function P(u){var e,a;b.value=((a=(e=u==null?void 0:u.target)==null?void 0:e.files)==null?void 0:a[0])??null}function $(u=""){const e=String(u||"");let a=e.match(/filename\*=(?:UTF-8'')?([^;]+)/i);return a&&a[1]?decodeURIComponent(a[1].replace(/(^"|"$)/g,"")).trim():(a=e.match(/filename=([^;]+)/i),a&&a[1]?a[1].replace(/(^"|"$)/g,"").trim():"varcac_db_backup.varcac")}const F=T(()=>f.value&&v.value.trim()==="ERASE"),E=T(()=>!!b.value),H=T(()=>F.value&&E.value&&!g.value),B=T(()=>y.value&&C.value.trim()==="FACTORY"),Y=async()=>{var u,e;m.value="",d.value="",_.value=!0;try{const a=await L.get("/api/admin/backup",{responseType:"blob",withCredentials:!0,transformResponse:[M=>M]}),c=new Blob([a.data],{type:a.headers["content-type"]||"application/octet-stream"}),s=window.URL.createObjectURL(c),k=document.createElement("a");k.href=s,k.download=$(a.headers["content-disposition"]),document.body.appendChild(k),k.click(),k.remove(),window.URL.revokeObjectURL(s),m.value="Backup generated."}catch(a){console.error(a),d.value=((e=(u=a==null?void 0:a.response)==null?void 0:u.data)==null?void 0:e.error)||"Backup failed"}finally{_.value=!1}},D=async()=>{var u,e,a,c;if(m.value="",d.value="",!b.value){d.value="Please choose a backup file.";return}if(!F.value){d.value="Please confirm by checking the box and typing ERASE.";return}g.value=!0;try{const s=new FormData;s.append("dump",b.value),s.append("confirm",v.value),await L.post("/api/admin/restore",s,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"}}),m.value="Restore complete.",v.value="",f.value=!1,b.value=null,A.value&&(A.value.value="")}catch(s){console.error(s),d.value=((e=(u=s==null?void 0:s.response)==null?void 0:u.data)==null?void 0:e.detail)||((c=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:c.error)||"Restore failed"}finally{g.value=!1}},N=async()=>{var u,e,a,c;if(m.value="",d.value="",!B.value){d.value="Check the box and type FACTORY to confirm.";return}x.value=!0;try{await L.post("/api/admin/factory-reset",{confirm:C.value},{withCredentials:!0}),m.value="Factory reset complete. The app has been reinitialized from db_init.sql.",C.value="",y.value=!1}catch(s){console.error(s),d.value=((e=(u=s==null?void 0:s.response)==null?void 0:u.data)==null?void 0:e.detail)||((c=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:c.error)||"Factory reset failed"}finally{x.value=!1}};return(u,e)=>(p(),J("div",ee,[o(l(Z),{class:"g-4"},{default:r(()=>[o(l(I),{md:"12"},{default:r(()=>[o(l(Q),null,{default:r(()=>[o(l(X),{class:"fw-semibold"},{default:r(()=>e[4]||(e[4]=[n("Admin · Database Backup & Restore",-1)])),_:1,__:[4]}),o(l(W),null,{default:r(()=>[m.value?(p(),w(l(j),{key:0,color:"success",class:"mb-3"},{default:r(()=>[n(R(m.value),1)]),_:1})):h("",!0),d.value?(p(),w(l(j),{key:1,color:"danger",class:"mb-3"},{default:r(()=>[n(R(d.value),1)]),_:1})):h("",!0),t("div",ae,[e[8]||(e[8]=t("h6",{class:"mb-3"},"Backup",-1)),o(l(z),{class:"row gy-2 gx-3 align-items-end",onSubmit:S(Y,["prevent"])},{default:r(()=>[o(l(I),{md:"4"},{default:r(()=>[o(l(V),null,{default:r(()=>e[5]||(e[5]=[n("Generate database backup",-1)])),_:1,__:[5]}),e[6]||(e[6]=t("p",{class:"text-muted mb-2"},[n(" The file name is set by the server and ends with "),t("code",null,".varcac"),n(". ")],-1))]),_:1,__:[6]}),o(l(I),{md:"3"},{default:r(()=>[o(l(O),{disabled:_.value,color:"primary",class:"mt-3",onClick:Y},{default:r(()=>[_.value?(p(),w(l(q),{key:0,size:"sm",class:"me-2"})):h("",!0),e[7]||(e[7]=n(" Generate Backup ",-1))]),_:1,__:[7]},8,["disabled"])]),_:1})]),_:1})]),e[18]||(e[18]=t("hr",{class:"my-4"},null,-1)),t("div",le,[e[12]||(e[12]=t("h6",{class:"mb-3"},"Restore",-1)),e[13]||(e[13]=t("p",{class:"text-danger small mb-3"}," ⚠️ Restoring will overwrite the current database with the contents of your backup file. ",-1)),o(l(z),{onSubmit:S(D,["prevent"])},{default:r(()=>[t("div",te,[o(l(V),null,{default:r(()=>e[9]||(e[9]=[n("Backup file",-1)])),_:1,__:[9]}),t("input",{ref_key:"fileInput",ref:A,class:"form-control",type:"file",accept:".varcac,.sql,application/octet-stream,application/sql,text/sql",onChange:P},null,544),t("div",{class:U(["form-text",{"text-danger":!E.value}])},R(E.value?"File ready.":"Choose the backup file you downloaded earlier."),3)]),t("div",se,[o(l(G),{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=a=>f.value=a),checked:f.value,label:"I understand this will permanently overwrite the database."},null,8,["modelValue","checked"])]),t("div",oe,[o(l(V),null,{default:r(()=>e[10]||(e[10]=[n("Type ",-1),t("code",null,"ERASE",-1),n(" to enable Restore",-1)])),_:1,__:[10]}),o(l(K),{modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=a=>v.value=a),placeholder:"ERASE"},null,8,["modelValue"]),t("div",{class:U(["form-text",{"text-danger":!F.value}])},R(F.value?"Ready.":"Check the box and type ERASE (all caps)."),3)]),o(l(O),{disabled:!H.value,color:"danger",onClick:D},{default:r(()=>[g.value?(p(),w(l(q),{key:0,size:"sm",class:"me-2"})):h("",!0),e[11]||(e[11]=n(" Restore from Backup ",-1))]),_:1,__:[11]},8,["disabled"])]),_:1})]),e[19]||(e[19]=t("hr",{class:"my-4"},null,-1)),t("div",null,[e[16]||(e[16]=t("h6",{class:"mb-3"},"Factory reset",-1)),e[17]||(e[17]=t("p",{class:"text-danger small mb-3"},[n(" ⚠️ This wipes ALL data, drops and recreates the database, and re-runs "),t("code",null,"db_init.sql"),n(". Use only if you want a clean, first-install state. ")],-1)),o(l(z),{onSubmit:S(N,["prevent"])},{default:r(()=>[t("div",re,[o(l(G),{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=a=>y.value=a),checked:y.value,label:"I understand this permanently erases ALL data and reinitializes the schema and seed data."},null,8,["modelValue","checked"])]),t("div",ne,[o(l(V),null,{default:r(()=>e[14]||(e[14]=[n("Type ",-1),t("code",null,"FACTORY",-1),n(" to enable Factory reset",-1)])),_:1,__:[14]}),o(l(K),{modelValue:C.value,"onUpdate:modelValue":e[3]||(e[3]=a=>C.value=a),placeholder:"FACTORY"},null,8,["modelValue"]),t("div",{class:U(["form-text",{"text-danger":!B.value}])},R(B.value?"Ready.":"Check the box and type FACTORY (all caps)."),3)]),o(l(O),{disabled:!B.value||x.value,color:"dark",onClick:N},{default:r(()=>[x.value?(p(),w(l(q),{key:0,size:"sm",class:"me-2"})):h("",!0),e[15]||(e[15]=n(" Factory reset ",-1))]),_:1,__:[15]},8,["disabled"])]),_:1})])]),_:1,__:[18,19]})]),_:1})]),_:1})]),_:1})]))}};export{Ce as default};
