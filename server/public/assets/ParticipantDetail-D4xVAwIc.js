import{r as m,v as U,o as At,m as $t,c as i,a as l,u as e,w as a,b as d,e as o,t as r,R as dt,q as Lt,C as H,g as j,F as _,f as y,k as V,d as k,p as rt,h as S,i as Nt,j as n,x as lt}from"./index-CnunvlPX.js";import{C as Tt}from"./CBadge-CNpeMTC9.js";import{C as c}from"./CButton-9cLZnGML.js";import{C as O}from"./CCardHeader-DkwIvcvh.js";import{C as Vt}from"./CForm-CUoL1i_i.js";import{C as Ft}from"./CFormInput-BDjYtHKv.js";import{C as pt}from"./CFormSelect-CLsNpwKL.js";import{C as Mt,a as at}from"./CRow-D6jC7U_a.js";import{C as G,a as Y,b as h,c as J,d as K}from"./CModalTitle-NL5vIw4_.js";import{C as F}from"./CSpinner-B8MQGp8p.js";import{a as mt,b as Q,c as g,d as ft,C as vt,e as w}from"./CTable-BOI4YO2C.js";const Et={class:"p-3"},zt={key:0,class:"py-3"},Rt={key:1},Bt={key:2},qt={class:"text-muted small"},Ut={class:"d-flex gap-2"},Ht={key:0},jt={key:0,class:"text-muted"},Ot={key:1},Gt={class:"d-flex flex-wrap"},Yt={class:"mb-1"},ht={class:"text-muted"},Jt={class:"d-flex flex-wrap mb-2"},Kt={key:0,class:"text-muted"},Qt={key:0},Wt={class:"mt-2 mb-0"},Xt={class:"ms-2"},Zt={key:0,class:"text-muted"},te={key:1,class:"text-muted"},ee={key:0},le={key:1},ae={key:0,class:"text-muted"},se={class:"d-flex align-items-center mb-2"},ne={class:"me-2"},oe={key:0,class:"text-muted"},ie={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},ue={class:"me-2"},de={class:"text-muted ms-2"},re={class:"mb-3"},pe=["value"],me={key:0,class:"text-danger mt-2"},fe={style:{"white-space":"pre-wrap","word-break":"break-word",margin:"0"}},ve={key:0,class:"text-muted"},_e={key:1,class:"d-flex flex-column gap-2"},ye=["value","disabled"],st="badge rounded-pill text-bg-secondary me-2 mb-2",$e={__name:"ParticipantDetail",setup(ce){const C=Lt(),_t=Nt(),W=m(!0),b=m({participant:null,plans:[]}),X=m(""),A=m(!1),nt=m([]),P=m(""),D=m({loading:!0,plans:[]}),x=m({loading:!0,allInputs:[],plans:[]}),Z=m(!1),yt=m(""),ct=m(""),M=m(!1),E=m(!1),z=m(""),$=m(!1),I=m(!1),L=m(new Set),ot=U({get:()=>[...L.value],set:u=>{L.value=new Set(u.map(Number).filter(t=>Number.isFinite(t)))}}),bt=U(()=>Math.min(10,Math.max(4,tt.value.length))),it=u=>{const t=Number(u??0);return Number.isFinite(t)?t.toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}):"â€”"},N=U(()=>{var t;return(((t=b.value)==null?void 0:t.plans)||[]).map(s=>{var p;return{...s,planId:s.planId??s.plan_id??((p=s.plan)==null?void 0:p.id)??s.cpId??s.cid??null}}).filter(s=>s.planId)}),tt=U(()=>{const u=(X.value||"").toLowerCase().trim();return u?N.value.filter(t=>String(t.name||"").toLowerCase().includes(u)||String(t.version||"").toLowerCase().includes(u)):N.value}),R=async()=>{var u;W.value=!0;try{const{data:t}=await S.get(`/api/participants/${C.params.id}`,{withCredentials:!0}),s=Array.isArray(t.plans)?t.plans:[];for(const p of s)p.planId=p.planId??p.plan_id??((u=p.plan)==null?void 0:u.id)??p.cpId??p.cid??null;b.value={participant:t.participant??null,plans:s}}finally{W.value=!1}},Ct=async()=>{const{data:u}=await S.get("/api/plans",{withCredentials:!0});nt.value=u||[]},B=async()=>{D.value.loading=!0;try{const{data:u}=await S.get(`/api/participants/${C.params.id}/payout-history`,{withCredentials:!0});D.value.plans=(u==null?void 0:u.plans)||[]}finally{D.value.loading=!1}},q=async()=>{x.value.loading=!0;try{const{data:u}=await S.get(`/api/participants/${C.params.id}/required-source-inputs`,{withCredentials:!0});x.value={loading:!1,allInputs:Array.isArray(u==null?void 0:u.allInputs)?u.allInputs:[],plans:Array.isArray(u==null?void 0:u.plans)?u.plans:[]}}catch(u){console.error(u),x.value={loading:!1,allInputs:[],plans:[]}}};At(async()=>{await Promise.all([R(),Ct(),B(),q()])}),$t(()=>C.params.id,async()=>{await Promise.all([R(),B(),q()])});const gt=()=>{P.value="",A.value=!0},wt=async()=>{P.value&&(await S.post(`/api/participants/${C.params.id}/plans`,{planId:Number(P.value)},{withCredentials:!0}),A.value=!1,await Promise.all([R(),B(),q()]))},kt=async u=>{confirm("Detach this plan from the participant? All historical calculations will be removed.")&&(await S.delete(`/api/participants/${C.params.id}/plans/${u}`,{withCredentials:!0}),await Promise.all([R(),B(),q()]))},St=()=>{z.value="",M.value=!0},xt=async()=>{var u,t;E.value=!0;try{await S.delete(`/api/participants/${C.params.id}`,{withCredentials:!0}),_t.push({name:"ParticipantsList"})}catch(s){console.error(s),z.value=((t=(u=s==null?void 0:s.response)==null?void 0:u.data)==null?void 0:t.error)||"Failed to delete"}finally{E.value=!1}},It=async()=>{var t,s,p,f;if(!L.value.size)return;const u=Array.from(L.value);I.value=!0;try{const{data:v}=await S.post(`/api/participants/${C.params.id}/comp-statement`,{planIds:u},{withCredentials:!0,responseType:"blob"}),Pt=new Blob([v],{type:"application/html"}),ut=URL.createObjectURL(Pt),T=document.createElement("a"),et=new Date,Dt=`${et.getFullYear()}-${String(et.getMonth()+1).padStart(2,"0")}-${String(et.getDate()).padStart(2,"0")}`;T.href=ut,T.download=`CompStatement_${((s=(t=b.value)==null?void 0:t.participant)==null?void 0:s.lastName)??"Participant"}_${Dt}.html`,document.body.appendChild(T),T.click(),T.remove(),URL.revokeObjectURL(ut),$.value=!1}catch(v){console.error(v),alert(((f=(p=v==null?void 0:v.response)==null?void 0:p.data)==null?void 0:f.error)||(v==null?void 0:v.message)||"Failed to generate statement")}finally{I.value=!1}};return(u,t)=>(n(),i("div",Et,[W.value?(n(),i("div",zt,[l(e(F))])):b.value.participant?(n(),i("div",Bt,[l(e(j),{class:"mb-3"},{default:a(()=>[l(e(O),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:a(()=>[d("span",null,[o(" Participant: "+r(b.value.participant.firstName)+" "+r(b.value.participant.lastName)+" ",1),d("span",qt,"(#"+r(b.value.participant.id)+")",1)]),d("div",Ut,[l(e(dt),{class:"btn btn-primary",to:{name:"ParticipantEdit",params:{id:e(C).params.id}}},{default:a(()=>t[12]||(t[12]=[o("Edit",-1)])),_:1,__:[12]},8,["to"]),l(e(c),{color:"danger",variant:"outline",onClick:St},{default:a(()=>t[13]||(t[13]=[o("Delete",-1)])),_:1,__:[13]}),l(e(c),{color:"primary",size:"sm",onClick:gt},{default:a(()=>t[14]||(t[14]=[o("Attach Plan",-1)])),_:1,__:[14]}),l(e(c),{color:"warning",size:"sm",onClick:t[0]||(t[0]=s=>$.value=!0)},{default:a(()=>t[15]||(t[15]=[o("Comp Statement",-1)])),_:1,__:[15]})])]),_:1}),l(e(H),null,{default:a(()=>[l(e(Mt),null,{default:a(()=>[l(e(at),{md:"4"},{default:a(()=>[t[16]||(t[16]=d("strong",null,"Email:",-1)),o(" "+r(b.value.participant.email),1)]),_:1,__:[16]}),l(e(at),{md:"4"},{default:a(()=>[t[17]||(t[17]=d("strong",null,"ID:",-1)),o(" "+r(b.value.participant.id),1)]),_:1,__:[17]}),l(e(at),{md:"4"},{default:a(()=>[t[18]||(t[18]=d("strong",null,"Created:",-1)),o(" "+r(new Date(b.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[18]})]),_:1})]),_:1})]),_:1}),l(e(j),{class:"mb-3"},{default:a(()=>[l(e(O),{class:"fw-semibold"},{default:a(()=>t[19]||(t[19]=[o("Required Source Data Inputs",-1)])),_:1,__:[19]}),l(e(H),null,{default:a(()=>[x.value.loading?(n(),i("div",Ht,[l(e(F))])):(n(),i(_,{key:1},[x.value.allInputs.length?(n(),i("div",Ot,[t[21]||(t[21]=d("h6",{class:"mb-2"},"All required labels for this participant",-1)),d("div",Gt,[(n(!0),i(_,null,y(x.value.allInputs,s=>(n(),i("span",{key:"all-"+s,class:lt(st)},r(s),1))),128))]),t[22]||(t[22]=d("hr",{class:"my-3"},null,-1)),t[23]||(t[23]=d("h6",{class:"mb-2"},"By plan",-1)),(n(!0),i(_,null,y(x.value.plans,s=>{var p;return n(),i("div",{key:s.planId,class:"mb-3"},[d("div",Yt,[d("strong",null,r(s.planName),1),d("span",ht," (v"+r(s.planVersion)+")",1)]),d("div",Jt,[s.inputs.length?k("",!0):(n(),i("span",Kt,"No labels required.")),(n(!0),i(_,null,y(s.inputs,f=>(n(),i("span",{key:s.planId+"-"+f,class:lt(st)},r(f),1))),128))]),(p=s.computations)!=null&&p.length?(n(),i("details",Qt,[t[20]||(t[20]=d("summary",{class:"small text-muted"},"Show computations",-1)),d("ul",Wt,[(n(!0),i(_,null,y(s.computations,f=>(n(),i("li",{key:f.id},[d("strong",null,r(f.name),1),d("span",Xt,[f.inputs.length?k("",!0):(n(),i("span",Zt,"(no labels)")),(n(!0),i(_,null,y(f.inputs,v=>(n(),i("span",{key:f.id+"-"+v,class:lt(st)},r(v),1))),128))])]))),128))])])):k("",!0)])}),128))])):(n(),i("div",jt," No source data requirements detected for this participantâ€™s attached plans. "))],64))]),_:1})]),_:1}),l(e(j),null,{default:a(()=>[l(e(O),{class:"fw-semibold"},{default:a(()=>t[24]||(t[24]=[o("Attached Plans",-1)])),_:1,__:[24]}),l(e(H),null,{default:a(()=>[N.value.length?(n(),V(e(vt),{key:0,hover:"",responsive:""},{default:a(()=>[l(e(mt),null,{default:a(()=>[l(e(Q),null,{default:a(()=>[l(e(g),null,{default:a(()=>t[25]||(t[25]=[o("Name",-1)])),_:1,__:[25]}),l(e(g),null,{default:a(()=>t[26]||(t[26]=[o("Version",-1)])),_:1,__:[26]}),l(e(g),null,{default:a(()=>t[27]||(t[27]=[o("Plan Effective",-1)])),_:1,__:[27]}),l(e(g),null,{default:a(()=>t[28]||(t[28]=[o("Attached",-1)])),_:1,__:[28]}),l(e(g),null,{default:a(()=>t[29]||(t[29]=[o("Actions",-1)])),_:1,__:[29]})]),_:1})]),_:1}),l(e(ft),null,{default:a(()=>[(n(!0),i(_,null,y(N.value,s=>(n(),V(e(Q),{key:s.planId},{default:a(()=>[l(e(w),null,{default:a(()=>[o(r(s.name),1)]),_:2},1024),l(e(w),null,{default:a(()=>[o("v"+r(s.version),1)]),_:2},1024),l(e(w),null,{default:a(()=>[o(r(s.planEffectiveStart||"â€”")+" â†’ "+r(s.planEffectiveEnd||"â€”"),1)]),_:2},1024),l(e(w),null,{default:a(()=>[o(r(new Date(s.attachedAt).toLocaleString()),1)]),_:2},1024),l(e(w),null,{default:a(()=>[l(e(c),{color:"secondary",size:"sm",onClick:p=>kt(s.planId)},{default:a(()=>t[30]||(t[30]=[o("Detach",-1)])),_:2,__:[30]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(n(),i("div",te,"No plans attached yet."))]),_:1})]),_:1}),l(e(j),{class:"mt-3"},{default:a(()=>[l(e(O),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:a(()=>[t[32]||(t[32]=d("span",null,"Payout History (by Plan & Period)",-1)),l(e(dt),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:a(()=>t[31]||(t[31]=[o("View Plans",-1)])),_:1,__:[31]})]),_:1,__:[32]}),l(e(H),null,{default:a(()=>[D.value.loading?(n(),i("div",ee,[l(e(F))])):(n(),i("div",le,[D.value.plans.length?k("",!0):(n(),i("div",ae,"No payout history yet.")),(n(!0),i(_,null,y(D.value.plans,s=>(n(),i("div",{key:s.planId,class:"mb-4"},[d("div",se,[d("strong",ne,r(s.planName),1),l(e(Tt),{color:"secondary",class:"me-2"},{default:a(()=>[o("v"+r(s.planVersion),1)]),_:2},1024)]),l(e(vt),{hover:"",responsive:"",small:""},{default:a(()=>[l(e(mt),null,{default:a(()=>[l(e(Q),null,{default:a(()=>[l(e(g),{style:{"min-width":"120px"}},{default:a(()=>t[33]||(t[33]=[o("Period",-1)])),_:1,__:[33]}),l(e(g),{style:{"min-width":"120px"}},{default:a(()=>t[34]||(t[34]=[o("Period End Date",-1)])),_:1,__:[34]}),l(e(g),{style:{"min-width":"160px","text-align":"center"}},{default:a(()=>t[35]||(t[35]=[o("Total Payout",-1)])),_:1,__:[35]}),l(e(g),null,{default:a(()=>t[36]||(t[36]=[o("Computations",-1)])),_:1,__:[36]})]),_:1})]),_:1}),l(e(ft),null,{default:a(()=>[(n(!0),i(_,null,y(s.periods,p=>(n(),V(e(Q),{key:p.periodStart+"|"+p.periodEnd+"|"+(p.periodLabel||"")},{default:a(()=>[l(e(w),null,{default:a(()=>[d("div",null,[o(r(new Date(p.periodStart).toISOString().split("T")[0])+" â­¾ ",1),t[37]||(t[37]=d("br",null,null,-1)),o(r(new Date(p.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),l(e(w),null,{default:a(()=>[o(r(new Date(p.dueDate).toISOString().split("T")[0]),1),t[38]||(t[38]=d("br",null,null,-1)),p.periodLabel?(n(),i("small",oe,r(p.periodLabel),1)):k("",!0)]),_:2,__:[38]},1024),l(e(w),{style:{"text-align":"center"}},{default:a(()=>[d("strong",null,r(it(p.total)),1)]),_:2},1024),l(e(w),null,{default:a(()=>[d("ul",ie,[(n(!0),i(_,null,y(p.lines,(f,v)=>(n(),i("li",{key:f.outputLabel+"|"+v},[d("span",ue,r(f.outputLabel),1),d("strong",null,r(it(f.amount)),1),d("small",de,r(new Date(f.createdAt).toLocaleString()),1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),l(e(K),{visible:A.value,onClose:t[3]||(t[3]=s=>A.value=!1)},{default:a(()=>[l(e(G),null,{default:a(()=>[l(e(Y),null,{default:a(()=>t[39]||(t[39]=[o("Attach Plan",-1)])),_:1,__:[39]})]),_:1}),l(e(h),null,{default:a(()=>[l(e(Vt),null,{default:a(()=>[d("div",re,[l(e(rt),{for:"planSelectSingle"},{default:a(()=>t[40]||(t[40]=[o("Available Plans",-1)])),_:1,__:[40]}),l(e(pt),{id:"planSelectSingle",modelValue:P.value,"onUpdate:modelValue":t[1]||(t[1]=s=>P.value=s)},{default:a(()=>[t[41]||(t[41]=d("option",{value:""},"Select a planâ€¦",-1)),(n(!0),i(_,null,y(nt.value,s=>(n(),i("option",{key:s.id,value:s.id},r(s.name)+" (v"+r(s.version)+")",9,pe))),128))]),_:1,__:[41]},8,["modelValue"])])]),_:1})]),_:1}),l(e(J),null,{default:a(()=>[l(e(c),{color:"secondary",onClick:t[2]||(t[2]=s=>A.value=!1)},{default:a(()=>t[42]||(t[42]=[o("Cancel",-1)])),_:1,__:[42]}),l(e(c),{color:"primary",disabled:!P.value,onClick:wt},{default:a(()=>t[43]||(t[43]=[o("Attach",-1)])),_:1,__:[43]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(K),{visible:M.value,onClose:t[5]||(t[5]=s=>M.value=!1)},{default:a(()=>[l(e(G),null,{default:a(()=>[l(e(Y),null,{default:a(()=>t[44]||(t[44]=[o("Delete participant?",-1)])),_:1,__:[44]})]),_:1}),l(e(h),null,{default:a(()=>[t[45]||(t[45]=o(" This cannot be undone. Continue? ",-1)),z.value?(n(),i("div",me,r(z.value),1)):k("",!0)]),_:1,__:[45]}),l(e(J),null,{default:a(()=>[l(e(c),{color:"secondary",onClick:t[4]||(t[4]=s=>M.value=!1)},{default:a(()=>t[46]||(t[46]=[o("Cancel",-1)])),_:1,__:[46]}),l(e(c),{color:"danger",disabled:E.value,onClick:xt},{default:a(()=>[E.value?(n(),V(e(F),{key:0,size:"sm",class:"me-2"})):k("",!0),t[47]||(t[47]=o(" Delete ",-1))]),_:1,__:[47]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(K),{visible:Z.value,onClose:t[7]||(t[7]=s=>Z.value=!1),size:"lg",alignment:"center",scrollable:""},{default:a(()=>[l(e(G),null,{default:a(()=>[l(e(Y),null,{default:a(()=>[o(r(yt.value||"Payload"),1)]),_:1})]),_:1}),l(e(h),null,{default:a(()=>[d("pre",fe,r(ct.value),1)]),_:1}),l(e(J),null,{default:a(()=>[l(e(c),{color:"secondary",onClick:t[6]||(t[6]=s=>Z.value=!1)},{default:a(()=>t[48]||(t[48]=[o("Close",-1)])),_:1,__:[48]})]),_:1})]),_:1},8,["visible"]),l(e(K),{visible:$.value,onClose:t[11]||(t[11]=s=>$.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(G),null,{default:a(()=>[l(e(Y),null,{default:a(()=>t[49]||(t[49]=[o("Generate Comp Statement",-1)])),_:1,__:[49]})]),_:1}),l(e(h),null,{default:a(()=>[t[52]||(t[52]=d("div",{class:"mb-2 text-muted"},"Select plan(s) to include:",-1)),N.value.length?(n(),i("div",_e,[l(e(Ft),{modelValue:X.value,"onUpdate:modelValue":t[8]||(t[8]=s=>X.value=s),placeholder:"Filter plansâ€¦",class:"mb-2",disabled:I.value},null,8,["modelValue","disabled"]),l(e(rt),{for:"planSelectMulti",class:"mb-1"},{default:a(()=>t[50]||(t[50]=[o("Plans",-1)])),_:1,__:[50]}),l(e(pt),{id:"planSelectMulti",multiple:"",size:bt.value,modelValue:ot.value,"onUpdate:modelValue":t[9]||(t[9]=s=>ot.value=s),disabled:I.value||!tt.value.length,style:{"max-height":"260px",overflow:"auto"}},{default:a(()=>[(n(!0),i(_,null,y(tt.value,s=>(n(),i("option",{key:s.id??s.planId,value:s.planId,disabled:!(s!=null&&s.planId)},r((s==null?void 0:s.name)??"Unnamed")+" (v"+r((s==null?void 0:s.version)??"?")+") ",9,ye))),128))]),_:1},8,["size","modelValue","disabled"]),t[51]||(t[51]=d("small",{class:"text-muted"},"Tip: hold Ctrl/Cmd (or Shift) to select multiple.",-1))])):(n(),i("div",ve," This participant is not attached to any plans. "))]),_:1,__:[52]}),l(e(J),null,{default:a(()=>[l(e(c),{color:"secondary",onClick:t[10]||(t[10]=s=>$.value=!1),disabled:I.value},{default:a(()=>t[53]||(t[53]=[o("Cancel",-1)])),_:1,__:[53]},8,["disabled"]),l(e(c),{color:"primary",onClick:It,disabled:I.value||!L.value.size},{default:a(()=>[I.value?(n(),V(e(F),{key:0,size:"sm",class:"me-2"})):k("",!0),t[54]||(t[54]=o(" Generate Statement ",-1))]),_:1,__:[54]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(n(),i("div",Rt,"Not found."))]))}};export{$e as default};
