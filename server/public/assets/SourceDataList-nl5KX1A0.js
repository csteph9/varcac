import{r as v,o as le,v as k,m as ae,c as q,a as l,w as t,u as a,b as w,e as o,t as c,n as te,C as ue,k as E,p as B,F as ne,f as oe,g as de,h as $,L,j as S}from"./index-BjdMD8Sf.js";import{C as g}from"./CButton-BsLMoijN.js";import{C as se}from"./CCardHeader-Dp3QTvUe.js";import{C as H}from"./CFormCheck-CSpS3hZX.js";import{C as R}from"./CFormInput-mKvw6nm5.js";import{C as ie,a as V}from"./CRow-AWveBr_1.js";import{C as re}from"./CSpinner-CxWKgCdj.js";import{a as fe,b as U,c as p,d as ve,C as me,e as _}from"./CTable-CqembosS.js";const ce={class:"p-3"},pe={class:"text-muted"},_e={class:"d-flex gap-2"},Ce={key:0,class:"py-3"},ge={class:"d-flex justify-content-between align-items-center mt-3"},be={class:"d-flex align-items-center gap-2"},Pe={__name:"SourceDataList",setup(ye){const F=v(!0),d=v([]),f=v(0),D=v(""),A=v(""),T=v(""),P=v(""),m=v(200),i=v(0),s=v(new Set),I=v(null);async function C(){F.value=!0;try{const{data:n}=await $.get("/api/source-data",{withCredentials:!0,params:{participantId:D.value||void 0,label:A.value||void 0,from:T.value||void 0,to:P.value||void 0,limit:m.value,offset:i.value}}),e=n||{};d.value=Array.isArray(e)?e:e.records||[],f.value=e.total??d.value.length;const r=new Set(d.value.map(u=>u.id));for(const u of[...s.value])!r.has(u)&&f.value<=m.value&&s.value.delete(u)}finally{F.value=!1,await L(),b()}}le(C);const M=k(()=>Math.floor(i.value/m.value)+1),O=k(()=>Math.max(Math.ceil((f.value||1)/m.value),1));function j(){i.value+m.value<f.value&&(i.value+=m.value,C())}function W(){i.value-m.value>=0&&(i.value-=m.value,C())}function G(){i.value=0,C()}function J(){D.value="",A.value="",T.value="",P.value="",i.value=0,C()}async function K(n){var e,r;if(n&&confirm("Delete this source data record? This cannot be undone."))try{await $.delete(`/api/source-data/${n}`,{withCredentials:!0});const u=d.value.length;d.value=d.value.filter(x=>x.id!==n),s.value.delete(n),f.value>0&&(f.value=Math.max(0,f.value-(u!==d.value.length?1:0))),d.value.length===0&&i.value>0?(i.value=Math.max(0,i.value-m.value),await C()):(await L(),b())}catch(u){console.error(u),alert(((r=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:r.error)||"Delete failed")}}const h=k(()=>d.value.map(n=>n.id)),N=k(()=>s.value.size),z=k(()=>h.value.length>0&&h.value.every(n=>s.value.has(n))),Q=k(()=>!z.value&&h.value.some(n=>s.value.has(n)));function b(){var n,e;if((e=(n=I.value)==null?void 0:n.$el)!=null&&e.querySelector){const r=I.value.$el.querySelector('input[type="checkbox"]');r&&(r.indeterminate=Q.value)}}ae([d,s],()=>L().then(b));function X(n,e){n&&(e?s.value.add(n):s.value.delete(n))}function Y(n){for(const e of h.value)n?s.value.add(e):s.value.delete(e);b()}function Z(){s.value.clear(),b()}async function ee(){var e,r;const n=[...s.value];if(n.length&&confirm(`Delete ${n.length} selected record(s)? This cannot be undone.`))try{await $.delete("/api/source-data",{withCredentials:!0,data:{ids:n}});const u=d.value.length,x=new Set(n);d.value=d.value.filter(y=>!x.has(y.id)),n.forEach(y=>s.value.delete(y)),f.value>0&&(f.value=Math.max(0,f.value-(u-d.value.length))),d.value.length===0&&i.value>0?(i.value=Math.max(0,i.value-m.value),await C()):(await L(),b())}catch(u){console.error(u),alert(((r=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:r.error)||"Bulk delete failed")}}return(n,e)=>{const r=te("router-link");return S(),q("div",ce,[l(a(de),null,{default:t(()=>[l(a(se),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:t(()=>[w("div",null,[e[5]||(e[5]=o(" Source Data ",-1)),w("small",pe,"("+c(f.value)+" total)",1)]),w("div",_e,[l(a(g),{color:"danger",variant:"outline",disabled:!N.value,onClick:ee},{default:t(()=>[o(" Delete Selected ("+c(N.value)+") ",1)]),_:1},8,["disabled"]),l(a(g),{color:"secondary",variant:"ghost",disabled:!N.value,onClick:Z},{default:t(()=>e[6]||(e[6]=[o(" Clear Selection ",-1)])),_:1,__:[6]},8,["disabled"]),l(r,{class:"btn btn-primary",to:{name:"SourceDataAdd"}},{default:t(()=>e[7]||(e[7]=[o("Add One",-1)])),_:1,__:[7]}),l(r,{class:"btn btn-outline-primary",to:{name:"SourceDataBulkLoad"}},{default:t(()=>e[8]||(e[8]=[o("Bulk Load (CSV)",-1)])),_:1,__:[8]})])]),_:1}),l(a(ue),null,{default:t(()=>[l(a(ie),{class:"g-3 mb-3"},{default:t(()=>[l(a(V),{md:"2"},{default:t(()=>[l(a(B),{class:"mb-1"},{default:t(()=>e[9]||(e[9]=[o("Participant ID",-1)])),_:1,__:[9]}),l(a(R),{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=u=>D.value=u),placeholder:"e.g., 101"},null,8,["modelValue"])]),_:1}),l(a(V),{md:"3"},{default:t(()=>[l(a(B),{class:"mb-1"},{default:t(()=>e[10]||(e[10]=[o("Label",-1)])),_:1,__:[10]}),l(a(R),{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=u=>A.value=u),placeholder:"NEW_ARR, RETAIN_NR, ..."},null,8,["modelValue"])]),_:1}),l(a(V),{md:"2"},{default:t(()=>[l(a(B),{class:"mb-1"},{default:t(()=>e[11]||(e[11]=[o("From",-1)])),_:1,__:[11]}),l(a(R),{type:"date",modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=u=>T.value=u)},null,8,["modelValue"])]),_:1}),l(a(V),{md:"2"},{default:t(()=>[l(a(B),{class:"mb-1"},{default:t(()=>e[12]||(e[12]=[o("To",-1)])),_:1,__:[12]}),l(a(R),{type:"date",modelValue:P.value,"onUpdate:modelValue":e[3]||(e[3]=u=>P.value=u)},null,8,["modelValue"])]),_:1}),l(a(V),{md:"3",class:"d-flex align-items-end gap-2"},{default:t(()=>[l(a(g),{color:"primary",onClick:G},{default:t(()=>e[13]||(e[13]=[o("Apply",-1)])),_:1,__:[13]}),l(a(g),{color:"secondary",variant:"outline",onClick:J},{default:t(()=>e[14]||(e[14]=[o("Clear",-1)])),_:1,__:[14]})]),_:1})]),_:1}),F.value?(S(),q("div",Ce,[l(a(re))])):(S(),E(a(me),{key:1,hover:"",responsive:""},{default:t(()=>[l(a(fe),null,{default:t(()=>[l(a(U),null,{default:t(()=>[l(a(p),{style:{width:"44px"}},{default:t(()=>[l(a(H),{ref_key:"selectAllRef",ref:I,checked:z.value,onChange:e[4]||(e[4]=u=>Y(u.target.checked)),"aria-label":"Select all on page"},null,8,["checked"])]),_:1}),l(a(p),null,{default:t(()=>e[15]||(e[15]=[o("Participant ID",-1)])),_:1,__:[15]}),l(a(p),null,{default:t(()=>e[16]||(e[16]=[o("Label",-1)])),_:1,__:[16]}),l(a(p),null,{default:t(()=>e[17]||(e[17]=[o("Description",-1)])),_:1,__:[17]}),l(a(p),null,{default:t(()=>e[18]||(e[18]=[o("Date",-1)])),_:1,__:[18]}),l(a(p),null,{default:t(()=>e[19]||(e[19]=[o("Value",-1)])),_:1,__:[19]}),l(a(p),null,{default:t(()=>e[20]||(e[20]=[o("Created",-1)])),_:1,__:[20]}),l(a(p),{style:{"min-width":"160px"}},{default:t(()=>e[21]||(e[21]=[o("Actions",-1)])),_:1,__:[21]})]),_:1})]),_:1}),l(a(ve),null,{default:t(()=>[(S(!0),q(ne,null,oe(d.value,(u,x)=>(S(),E(a(U),{key:u.id??x},{default:t(()=>[l(a(_),null,{default:t(()=>[l(a(H),{checked:s.value.has(u.id),onChange:y=>X(u.id,y.target.checked),"aria-label":`Select row ${u.id}`},null,8,["checked","onChange","aria-label"])]),_:2},1024),l(a(_),null,{default:t(()=>[o(c(u.participantId),1)]),_:2},1024),l(a(_),{class:"fw-semibold"},{default:t(()=>[o(c(u.label),1)]),_:2},1024),l(a(_),{class:"text-truncate",style:{"max-width":"360px"}},{default:t(()=>[o(c(u.description||"—"),1)]),_:2},1024),l(a(_),null,{default:t(()=>[o(c(u.date),1)]),_:2},1024),l(a(_),null,{default:t(()=>[o(c(u.value),1)]),_:2},1024),l(a(_),null,{default:t(()=>[o(c(u.createdAt?new Date(u.createdAt).toLocaleString():"—"),1)]),_:2},1024),l(a(_),{class:"d-flex gap-2"},{default:t(()=>[l(a(g),{size:"sm",color:"danger",onClick:y=>K(u.id)},{default:t(()=>e[22]||(e[22]=[o("Delete",-1)])),_:2,__:[22]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})),w("div",ge,[w("div",null,"Page "+c(M.value)+" / "+c(O.value),1),w("div",be,[l(a(g),{size:"sm",disabled:M.value<=1,onClick:W},{default:t(()=>e[23]||(e[23]=[o("Prev",-1)])),_:1,__:[23]},8,["disabled"]),l(a(g),{size:"sm",disabled:M.value>=O.value,onClick:j},{default:t(()=>e[24]||(e[24]=[o("Next",-1)])),_:1,__:[24]},8,["disabled"])])])]),_:1})]),_:1})])}}};export{Pe as default};
