import{r as V,v as R,o as $,c as m,a,w as l,u as t,e as r,C as j,l as I,b as c,p as y,d as A,k as U,t as D,F as L,f as H,n as O,q as W,g as J,h as x,i as Q,j as i}from"./index-C5PjdH1u.js";import{C as E}from"./CButton-CmOQe7lx.js";import{C as G}from"./CCardHeader-ZktOyhiF.js";import{C as K}from"./CForm-CUo11SnN.js";import{C as p}from"./CFormInput-BqrKVkSy.js";import{C as X}from"./CFormSelect-BQ4o_mjU.js";import{C as Y}from"./CFormTextarea-BG8MIxIb.js";import{C as Z,a as _}from"./CRow-BjL7ivIQ.js";import{C as h}from"./CSpinner-CajLDNd3.js";import{a as ee,b as T,c as b,d as te,C as ae,e as g}from"./CTable-BpxxO1kN.js";const le={class:"p-3"},oe={key:0},ne={key:1},se={class:"mt-4 pt-3 border-top"},de={class:"d-flex justify-content-between align-items-center mb-2"},re={class:"d-flex align-items-center gap-2"},ue={key:0,class:"text-body-secondary"},ie={key:0,class:"text-danger mb-2"},fe={key:2,class:"text-body-secondary"},me={class:"d-flex gap-2 mt-4"},Pe={__name:"PlanEdit",setup(pe){const C=W(),q=Q(),S=V(!0),k=V(!1),P=V(!1),s=V({name:"",version:"1.0",payoutFrequency:"Monthly",effectiveStart:"",effectiveEnd:"",description:""}),f=V([]),w=n=>{if(!n)return"";if(typeof n=="string"&&n.length>=10&&n.includes("-"))return n.slice(0,10);const e=new Date(n);return isNaN(e)?"":new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().slice(0,10)},B=n=>({start:w(n.start??n.start_date??n.startDate??""),end:w(n.end??n.end_date??n.endDate??""),label:(n.label??"").toString()}),F=R(()=>{const n=f.value;if(!n.length)return"";const e=[...n].sort((d,o)=>(d.start||"").localeCompare(o.start||""));for(let d=0;d<e.length;d++){const o=e[d];if(!o.start||!o.end)return"All periods must have start and end dates.";if(o.end<o.start)return"A period has an end date before its start.";if(d>0){const u=e[d-1];if(o.start<=u.end)return"Periods overlap or are not strictly ordered."}}return""});$(async()=>{var n;S.value=!0;try{const{data:e}=await x.get(`/api/plans/${C.params.id}`,{withCredentials:!0}),d=e.plan||e||{};s.value={name:d.name||"",version:d.version||"1.0",payoutFrequency:d.payoutFrequency||"Monthly",effectiveStart:w(d.effectiveStart),effectiveEnd:w(d.effectiveEnd),description:d.description||""};let o=Array.isArray(d.payoutPeriods)?d.payoutPeriods:Array.isArray(e.payoutPeriods)?e.payoutPeriods:[];if(!o||!o.length)try{P.value=!0;const u=await x.get(`/api/plans/${C.params.id}/periods`,{withCredentials:!0});o=((n=u.data)==null?void 0:n.periods)||u.data||[]}catch{}finally{P.value=!1}f.value=Array.isArray(o)?o.map(B).filter(u=>u.start&&u.end):[]}finally{S.value=!1}});const N=()=>{f.value.push({start:s.value.effectiveStart||"",end:s.value.effectiveEnd||"",label:`Custom ${f.value.length+1}`})},z=n=>f.value.splice(n,1),M=async()=>{k.value=!0;try{await x.put(`/api/plans/${C.params.id}`,{name:s.value.name,version:s.value.version,payoutFrequency:s.value.payoutFrequency,effectiveStart:s.value.effectiveStart||null,effectiveEnd:s.value.effectiveEnd||null,description:s.value.description||null,payoutPeriods:f.value.map(n=>({start:n.start||null,end:n.end||null,label:n.label||null}))},{withCredentials:!0}),q.push({name:"PlanDetail",params:{id:C.params.id}})}finally{k.value=!1}};return(n,e)=>{const d=O("router-link");return i(),m("div",le,[a(t(J),null,{default:l(()=>[a(t(G),{class:"fw-semibold"},{default:l(()=>e[6]||(e[6]=[r("Edit Plan",-1)])),_:1,__:[6]}),a(t(j),null,{default:l(()=>[S.value?(i(),m("div",oe,[a(t(h))])):(i(),m("div",ne,[a(t(K),{onSubmit:I(M,["prevent"])},{default:l(()=>[a(t(Z),{class:"g-3"},{default:l(()=>[a(t(_),{md:"8"},{default:l(()=>[a(t(y),null,{default:l(()=>e[7]||(e[7]=[r("Plan Name",-1)])),_:1,__:[7]}),a(t(p),{modelValue:s.value.name,"onUpdate:modelValue":e[0]||(e[0]=o=>s.value.name=o)},null,8,["modelValue"])]),_:1}),a(t(_),{md:"4"},{default:l(()=>[a(t(y),null,{default:l(()=>e[8]||(e[8]=[r("Version",-1)])),_:1,__:[8]}),a(t(p),{modelValue:s.value.version,"onUpdate:modelValue":e[1]||(e[1]=o=>s.value.version=o)},null,8,["modelValue"])]),_:1}),a(t(_),{md:"4"},{default:l(()=>[a(t(y),null,{default:l(()=>e[9]||(e[9]=[r("Payout Frequency",-1)])),_:1,__:[9]}),a(t(X),{modelValue:s.value.payoutFrequency,"onUpdate:modelValue":e[2]||(e[2]=o=>s.value.payoutFrequency=o),options:["Monthly","Quarterly","Annual","Semi-Annual","Bi-Weekly","Weekly"]},null,8,["modelValue"])]),_:1}),a(t(_),{md:"4"},{default:l(()=>[a(t(y),null,{default:l(()=>e[10]||(e[10]=[r("Effective Start",-1)])),_:1,__:[10]}),a(t(p),{type:"date",modelValue:s.value.effectiveStart,"onUpdate:modelValue":e[3]||(e[3]=o=>s.value.effectiveStart=o)},null,8,["modelValue"])]),_:1}),a(t(_),{md:"4"},{default:l(()=>[a(t(y),null,{default:l(()=>e[11]||(e[11]=[r("Effective End",-1)])),_:1,__:[11]}),a(t(p),{type:"date",modelValue:s.value.effectiveEnd,"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.effectiveEnd=o)},null,8,["modelValue"])]),_:1}),a(t(_),{md:"12"},{default:l(()=>[a(t(y),null,{default:l(()=>e[12]||(e[12]=[r("Description",-1)])),_:1,__:[12]}),a(t(Y),{modelValue:s.value.description,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.description=o),rows:"3"},null,8,["modelValue"])]),_:1})]),_:1}),c("div",se,[c("div",de,[e[14]||(e[14]=c("h6",{class:"mb-0"},"Payout Periods",-1)),c("div",re,[P.value?(i(),m("span",ue,"Loading periodsâ€¦")):A("",!0),a(t(E),{color:"secondary",variant:"outline",onClick:N},{default:l(()=>e[13]||(e[13]=[r("Add period",-1)])),_:1,__:[13]})])]),F.value?(i(),m("div",ie,D(F.value),1)):A("",!0),f.value.length?(i(),U(t(ae),{key:1,hover:"",responsive:"",small:""},{default:l(()=>[a(t(ee),null,{default:l(()=>[a(t(T),null,{default:l(()=>[a(t(b),{style:{width:"56px"}},{default:l(()=>e[15]||(e[15]=[r("#",-1)])),_:1,__:[15]}),a(t(b),{style:{"min-width":"160px"}},{default:l(()=>e[16]||(e[16]=[r("Start",-1)])),_:1,__:[16]}),a(t(b),{style:{"min-width":"160px"}},{default:l(()=>e[17]||(e[17]=[r("End",-1)])),_:1,__:[17]}),a(t(b),null,{default:l(()=>e[18]||(e[18]=[r("Label",-1)])),_:1,__:[18]}),a(t(b),{style:{width:"90px"}},{default:l(()=>e[19]||(e[19]=[r("Actions",-1)])),_:1,__:[19]})]),_:1})]),_:1}),a(t(te),null,{default:l(()=>[(i(!0),m(L,null,H(f.value,(o,u)=>(i(),U(t(T),{key:u},{default:l(()=>[a(t(g),null,{default:l(()=>[r(D(u+1),1)]),_:2},1024),a(t(g),null,{default:l(()=>[a(t(p),{type:"date",modelValue:o.start,"onUpdate:modelValue":v=>o.start=v},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),a(t(g),null,{default:l(()=>[a(t(p),{type:"date",modelValue:o.end,"onUpdate:modelValue":v=>o.end=v},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),a(t(g),null,{default:l(()=>[a(t(p),{modelValue:o.label,"onUpdate:modelValue":v=>o.label=v,placeholder:"e.g., Jan 2026"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),a(t(g),null,{default:l(()=>[a(t(E),{color:"danger",size:"sm",variant:"ghost",onClick:v=>z(u)},{default:l(()=>e[20]||(e[20]=[r("Remove",-1)])),_:2,__:[20]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(i(),m("div",fe," No payout periods found for this plan. "))]),c("div",me,[a(t(E),{type:"submit",color:"primary",disabled:k.value},{default:l(()=>e[21]||(e[21]=[r("Save",-1)])),_:1,__:[21]},8,["disabled"]),a(d,{class:"btn btn-secondary",to:{name:"PlanDetail",params:{id:t(C).params.id}}},{default:l(()=>e[22]||(e[22]=[r("Cancel",-1)])),_:1,__:[22]},8,["to"])])]),_:1})]))]),_:1})]),_:1})])}}};export{Pe as default};
