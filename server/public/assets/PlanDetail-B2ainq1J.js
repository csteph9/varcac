import{r as f,n as bt,o as gt,w as wt,c as u,a as l,u as e,b as a,d as p,t as r,p as kt,q as At,e as o,C as z,f as xt,h as H,l as V,F as x,g as F,m as Q,s as X,i as c,v as Pt,k as i}from"./index-DPzvZzfM.js";import{C as y}from"./CButton-CxoqXei-.js";import{C as q}from"./CCardHeader-CyVR9a-w.js";import{C as Y}from"./CForm-23VFcb4J.js";import{C as Z}from"./CFormSelect-BnHHmKRI.js";import{C as $t,a as W}from"./CRow-VS3LaBfk.js";import{C as tt,a as et,b as at,c as lt,d as nt}from"./CModalTitle-DUtptC4p.js";import{C as st}from"./CSpinner-4RQXIVOv.js";import{a as ot,b as R,c as b,d as it,C as ut,e as g}from"./CTable-DK-5-MOF.js";const Nt={class:"p-3"},St={key:0,class:"py-3"},Et={key:1},ht={key:2},Dt={class:"d-flex align-items-center gap-2"},Tt=["title"],Mt={class:"d-flex gap-2"},Vt={key:0},Ft={key:1},Rt={key:0},Bt={key:1},Lt={key:0,class:"text-muted"},Ut={class:"badge text-bg-secondary"},It={key:0},zt={key:1},Ht={key:1,class:"text-muted"},qt={class:"mb-3"},Wt={key:0},jt={key:0,class:"text-muted"},Ot={class:"mb-3"},Gt=["value"],Jt={class:"mb-3"},Kt=["value"],oe={__name:"PlanDetail",setup(Qt){const _=Pt(),B=f(!0),m=f({plan:null,elements:[]}),h=f(!1),j=f([]),N=f("");function rt(s){if(!s)return s;const t=Number(s.isActive??s.is_active??1);return{...s,isActive:t}}const L=async()=>{B.value=!0;try{const{data:s}=await c.get(`/api/plans/${_.params.id}`,{withCredentials:!0}),t=rt(s.plan??null);m.value={plan:t,elements:Array.isArray(s.elements)?s.elements:s.elements||[]}}finally{B.value=!1}},dt=async()=>{const{data:s}=await c.get("/api/element-definitions",{withCredentials:!0});j.value=Array.isArray(s)?s:s.elements||[]},O=async()=>{N.value&&(await c.post(`/api/plans/${_.params.id}/elements`,{elementId:Number(N.value)},{withCredentials:!0}),h.value=!1,await L())},S=f(!1),G=f([]),P=f(""),U=f([]),pt=async()=>{const{data:s}=await c.get("/api/computations",{withCredentials:!0});G.value=Array.isArray(s)?s:s.computations||[]},D=async()=>{const{data:s}=await c.get(`/api/plans/${_.params.id}/computations`,{withCredentials:!0});U.value=Array.isArray(s)?s:s.computations||[]},mt=()=>{P.value="",S.value=!0},J=async()=>{P.value&&(await c.post(`/api/plans/${_.params.id}/computations`,{computationId:Number(P.value)},{withCredentials:!0}),S.value=!1,await D())},ft=async s=>{confirm("Remove this computation from the plan?")&&(await c.delete(`/api/plans/${_.params.id}/computations/${s}`,{withCredentials:!0}),await D())};f(!1);const vt=f({run:null,results:[]}),K=async()=>{const{data:s}=await c.get(`/api/plans/${_.params.id}/calculations`,{withCredentials:!0});vt.value=s},$=f({loading:!0,participants:[]}),I=async()=>{$.value.loading=!0;try{const{data:s}=await c.get(`/api/plans/${_.params.id}/payout-run-summary`,{withCredentials:!0});$.value.participants=(s==null?void 0:s.participants)||[]}finally{$.value.loading=!1}},T=f(!1),ct=async()=>{var s,t,v,n,C,k;if(confirm("This will purge and regenerate payouts for this plan from attached computations. Continue?")){T.value=!0;try{const{data:d}=await c.post(`/api/plans/${_.params.id}/run-computations`,{},{withCredentials:!0});alert(`Computations complete: inserted ${d.inserted} rows${(s=d.errors)!=null&&s.length?`; ${d.errors.length} errors`:""}. ${(t=d.errors)!=null&&t.length?`; ${d.errors[0].error}`:""}`),await I()}catch(d){console.error(d),alert(((n=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:n.detail)||((k=(C=d==null?void 0:d.response)==null?void 0:C.data)==null?void 0:k.error)||"Run computations failed")}finally{T.value=!1}}},M=f(!1),w=bt(()=>{var s,t,v,n;return Number(((t=(s=m.value)==null?void 0:s.plan)==null?void 0:t.isActive)??((n=(v=m.value)==null?void 0:v.plan)==null?void 0:n.is_active)??1)===1}),_t=async()=>{var v,n,C,k,d,E;if(!((n=(v=m.value)==null?void 0:v.plan)!=null&&n.id))return;const s=w.value?0:1,t=w.value?"Archive this plan?":"Unarchive this plan?";if(confirm(t)){M.value=!0;try{await c.patch(`/api/plans/${_.params.id}/active`,{isActive:s},{withCredentials:!0}),m.value.plan.isActive=s,m.value.plan.is_active=s}catch(A){console.error(A),alert(((k=(C=A==null?void 0:A.response)==null?void 0:C.data)==null?void 0:k.detail)||((E=(d=A==null?void 0:A.response)==null?void 0:d.data)==null?void 0:E.error)||"Update failed")}finally{M.value=!1}}};gt(async()=>{await Promise.all([L(),dt(),pt(),D(),K(),I()])}),wt(()=>_.params.id,async()=>{await Promise.all([L(),D(),K(),I()])});const Ct=s=>(Number.isFinite(Number(s))?Number(s):0).toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}),yt=s=>s?new Date(s).toLocaleString():"—";return(s,t)=>{const v=At("router-link");return i(),u("div",Nt,[B.value?(i(),u("div",St,[l(e(st))])):m.value.plan?(i(),u("div",ht,[l(e(H),{class:"mb-3"},{default:a(()=>[l(e(q),{class:"fw-semibold d-flex align-items-center justify-content-between gap-2 flex-wrap"},{default:a(()=>{var n,C,k,d,E;return[p("div",Dt,[p("span",null," Plan: "+r(((C=(n=m.value.plan)==null?void 0:n.name)==null?void 0:C.trim())||"#"+(((k=m.value.plan)==null?void 0:k.id)??"—"))+" (v"+r(((E=(d=m.value.plan)==null?void 0:d.version)==null?void 0:E.trim())||"—")+") ",1),p("span",{class:kt(["badge",w.value?"text-bg-success":"text-bg-secondary"]),title:w.value?"Active":"Archived"},r(w.value?"Active":"Archived"),11,Tt)]),p("div",Mt,[l(v,{class:"btn btn-sm btn-outline-primary",to:{name:"PlanEdit",params:{id:m.value.plan.id}}},{default:a(()=>t[6]||(t[6]=[o("Edit",-1)])),_:1,__:[6]},8,["to"]),l(e(y),{color:"secondary",size:"sm",onClick:mt},{default:a(()=>t[7]||(t[7]=[o("Add Computation",-1)])),_:1,__:[7]}),l(e(y),{color:"info",size:"sm",disabled:T.value,onClick:ct},{default:a(()=>[T.value?(i(),u("span",Vt,"Running…")):(i(),u("span",Ft,"Run Computations"))]),_:1},8,["disabled"]),l(e(y),{color:w.value?"warning":"success",size:"sm",disabled:M.value,onClick:_t,title:w.value?"Archive (set inactive)":"Unarchive (set active)"},{default:a(()=>[M.value?(i(),u("span",Rt,"Saving…")):(i(),u("span",Bt,r(w.value?"Archive":"Unarchive"),1))]),_:1},8,["color","disabled","title"])])]}),_:1}),l(e(z),null,{default:a(()=>[l(e($t),{class:"mb-2"},{default:a(()=>[l(e(W),{md:"3"},{default:a(()=>[t[8]||(t[8]=p("strong",null,"Payout:",-1)),o(" "+r(m.value.plan.payoutFrequency||"—"),1)]),_:1,__:[8]}),l(e(W),{md:"3"},{default:a(()=>[t[9]||(t[9]=p("strong",null,"Effective Start:",-1)),o(" "+r(m.value.plan.effectiveStart||"—"),1)]),_:1,__:[9]}),l(e(W),{md:"3"},{default:a(()=>[t[10]||(t[10]=p("strong",null,"Effective End:",-1)),o(" "+r(m.value.plan.effectiveEnd||"—"),1)]),_:1,__:[10]})]),_:1}),m.value.plan.description?(i(),u("div",Lt,r(m.value.plan.description),1)):xt("",!0)]),_:1})]),_:1}),l(e(H),{class:"mt-3"},{default:a(()=>[l(e(q),{class:"fw-semibold"},{default:a(()=>t[11]||(t[11]=[o("Computations",-1)])),_:1,__:[11]}),l(e(z),null,{default:a(()=>[U.value.length?(i(),V(e(ut),{key:0,hover:"",responsive:""},{default:a(()=>[l(e(ot),null,{default:a(()=>[l(e(R),null,{default:a(()=>[l(e(b),null,{default:a(()=>t[12]||(t[12]=[o("Name",-1)])),_:1,__:[12]}),l(e(b),null,{default:a(()=>t[13]||(t[13]=[o("Scope",-1)])),_:1,__:[13]}),l(e(b),null,{default:a(()=>t[14]||(t[14]=[o("Template",-1)])),_:1,__:[14]}),l(e(b),null,{default:a(()=>t[15]||(t[15]=[o("Actions",-1)])),_:1,__:[15]})]),_:1})]),_:1}),l(e(it),null,{default:a(()=>[(i(!0),u(x,null,F(U.value,n=>(i(),V(e(R),{key:n.id},{default:a(()=>[l(e(g),{class:"fw-semibold"},{default:a(()=>[l(e(y),{color:"warning"},{default:a(()=>[l(v,{to:{name:"ComputationEdit",params:{id:n.id}},class:"text-decoration-none",title:`Edit ${n.name}`},{default:a(()=>[o(r(n.name),1)]),_:2},1032,["to","title"])]),_:2},1024)]),_:2},1024),l(e(g),null,{default:a(()=>[p("span",Ut,r(n.scope==="plan"?"Entire Plan Window":"Per Payout Period"),1)]),_:2},1024),l(e(g),{class:"text-truncate",style:{"max-width":"420px"}},{default:a(()=>[n.template?(i(),u("code",It,r(n.template),1)):(i(),u("span",zt,"—"))]),_:2},1024),l(e(g),null,{default:a(()=>[l(e(y),{size:"sm",color:"danger",onClick:C=>ft(n.id)},{default:a(()=>t[16]||(t[16]=[o("Remove",-1)])),_:2,__:[16]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(i(),u("div",Ht,"No computations attached yet."))]),_:1})]),_:1}),l(e(H),{class:"mt-3"},{default:a(()=>[l(e(q),{class:"fw-semibold"},{default:a(()=>t[17]||(t[17]=[o("Calculations (Latest Run)",-1)])),_:1,__:[17]}),l(e(z),null,{default:a(()=>[p("div",qt,[t[23]||(t[23]=p("h6",{class:"mb-2"},"Participants with payouts (latest computations run)",-1)),$.value.loading?(i(),u("div",Wt,[l(e(st))])):(i(),u(x,{key:1},[$.value.participants.length?(i(),V(e(ut),{key:1,hover:"",responsive:"",small:""},{default:a(()=>[l(e(ot),null,{default:a(()=>[l(e(R),null,{default:a(()=>[l(e(b),null,{default:a(()=>t[18]||(t[18]=[o("Participant",-1)])),_:1,__:[18]}),l(e(b),null,{default:a(()=>t[19]||(t[19]=[o("Total Amount",-1)])),_:1,__:[19]}),l(e(b),null,{default:a(()=>t[20]||(t[20]=[o("Lines",-1)])),_:1,__:[20]}),l(e(b),null,{default:a(()=>t[21]||(t[21]=[o("Period Window",-1)])),_:1,__:[21]}),l(e(b),null,{default:a(()=>t[22]||(t[22]=[o("Last Updated",-1)])),_:1,__:[22]})]),_:1})]),_:1}),l(e(it),null,{default:a(()=>[(i(!0),u(x,null,F($.value.participants,n=>(i(),V(e(R),{key:n.participantId,onClick:C=>s.$router.push({name:"ParticipantDetail",params:{id:n.participantId}}),style:{cursor:"pointer"}},{default:a(()=>[l(e(g),null,{default:a(()=>[n.firstName||n.lastName?(i(),u(x,{key:0},[o(r(n.firstName)+" "+r(n.lastName),1)],64)):(i(),u(x,{key:1},[o("#"+r(n.participantId),1)],64))]),_:2},1024),l(e(g),null,{default:a(()=>[p("strong",null,r(Ct(n.totalAmount)),1)]),_:2},1024),l(e(g),null,{default:a(()=>[o(r(n.lines??n.lineCount),1)]),_:2},1024),l(e(g),null,{default:a(()=>[o(r(n.firstPeriodStart)+" → "+r(n.lastPeriodEnd),1)]),_:2},1024),l(e(g),null,{default:a(()=>[o(r(yt(n.lastCreatedAt)),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})):(i(),u("div",jt,"No payouts found for the latest run."))],64))])]),_:1})]),_:1}),l(e(nt),{visible:h.value,onClose:t[2]||(t[2]=n=>h.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(tt),null,{default:a(()=>[l(e(et),null,{default:a(()=>t[24]||(t[24]=[o("Add Existing Element",-1)])),_:1,__:[24]})]),_:1}),l(e(at),null,{default:a(()=>[l(e(Y),{onSubmit:Q(O,["prevent"])},{default:a(()=>[p("div",Ot,[l(e(X),null,{default:a(()=>t[25]||(t[25]=[o("Choose an existing element definition",-1)])),_:1,__:[25]}),l(e(Z),{modelValue:N.value,"onUpdate:modelValue":t[0]||(t[0]=n=>N.value=n)},{default:a(()=>[t[26]||(t[26]=p("option",{value:"",disabled:""},"Select an element…",-1)),(i(!0),u(x,null,F(j.value,n=>(i(),u("option",{key:n.id,value:n.id},r(n.name),9,Gt))),128))]),_:1,__:[26]},8,["modelValue"])]),t[27]||(t[27]=p("div",{class:"text-muted"},[o("Don’t see it? Create it in "),p("strong",null,"Add Plan Element"),o(", then come back.")],-1))]),_:1,__:[27]})]),_:1}),l(e(lt),null,{default:a(()=>[l(e(y),{color:"secondary",onClick:t[1]||(t[1]=n=>h.value=!1)},{default:a(()=>t[28]||(t[28]=[o("Cancel",-1)])),_:1,__:[28]}),l(e(y),{color:"primary",onClick:O,disabled:!N.value},{default:a(()=>t[29]||(t[29]=[o("Attach",-1)])),_:1,__:[29]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),l(e(nt),{visible:S.value,onClose:t[5]||(t[5]=n=>S.value=!1),alignment:"center",backdrop:"static"},{default:a(()=>[l(e(tt),null,{default:a(()=>[l(e(et),null,{default:a(()=>t[30]||(t[30]=[o("Add Computation",-1)])),_:1,__:[30]})]),_:1}),l(e(at),null,{default:a(()=>[l(e(Y),{onSubmit:Q(J,["prevent"])},{default:a(()=>[p("div",Jt,[l(e(X),null,{default:a(()=>t[31]||(t[31]=[o("Choose a computation",-1)])),_:1,__:[31]}),l(e(Z),{modelValue:P.value,"onUpdate:modelValue":t[3]||(t[3]=n=>P.value=n)},{default:a(()=>[t[32]||(t[32]=p("option",{value:"0"},"Select a computation…",-1)),(i(!0),u(x,null,F(G.value,n=>(i(),u("option",{key:n.id,value:n.id},r(n.name)+" ("+r(n.scope==="plan"?"Plan":"Payout")+") ",9,Kt))),128))]),_:1,__:[32]},8,["modelValue"])])]),_:1})]),_:1}),l(e(lt),null,{default:a(()=>[l(e(y),{color:"secondary",onClick:t[4]||(t[4]=n=>S.value=!1)},{default:a(()=>t[33]||(t[33]=[o("Cancel",-1)])),_:1,__:[33]}),l(e(y),{color:"primary",onClick:J,disabled:!P.value},{default:a(()=>t[34]||(t[34]=[o("Attach",-1)])),_:1,__:[34]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(i(),u("div",Et,"Not found."))])}}};export{oe as default};
