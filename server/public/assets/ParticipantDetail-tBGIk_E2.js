import{r as m,v as Q,o as $e,m as Te,c as r,a,u as t,w as s,b as p,e as n,t as d,R as _e,q as Ne,C as W,g as X,F as C,f as A,k as B,d as q,p as se,h as b,i as Ve,j as i,x as Me}from"./index-CvVN3E1C.js";import{C as Fe}from"./CBadge-_R_etuMr.js";import{C as g}from"./CButton-BTssrhK7.js";import{C as Z}from"./CCardHeader-BChnrtWq.js";import{C as ze}from"./CForm-Dg8Z9R-d.js";import{C as Re}from"./CFormInput-BYQOnHK2.js";import{C as ne}from"./CFormSelect-CLA5qttS.js";import{C as Ue,a as oe}from"./CRow-DVSi5Bvt.js";import{C as ie,a as re,b as ue,c as de,d as pe}from"./CModalTitle-BJKbys-o.js";import{C as N}from"./CSpinner-BQ14nvNv.js";import{a as ye,b as ee,c as w,d as ge,C as Ce,e as S}from"./CTable-BkLSXEBj.js";const Ee={class:"p-3"},Be={key:0,class:"py-3"},qe={key:1},He={key:2},Oe={class:"text-muted small"},je={class:"d-flex gap-2"},he={key:0},Ge={key:0,class:"text-muted"},Ye={key:1},Je={class:"d-flex flex-wrap"},Ke={key:1,class:"text-muted"},Qe={key:0},We={key:1},Xe={key:0,class:"text-muted"},Ze={class:"d-flex align-items-center mb-2"},et={class:"me-2"},tt={key:0,class:"text-muted"},lt={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},at={class:"me-2"},st={class:"text-muted ms-2"},nt={key:0,class:"text-muted"},ot={key:1,class:"d-flex flex-column gap-2"},it=["value","disabled"],rt=["value"],ut={key:0,class:"text-muted"},dt={key:1,class:"text-danger"},pt={key:2,class:"text-muted"},mt={class:"mb-3"},ft=["value"],vt={key:0,class:"text-danger mt-2"},ct="badge rounded-pill text-bg-secondary me-2 mb-2",Pt={__name:"ParticipantDetail",setup(_t){const c=Ne(),be=Ve(),te=m(!0),_=m({participant:null,plans:[]}),le=m(""),V=m(!1),me=m([]),M=m(""),L=m({loading:!0,plans:[]}),P=m({loading:!0,allInputs:[],plans:[]});m(!1),m(""),m("");const H=m(!1),O=m(!1),j=m(""),F=m(!1),k=m(!1),z=m(new Set),fe=Q({get:()=>[...z.value],set:o=>{z.value=new Set(o.map(Number).filter(e=>Number.isFinite(e)))}}),we=Q(()=>Math.min(10,Math.max(4,ae.value.length))),R=m(["ACTUAL"]),y=m([]),h=m(!0),G=m(""),ve=o=>{const e=Number(o??0);return Number.isFinite(e)?e.toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}):"â€”"},U=Q(()=>{var e;return(((e=_.value)==null?void 0:e.plans)||[]).map(l=>{var u;return{...l,planId:l.planId??l.plan_id??((u=l.plan)==null?void 0:u.id)??l.cpId??l.cid??null}}).filter(l=>l.planId)}),ae=Q(()=>{const o=(le.value||"").toLowerCase().trim();return o?U.value.filter(e=>String(e.name||"").toLowerCase().includes(o)||String(e.version||"").toLowerCase().includes(o)):U.value}),Y=async()=>{var o;te.value=!0;try{const{data:e}=await b.get(`/api/participants/${c.params.id}`,{withCredentials:!0}),l=Array.isArray(e.plans)?e.plans:[];for(const u of l)u.planId=u.planId??u.plan_id??((o=u.plan)==null?void 0:o.id)??u.cpId??u.cid??null;_.value={participant:e.participant??null,plans:l}}finally{te.value=!1}},Se=async()=>{const{data:o}=await b.get("/api/plans",{withCredentials:!0});me.value=o||[]},J=async()=>{L.value.loading=!0;try{const{data:o}=await b.get(`/api/participants/${c.params.id}/payout-history`,{withCredentials:!0});L.value.plans=(o==null?void 0:o.plans)||[]}finally{L.value.loading=!1}},K=async()=>{P.value.loading=!0;try{const{data:o}=await b.get(`/api/participants/${c.params.id}/required-source-inputs`,{withCredentials:!0});P.value={loading:!1,allInputs:Array.isArray(o==null?void 0:o.allInputs)?o.allInputs:[],plans:Array.isArray(o==null?void 0:o.plans)?o.plans:[]}}catch(o){console.error(o),P.value={loading:!1,allInputs:[],plans:[]}}};async function ce(){var o,e;G.value="",h.value=!0,y.value=[];try{let u=new Set,v=0;const I=500;let E=1/0;for(;v<E&&v<5e3;){const{data:f}=await b.get("/api/source-data",{withCredentials:!0,params:{participantId:c.params.id,limit:I,offset:v}}),D=f||{},$=Array.isArray(D)?D:D.records||[];E=Number(D.total??$.length??0)||0;for(const x of $){const T=(x.recordScope??x.record_scope??"").toString().trim();T&&u.add(T)}if(v+=I,!$.length)break}y.value=Array.from(u).sort(),y.value.length||(y.value=["ACTUAL"])}catch(l){console.error(l),G.value=((e=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:e.error)||"Failed to load record scopes",y.value.length||(y.value=["ACTUAL"])}finally{h.value=!1;const l=new Set((R.value||[]).map(u=>String(u||"").trim()).filter(Boolean));if(l.size){const u=new Set([...y.value,...l]);y.value=Array.from(u).sort()}}}$e(async()=>{await Promise.all([Y(),Se(),J(),K(),ce()])}),Te(()=>c.params.id,async()=>{await Promise.all([Y(),J(),K(),ce()])}),m(!1);const ke=async()=>{M.value&&(await b.post(`/api/participants/${c.params.id}/plans`,{planId:Number(M.value)},{withCredentials:!0}),V.value=!1,await Promise.all([Y(),J(),K()]))},xe=async o=>{confirm("Detach this plan from the participant? All historical calculations will be removed.")&&(await b.delete(`/api/participants/${c.params.id}/plans/${o}`,{withCredentials:!0}),await Promise.all([Y(),J(),K()]))},Ae=()=>{j.value="",H.value=!0},Ie=async()=>{var o,e;O.value=!0;try{await b.delete(`/api/participants/${c.params.id}`,{withCredentials:!0}),be.push({name:"ParticipantsList"})}catch(l){console.error(l),j.value=((e=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:e.error)||"Failed to delete"}finally{O.value=!1}},Le=async()=>{var u,v,I,E;if(!z.value.size)return;const o=Array.from(z.value),e=Array.isArray(R.value)?R.value.map(f=>String(f||"").trim()).filter(Boolean):[],l=e.length?e:["ACTUAL"];k.value=!0;try{const{data:f}=await b.post(`/api/participants/${c.params.id}/comp-statement`,{planIds:o,recordScopes:l},{withCredentials:!0,responseType:"blob"});console.log("data",f.text().then(De=>{console.log(De)}));const D=new Blob([f],{type:"text/html"}),$=URL.createObjectURL(D),x=document.createElement("a"),T=new Date,Pe=`${T.getFullYear()}-${String(T.getMonth()+1).padStart(2,"0")}-${String(T.getDate()).padStart(2,"0")}`;x.href=$,x.download=`CompStatement_${((v=(u=_.value)==null?void 0:u.participant)==null?void 0:v.lastName)??"Participant"}_${Pe}.html`,document.body.appendChild(x),x.click(),x.remove(),URL.revokeObjectURL($),F.value=!1}catch(f){console.error(f),alert(((E=(I=f==null?void 0:f.response)==null?void 0:I.data)==null?void 0:E.error)||(f==null?void 0:f.message)||"Failed to generate statement")}finally{k.value=!1}};return(o,e)=>(i(),r("div",Ee,[te.value?(i(),r("div",Be,[a(t(N))])):_.value.participant?(i(),r("div",He,[a(t(X),{class:"mb-3"},{default:s(()=>[a(t(Z),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:s(()=>[p("span",null,[n(" Participant: "+d(_.value.participant.firstName)+" "+d(_.value.participant.lastName)+" ",1),p("span",Oe,"(#"+d(_.value.participant.id)+")",1)]),p("div",je,[a(t(_e),{class:"btn btn-primary",to:{name:"ParticipantEdit",params:{id:t(c).params.id}}},{default:s(()=>e[12]||(e[12]=[n("Edit",-1)])),_:1,__:[12]},8,["to"]),a(t(g),{color:"danger",variant:"outline",onClick:Ae},{default:s(()=>e[13]||(e[13]=[n("Delete",-1)])),_:1,__:[13]}),a(t(g),{color:"primary",size:"sm",onClick:e[0]||(e[0]=l=>V.value=!0)},{default:s(()=>e[14]||(e[14]=[n("Attach Plan",-1)])),_:1,__:[14]}),a(t(g),{color:"warning",size:"sm",onClick:e[1]||(e[1]=l=>F.value=!0)},{default:s(()=>e[15]||(e[15]=[n("Comp Statement",-1)])),_:1,__:[15]})])]),_:1}),a(t(W),null,{default:s(()=>[a(t(Ue),null,{default:s(()=>[a(t(oe),{md:"4"},{default:s(()=>[e[16]||(e[16]=p("strong",null,"Email:",-1)),n(" "+d(_.value.participant.email),1)]),_:1,__:[16]}),a(t(oe),{md:"4"},{default:s(()=>[e[17]||(e[17]=p("strong",null,"ID:",-1)),n(" "+d(_.value.participant.id),1)]),_:1,__:[17]}),a(t(oe),{md:"4"},{default:s(()=>[e[18]||(e[18]=p("strong",null,"Created:",-1)),n(" "+d(new Date(_.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[18]})]),_:1})]),_:1})]),_:1}),a(t(X),{class:"mb-3"},{default:s(()=>[a(t(Z),{class:"fw-semibold"},{default:s(()=>e[19]||(e[19]=[n("Required Source Data Inputs",-1)])),_:1,__:[19]}),a(t(W),null,{default:s(()=>[P.value.loading?(i(),r("div",he,[a(t(N))])):(i(),r(C,{key:1},[P.value.allInputs.length?(i(),r("div",Ye,[e[20]||(e[20]=p("h6",{class:"mb-2"},"All required labels for this participant",-1)),p("div",Je,[(i(!0),r(C,null,A(P.value.allInputs,l=>(i(),r("span",{key:"all-"+l,class:Me(ct)},d(l),1))),128))])])):(i(),r("div",Ge," No source data requirements detected for this participantâ€™s attached plans. "))],64))]),_:1})]),_:1}),a(t(X),null,{default:s(()=>[a(t(Z),{class:"fw-semibold"},{default:s(()=>e[21]||(e[21]=[n("Attached Plans",-1)])),_:1,__:[21]}),a(t(W),null,{default:s(()=>[U.value.length?(i(),B(t(Ce),{key:0,hover:"",responsive:""},{default:s(()=>[a(t(ye),null,{default:s(()=>[a(t(ee),null,{default:s(()=>[a(t(w),null,{default:s(()=>e[22]||(e[22]=[n("Name",-1)])),_:1,__:[22]}),a(t(w),null,{default:s(()=>e[23]||(e[23]=[n("Version",-1)])),_:1,__:[23]}),a(t(w),null,{default:s(()=>e[24]||(e[24]=[n("Plan Effective",-1)])),_:1,__:[24]}),a(t(w),null,{default:s(()=>e[25]||(e[25]=[n("Attached",-1)])),_:1,__:[25]}),a(t(w),null,{default:s(()=>e[26]||(e[26]=[n("Actions",-1)])),_:1,__:[26]})]),_:1})]),_:1}),a(t(ge),null,{default:s(()=>[(i(!0),r(C,null,A(U.value,l=>(i(),B(t(ee),{key:l.planId},{default:s(()=>[a(t(S),null,{default:s(()=>[n(d(l.name),1)]),_:2},1024),a(t(S),null,{default:s(()=>[n("v"+d(l.version),1)]),_:2},1024),a(t(S),null,{default:s(()=>[n(d(l.planEffectiveStart||"â€”")+" â†’ "+d(l.planEffectiveEnd||"â€”"),1)]),_:2},1024),a(t(S),null,{default:s(()=>[n(d(new Date(l.attachedAt).toLocaleString()),1)]),_:2},1024),a(t(S),null,{default:s(()=>[a(t(g),{color:"secondary",size:"sm",onClick:u=>xe(l.planId)},{default:s(()=>e[27]||(e[27]=[n("Detach",-1)])),_:2,__:[27]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})):(i(),r("div",Ke,"No plans attached yet."))]),_:1})]),_:1}),a(t(X),{class:"mt-3"},{default:s(()=>[a(t(Z),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:s(()=>[e[29]||(e[29]=p("span",null,"Payout History (by Plan & Period)",-1)),a(t(_e),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:s(()=>e[28]||(e[28]=[n("View Plans",-1)])),_:1,__:[28]})]),_:1,__:[29]}),a(t(W),null,{default:s(()=>[L.value.loading?(i(),r("div",Qe,[a(t(N))])):(i(),r("div",We,[L.value.plans.length?q("",!0):(i(),r("div",Xe,"No payout history yet.")),(i(!0),r(C,null,A(L.value.plans,l=>(i(),r("div",{key:l.planId,class:"mb-4"},[p("div",Ze,[p("strong",et,d(l.planName),1),a(t(Fe),{color:"secondary",class:"me-2"},{default:s(()=>[n("v"+d(l.planVersion),1)]),_:2},1024)]),a(t(Ce),{hover:"",responsive:"",small:""},{default:s(()=>[a(t(ye),null,{default:s(()=>[a(t(ee),null,{default:s(()=>[a(t(w),{style:{"min-width":"120px"}},{default:s(()=>e[30]||(e[30]=[n("Period",-1)])),_:1,__:[30]}),a(t(w),{style:{"min-width":"120px"}},{default:s(()=>e[31]||(e[31]=[n("Period End Date",-1)])),_:1,__:[31]}),a(t(w),{style:{"min-width":"160px","text-align":"center"}},{default:s(()=>e[32]||(e[32]=[n("Total Payout",-1)])),_:1,__:[32]}),a(t(w),null,{default:s(()=>e[33]||(e[33]=[n("Computations",-1)])),_:1,__:[33]})]),_:1})]),_:1}),a(t(ge),null,{default:s(()=>[(i(!0),r(C,null,A(l.periods,u=>(i(),B(t(ee),{key:u.periodStart+"|"+u.periodEnd+"|"+(u.periodLabel||"")},{default:s(()=>[a(t(S),null,{default:s(()=>[p("div",null,[n(d(new Date(u.periodStart).toISOString().split("T")[0])+" â­¾ ",1),e[34]||(e[34]=p("br",null,null,-1)),n(d(new Date(u.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),a(t(S),null,{default:s(()=>[n(d(new Date(u.dueDate).toISOString().split("T")[0]),1),e[35]||(e[35]=p("br",null,null,-1)),u.periodLabel?(i(),r("small",tt,d(u.periodLabel),1)):q("",!0)]),_:2,__:[35]},1024),a(t(S),{style:{"text-align":"center"}},{default:s(()=>[p("strong",null,d(ve(u.total)),1)]),_:2},1024),a(t(S),null,{default:s(()=>[p("ul",lt,[(i(!0),r(C,null,A(u.lines,(v,I)=>(i(),r("li",{key:v.outputLabel+"|"+I},[p("span",at,d(v.outputLabel),1),p("strong",null,d(ve(v.amount)),1),p("small",st,d(new Date(v.createdAt).toLocaleString()),1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),a(t(pe),{visible:F.value,onClose:e[6]||(e[6]=l=>F.value=!1),alignment:"center",backdrop:"static"},{default:s(()=>[a(t(ie),null,{default:s(()=>[a(t(re),null,{default:s(()=>e[36]||(e[36]=[n("Generate Comp Statement",-1)])),_:1,__:[36]})]),_:1}),a(t(ue),null,{default:s(()=>[e[41]||(e[41]=p("div",{class:"mb-2 text-muted"},"Select plan(s) and record scope(s) to include:",-1)),U.value.length?(i(),r("div",ot,[a(t(Re),{modelValue:le.value,"onUpdate:modelValue":e[2]||(e[2]=l=>le.value=l),placeholder:"Filter plansâ€¦",class:"mb-2",disabled:k.value},null,8,["modelValue","disabled"]),a(t(se),{for:"planSelectMulti",class:"mb-1"},{default:s(()=>e[37]||(e[37]=[n("Plans",-1)])),_:1,__:[37]}),a(t(ne),{id:"planSelectMulti",multiple:"",size:we.value,modelValue:fe.value,"onUpdate:modelValue":e[3]||(e[3]=l=>fe.value=l),disabled:k.value||!ae.value.length,style:{"max-height":"260px",overflow:"auto"}},{default:s(()=>[(i(!0),r(C,null,A(ae.value,l=>(i(),r("option",{key:l.id??l.planId,value:l.planId,disabled:!(l!=null&&l.planId)},d((l==null?void 0:l.name)??"Unnamed")+" (v"+d((l==null?void 0:l.version)??"?")+") ",9,it))),128))]),_:1},8,["size","modelValue","disabled"]),a(t(se),{for:"scopeSelectMulti",class:"mb-1 mt-3"},{default:s(()=>e[38]||(e[38]=[n("Record Scopes",-1)])),_:1,__:[38]}),a(t(ne),{id:"scopeSelectMulti",multiple:"",size:Math.min(8,Math.max(4,(y.value||[]).length||4)),modelValue:R.value,"onUpdate:modelValue":e[4]||(e[4]=l=>R.value=l),disabled:k.value||h.value,style:{"max-height":"220px",overflow:"auto"}},{default:s(()=>[(i(!0),r(C,null,A(y.value,l=>(i(),r("option",{key:l,value:l},d(l),9,rt))),128))]),_:1},8,["size","modelValue","disabled"]),h.value?(i(),r("small",ut,[a(t(N),{size:"sm",class:"me-1"}),e[39]||(e[39]=n("Loading record scopesâ€¦ ",-1))])):G.value?(i(),r("small",dt,d(G.value),1)):(i(),r("small",pt,e[40]||(e[40]=[n(" Select one or more scopes (defaults to ",-1),p("strong",null,"ACTUAL",-1),n(" if none selected). ",-1)])))])):(i(),r("div",nt," This participant is not attached to any plans. "))]),_:1,__:[41]}),a(t(de),null,{default:s(()=>[a(t(g),{color:"secondary",onClick:e[5]||(e[5]=l=>F.value=!1),disabled:k.value},{default:s(()=>e[42]||(e[42]=[n("Cancel",-1)])),_:1,__:[42]},8,["disabled"]),a(t(g),{color:"primary",onClick:Le,disabled:k.value||!z.value.size},{default:s(()=>[k.value?(i(),B(t(N),{key:0,size:"sm",class:"me-2"})):q("",!0),e[43]||(e[43]=n(" Generate Statement ",-1))]),_:1,__:[43]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(t(pe),{visible:V.value,onClose:e[9]||(e[9]=l=>V.value=!1)},{default:s(()=>[a(t(ie),null,{default:s(()=>[a(t(re),null,{default:s(()=>e[44]||(e[44]=[n("Attach Plan",-1)])),_:1,__:[44]})]),_:1}),a(t(ue),null,{default:s(()=>[a(t(ze),null,{default:s(()=>[p("div",mt,[a(t(se),{for:"planSelectSingle"},{default:s(()=>e[45]||(e[45]=[n("Available Plans",-1)])),_:1,__:[45]}),a(t(ne),{id:"planSelectSingle",modelValue:M.value,"onUpdate:modelValue":e[7]||(e[7]=l=>M.value=l)},{default:s(()=>[e[46]||(e[46]=p("option",{value:""},"Select a planâ€¦",-1)),(i(!0),r(C,null,A(me.value,l=>(i(),r("option",{key:l.id,value:l.id},d(l.name)+" (v"+d(l.version)+")",9,ft))),128))]),_:1,__:[46]},8,["modelValue"])])]),_:1})]),_:1}),a(t(de),null,{default:s(()=>[a(t(g),{color:"secondary",onClick:e[8]||(e[8]=l=>V.value=!1)},{default:s(()=>e[47]||(e[47]=[n("Cancel",-1)])),_:1,__:[47]}),a(t(g),{color:"primary",disabled:!M.value,onClick:ke},{default:s(()=>e[48]||(e[48]=[n("Attach",-1)])),_:1,__:[48]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(t(pe),{visible:H.value,onClose:e[11]||(e[11]=l=>H.value=!1)},{default:s(()=>[a(t(ie),null,{default:s(()=>[a(t(re),null,{default:s(()=>e[49]||(e[49]=[n("Delete participant?",-1)])),_:1,__:[49]})]),_:1}),a(t(ue),null,{default:s(()=>[e[50]||(e[50]=n(" This cannot be undone. Continue? ",-1)),j.value?(i(),r("div",vt,d(j.value),1)):q("",!0)]),_:1,__:[50]}),a(t(de),null,{default:s(()=>[a(t(g),{color:"secondary",onClick:e[10]||(e[10]=l=>H.value=!1)},{default:s(()=>e[51]||(e[51]=[n("Cancel",-1)])),_:1,__:[51]}),a(t(g),{color:"danger",disabled:O.value,onClick:Ie},{default:s(()=>[O.value?(i(),B(t(N),{key:0,size:"sm",class:"me-2"})):q("",!0),e[52]||(e[52]=n(" Delete ",-1))]),_:1,__:[52]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(i(),r("div",qe,"Not found."))]))}};export{Pt as default};
