import{r,n as xe,o as ke,w as he,c,d as n,l as L,a as o,e as i,b as a,u as l,K as N,L as B,t as f,f as G,F as H,g as $,i as b,k as u,M as Se}from"./index-CFGD_Gi7.js";import{C as J}from"./CAlert-DAczoeYR.js";import{C as y}from"./CButton-Bar-IVn5.js";import{C as oe,a as ne,b as ie,c as de,d as ue}from"./CModalTitle-BJzK3tic.js";import{C as Q}from"./CSpinner-B_QOP7IZ.js";import{b as X,c as C,a as Ae,e as _,d as Ie,C as Pe}from"./CTable-D8-Qdao0.js";import{_ as Te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Le={class:"px-3 py-4"},Ne={class:"d-flex gap-2 mb-3"},Ue={class:"ms-auto d-flex align-items-center gap-2"},De={class:"mb-3 d-flex align-items-center gap-2"},Ee={key:0,class:"d-flex align-items-center text-body-secondary"},Me=["checked"],ze=["value"],Fe=["onClick"],Ve={class:"row g-3"},Be={class:"col-12"},Ge=["value"],He={class:"col-12"},$e=["value"],Oe={class:"col-md-6"},Re=["disabled"],We={key:0,disabled:""},je=["value"],qe={key:0,class:"form-text text-danger"},Ke={key:0,class:"col-12"},Je={key:0},Qe={key:1},Xe={key:0,class:"d-flex align-items-center text-body-secondary"},Ye={key:2,class:"preview-frame-wrap"},Ze=["srcdoc"],et={key:1,class:"small"},tt={__name:"StatementHub",setup(lt){const g=r([]),U=r(!1),x=r(""),v=r([]),O=r(""),k=r(!1),A=r(!1),I=r(""),Y=r([]),Z=r([]),m=r([]),D=r(!1),E=r(""),p=r({participantIds:[],planIds:[],scope:"ACTUAL"}),R=r(!1),W=r(!1),M=r(""),P=r(""),z=r(""),re=xe(()=>g.value.length?g.value.every(s=>v.value.includes(s.id)):!1);function ve(s){if(s.target.checked){const e=g.value.map(d=>d.id),t=new Set([...v.value,...e]);v.value=Array.from(t)}else{const e=new Set(g.value.map(t=>t.id));v.value=v.value.filter(t=>!e.has(t))}}function ce(){v.value=[]}async function h(){var s,e;U.value=!0,x.value="";try{const{data:t}=await b.get("/api/statement-hub/outbox",{params:{status:O.value||void 0},withCredentials:!0});g.value=Array.isArray(t==null?void 0:t.data)?t.data:[]}catch(t){x.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.error)||(t==null?void 0:t.message)||"Failed to load outbox."}finally{U.value=!1}}function pe(){k.value=!0,p.value.participantIds.length&&ee()}async function ee(){var s,e;E.value="",D.value=!0,m.value=[];try{const T=new Set,F=p.value.participantIds||[];if(!F.length){m.value=["ACTUAL"],p.value.scope="ACTUAL";return}for(const w of F){let S=0,le=1/0;for(;S<le&&S<5e3;){const{data:Ce}=await b.get("/api/source-data",{withCredentials:!0,params:{participantId:w,limit:500,offset:S}}),V=Ce||{},K=Array.isArray(V)?V:V.records||[];le=Number(V.total??K.length??0)||0;for(const ae of K){const se=(ae.recordScope??ae.record_scope??"").toString().trim();se&&T.add(se)}if(S+=500,!K.length)break}}m.value=Array.from(T).sort(),m.value.length||(m.value=["ACTUAL"]),m.value.includes(p.value.scope)||(p.value.scope=m.value[0]||"ACTUAL")}catch(t){console.error(t),E.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.error)||"Failed to load record scopes",m.value.length||(m.value=["ACTUAL"],p.value.scope="ACTUAL")}finally{D.value=!1}}const j=r(!1);async function fe(){var s,e;if(v.value.length){j.value=!0;try{await b.post("/api/statement-hub/push",{ids:v.value},{withCredentials:!0}),v.value=[],await h()}catch(t){x.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.error)||(t==null?void 0:t.message)||"Push failed."}finally{j.value=!1}}}const q=r(!1);async function me(){var s,e;if(v.value.length&&confirm(`Delete ${v.value.length} selected row(s)? This cannot be undone.`)){q.value=!0;try{await b.post("/api/statement-hub/delete",{ids:v.value},{withCredentials:!0}),v.value=[],await h()}catch(t){x.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.error)||(t==null?void 0:t.message)||"Delete failed."}finally{q.value=!1}}}async function be(s){var e,t;R.value=!0,W.value=!0,M.value="",P.value="",z.value="";try{const{data:d}=await b.get(`/api/statement-hub/outbox/${s.id}/payload`,{withCredentials:!0}),T=(d==null?void 0:d.payload_b64)||(d==null?void 0:d.payload)||"";if(!T)throw new Error("No payload returned");const F=Uint8Array.from(atob(T),S=>S.charCodeAt(0)),w=new TextDecoder().decode(F);w.trim().startsWith("<!")||w.trim().startsWith("<html")||w.includes("<body")?P.value=w:z.value=w}catch(d){M.value=((t=(e=d==null?void 0:d.response)==null?void 0:e.data)==null?void 0:t.error)||(d==null?void 0:d.message)||"Failed to load preview."}finally{W.value=!1}}function te(){R.value=!1,P.value="",z.value=""}async function ye(){var e,t;I.value="";const s=p.value;if(!s.participantIds.length||!s.planIds.length){I.value="Select participants and plans.";return}A.value=!0;try{await b.post("/api/statement-hub/calc-enqueue",{participantIds:s.participantIds,planIds:s.planIds,scope:s.scope},{withCredentials:!0}),k.value=!1,await h()}catch(d){I.value=((t=(e=d==null?void 0:d.response)==null?void 0:e.data)==null?void 0:t.error)||(d==null?void 0:d.message)||"Failed to enqueue."}finally{A.value=!1}}async function _e(){try{const{data:s}=await b.get("/api/participants",{withCredentials:!0});Y.value=((s==null?void 0:s.data)||s||[]).map(e=>({id:e.id,first_name:e.first_name??e.firstName??"",last_name:e.last_name??e.lastName??"",email:e.email??""}))}catch{}}async function ge(){try{const{data:s}=await b.get("/api/plans",{withCredentials:!0});Z.value=((s==null?void 0:s.data)||s||[]).map(e=>({id:e.id,name:e.name??e.plan_name??`Plan #${e.id}`}))}catch{}}function we(s){return[s.first_name,s.last_name].filter(Boolean).join(" ")||`Participant #${s.id}`}return ke(async()=>{await Promise.all([_e(),ge(),h()])}),he(()=>p.value.participantIds.slice().sort().join(","),()=>{k.value&&ee()}),(s,e)=>(u(),c("div",Le,[e[34]||(e[34]=n("h1",{class:"h4 mb-3"},"Statement Hub",-1)),e[35]||(e[35]=n("p",{class:"text-body-secondary mb-4"},[i(" Generate statements (calc → outbox) and push selected to "),n("code",null,"statementhub.varcac.com"),i(". ")],-1)),n("div",Ne,[o(l(y),{color:"dark",size:"sm",onClick:pe},{default:a(()=>e[8]||(e[8]=[i("Generate (Calc → Outbox)",-1)])),_:1,__:[8]}),o(l(y),{color:"secondary",variant:"outline",size:"sm",disabled:U.value,onClick:h},{default:a(()=>e[9]||(e[9]=[i(" Refresh Outbox ",-1)])),_:1,__:[9]},8,["disabled"]),n("div",Ue,[e[11]||(e[11]=n("label",{class:"form-label mb-0 small"},"Filter:",-1)),N(n("select",{class:"form-select form-select-sm","onUpdate:modelValue":e[0]||(e[0]=t=>O.value=t),onChange:h,style:{width:"160px"}},e[10]||(e[10]=[n("option",{value:""},"All",-1),n("option",{value:"PENDING"},"PENDING",-1),n("option",{value:"FAILED"},"FAILED",-1),n("option",{value:"SENT"},"SENT",-1)]),544),[[B,O.value]])])]),n("div",De,[o(l(y),{color:"primary",size:"sm",disabled:!v.value.length||j.value,onClick:fe},{default:a(()=>[i(" Push Selected ("+f(v.value.length)+") ",1)]),_:1},8,["disabled"]),o(l(y),{color:"danger",size:"sm",variant:"outline",disabled:!v.value.length||q.value,onClick:me},{default:a(()=>e[12]||(e[12]=[i(" Delete Selected ",-1)])),_:1,__:[12]},8,["disabled"]),o(l(y),{color:"secondary",variant:"outline",size:"sm",onClick:ce,disabled:!v.value.length},{default:a(()=>e[13]||(e[13]=[i(" Clear Selection ",-1)])),_:1,__:[13]},8,["disabled"])]),U.value?(u(),c("div",Ee,[o(l(Q),{size:"sm",class:"me-2"}),e[14]||(e[14]=i(" Loading outbox… ",-1))])):x.value?(u(),L(l(J),{key:1,color:"danger"},{default:a(()=>[i(f(x.value),1)]),_:1})):(u(),L(l(Pe),{key:2,responsive:"",hover:"",small:"",bordered:"",class:"align-middle"},{default:a(()=>[o(l(Ae),null,{default:a(()=>[o(l(X),null,{default:a(()=>[o(l(C),{style:{width:"36px"}},{default:a(()=>[n("input",{type:"checkbox",checked:re.value,onChange:e[1]||(e[1]=t=>ve(t))},null,40,Me)]),_:1}),o(l(C),{style:{width:"80px"}},{default:a(()=>e[15]||(e[15]=[i("ID",-1)])),_:1,__:[15]}),o(l(C),{style:{width:"120px"}},{default:a(()=>e[16]||(e[16]=[i("Participant",-1)])),_:1,__:[16]}),o(l(C),{style:{width:"120px"}},{default:a(()=>e[17]||(e[17]=[i("Plan(s)",-1)])),_:1,__:[17]}),o(l(C),{style:{width:"110px"}},{default:a(()=>e[18]||(e[18]=[i("Scope(s)",-1)])),_:1,__:[18]}),o(l(C),null,{default:a(()=>e[19]||(e[19]=[i("Updated",-1)])),_:1,__:[19]}),o(l(C),{style:{width:"90px"}},{default:a(()=>e[20]||(e[20]=[i("Actions",-1)])),_:1,__:[20]})]),_:1})]),_:1}),o(l(Ie),null,{default:a(()=>[g.value.length?G("",!0):(u(),L(l(X),{key:0},{default:a(()=>[o(l(_),{colspan:"9",class:"text-center text-muted py-3"},{default:a(()=>e[21]||(e[21]=[i("No outbox rows.",-1)])),_:1,__:[21]})]),_:1})),(u(!0),c(H,null,$(g.value,t=>(u(),L(l(X),{key:t.id},{default:a(()=>[o(l(_),null,{default:a(()=>[N(n("input",{type:"checkbox",value:t.id,"onUpdate:modelValue":e[2]||(e[2]=d=>v.value=d)},null,8,ze),[[Se,v.value]])]),_:2},1024),o(l(_),null,{default:a(()=>[i(f(t.id),1)]),_:2},1024),o(l(_),null,{default:a(()=>[i(f(t.participant_id),1)]),_:2},1024),o(l(_),null,{default:a(()=>[i(f(t.plan_ids_csv),1)]),_:2},1024),o(l(_),null,{default:a(()=>[i(f(t.record_scopes_csv),1)]),_:2},1024),o(l(_),{class:"small text-body-secondary"},{default:a(()=>[i(f(t.last_updated||"—"),1)]),_:2},1024),o(l(_),null,{default:a(()=>[n("button",{class:"btn btn-sm btn-outline-secondary me-1",title:"Preview",onClick:d=>be(t)},e[22]||(e[22]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[n("path",{d:"M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8"}),n("path",{d:"M8 5.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5"})],-1)]),8,Fe)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})),o(l(ue),{visible:k.value,size:"lg",alignment:"center",backdrop:"static",onClose:e[7]||(e[7]=t=>k.value=!1)},{default:a(()=>[o(l(oe),null,{default:a(()=>[o(l(ne),null,{default:a(()=>e[23]||(e[23]=[i("Generate Statements",-1)])),_:1,__:[23]})]),_:1}),o(l(ie),null,{default:a(()=>[n("div",Ve,[n("div",Be,[e[24]||(e[24]=n("label",{class:"form-label small"},"Participants (multi)",-1)),N(n("select",{multiple:"",class:"form-select","onUpdate:modelValue":e[3]||(e[3]=t=>p.value.participantIds=t)},[(u(!0),c(H,null,$(Y.value,t=>(u(),c("option",{key:t.id,value:t.id},f(we(t)),9,Ge))),128))],512),[[B,p.value.participantIds]]),e[25]||(e[25]=n("div",{class:"form-text"},"Pick at least one.",-1))]),n("div",He,[e[26]||(e[26]=n("label",{class:"form-label small"},"Plans (multi)",-1)),N(n("select",{multiple:"",class:"form-select","onUpdate:modelValue":e[4]||(e[4]=t=>p.value.planIds=t)},[(u(!0),c(H,null,$(Z.value,t=>(u(),c("option",{key:t.id,value:t.id},f(t.name||"Plan #"+t.id),9,$e))),128))],512),[[B,p.value.planIds]]),e[27]||(e[27]=n("div",{class:"form-text"},"Pick at least one.",-1))]),n("div",Oe,[e[28]||(e[28]=n("label",{class:"form-label small"},"Record Scope",-1)),N(n("select",{multiple:"",class:"form-select","onUpdate:modelValue":e[5]||(e[5]=t=>p.value.scope=t),disabled:D.value||!m.value.length},[D.value?(u(),c("option",We,"Loading scopes…")):G("",!0),(u(!0),c(H,null,$(m.value,t=>(u(),c("option",{key:t,value:t},f(t),9,je))),128))],8,Re),[[B,p.value.scope]]),E.value?(u(),c("div",qe,f(E.value),1)):G("",!0)]),I.value?(u(),c("div",Ke,[o(l(J),{color:"danger",class:"mb-0"},{default:a(()=>[i(f(I.value),1)]),_:1})])):G("",!0)])]),_:1}),o(l(de),null,{default:a(()=>[o(l(y),{color:"secondary",variant:"outline",onClick:e[6]||(e[6]=t=>k.value=!1),disabled:A.value},{default:a(()=>e[29]||(e[29]=[i("Cancel",-1)])),_:1,__:[29]},8,["disabled"]),o(l(y),{color:"dark",onClick:ye,disabled:A.value},{default:a(()=>[A.value?(u(),c("span",Je,[o(l(Q),{size:"sm",class:"me-2"}),e[30]||(e[30]=i("Working…",-1))])):(u(),c("span",Qe,"Calc → Outbox"))]),_:1},8,["disabled"])]),_:1})]),_:1},8,["visible"]),o(l(ue),{visible:R.value,size:"xl",alignment:"center",backdrop:"static",onClose:te,class:"wide-modal"},{default:a(()=>[o(l(oe),null,{default:a(()=>[o(l(ne),null,{default:a(()=>e[31]||(e[31]=[i("Preview Statement",-1)])),_:1,__:[31]})]),_:1}),o(l(ie),null,{default:a(()=>[W.value?(u(),c("div",Xe,[o(l(Q),{size:"sm",class:"me-2"}),e[32]||(e[32]=i(" Loading preview… ",-1))])):M.value?(u(),L(l(J),{key:1,color:"danger"},{default:a(()=>[i(f(M.value),1)]),_:1})):(u(),c("div",Ye,[P.value?(u(),c("iframe",{key:0,srcdoc:P.value,class:"preview-frame"},null,8,Ze)):(u(),c("pre",et,f(z.value),1))]))]),_:1}),o(l(de),null,{default:a(()=>[o(l(y),{color:"dark",onClick:te},{default:a(()=>e[33]||(e[33]=[i("Close",-1)])),_:1,__:[33]})]),_:1})]),_:1},8,["visible"])]))}},rt=Te(tt,[["__scopeId","data-v-06054146"]]);export{rt as default};
