import{r as v,n as N,o as Fe,w as ge,c as u,a,u as l,b as s,d as m,e as n,t as d,R as we,v as Ue,C as W,h as X,F as w,g as k,f as q,s as se,l as Z,i as S,j as ze,k as i,m as Re}from"./index-DPzvZzfM.js";import{C as Ee}from"./CBadge-CezT8RGM.js";import{C as c}from"./CButton-CxoqXei-.js";import{C as Be}from"./CButtonGroup-CWWZ1Zih.js";import{C as ee}from"./CCardHeader-CyVR9a-w.js";import{C as He}from"./CForm-23VFcb4J.js";import{C as Se}from"./CFormInput-BuocEiCo.js";import{C as ne}from"./CFormSelect-BnHHmKRI.js";import{C as qe,a as oe}from"./CRow-VS3LaBfk.js";import{C as ie,a as re,b as ue,c as de,d as pe}from"./CModalTitle-DUtptC4p.js";import{C as F}from"./CSpinner-4RQXIVOv.js";import{C as Ae,a as ke,b as te,c as x,d as xe,e as I}from"./CTable-DK-5-MOF.js";const je={class:"p-3"},Oe={key:0,class:"py-3"},Ge={key:1},he={key:2},Ye={class:"text-muted small"},Je={class:"d-flex gap-2"},Ke={key:0},Qe={key:0,class:"text-muted"},We={key:1},Xe={class:"d-flex flex-wrap"},Ze={key:1,class:"text-muted"},et={key:0},tt={key:1},lt={key:0,class:"text-muted"},at={class:"d-flex align-items-center mb-2"},st={class:"me-2"},nt={key:0,class:"text-muted"},ot={class:"mb-0 ps-3",style:{"list-style-type":"'ðŸ”Ž'"}},it={class:"me-2"},rt={class:"text-muted ms-2"},ut={key:0,class:"text-muted"},dt={key:1,class:"d-flex flex-column gap-2"},pt=["value","disabled"],mt=["value"],vt={key:0,class:"text-muted"},ft={key:1,class:"text-danger"},ct={key:2,class:"text-muted"},yt={class:"mb-3"},_t=["value"],bt={key:0,class:"text-danger mt-2"},Vt={__name:"ParticipantDetail",setup(Ct){const _=Ue(),me=ze(),le=v(!0),b=v({participant:null,plans:[]}),$=v(""),y=v(!0),U=v(!1),ve=v([]),z=v(""),V=v({loading:!0,plans:[]}),M=v({loading:!0,allInputs:[],plans:[]});v(!1),v(""),v("");const j=v(!1),O=v(!1),G=v(""),R=v(!1),A=v(!1),T=v(new Set),fe=N({get:()=>[...T.value],set:o=>{T.value=new Set(o.map(Number).filter(e=>Number.isFinite(e)))}}),Ie=N(()=>Math.min(10,Math.max(4,J.value.length))),E=v(["ACTUAL"]),C=v([]),h=v(!0),Y=v(""),ce=o=>{const e=Number(o??0);return Number.isFinite(e)?e.toLocaleString(void 0,{style:"currency",currency:"USD",maximumFractionDigits:2}):"â€”"},ye=N(()=>{var e;return(((e=b.value)==null?void 0:e.plans)||[]).map(t=>{var p,P,L;const r=t.planId??t.plan_id??((p=t.plan)==null?void 0:p.id)??t.cpId??t.cid??null,f=Number(t.isActive??t.is_active??((P=t.plan)==null?void 0:P.isActive)??((L=t.plan)==null?void 0:L.is_active)??1);return{...t,planId:r,isActive:f}}).filter(t=>t.planId)}),Pe=N(()=>{const o=new Map;for(const e of ye.value)o.set(Number(e.planId),Number(e.isActive));return o}),ae=N(()=>{const o=y.value?1:0,e=($.value||"").toLowerCase().trim(),t=ye.value.filter(r=>Number(r.isActive)===o);return e?t.filter(r=>String(r.name||"").toLowerCase().includes(e)||String(r.version||"").toLowerCase().includes(e)):t}),J=N(()=>ae.value),B=async()=>{var o,e,t;le.value=!0;try{const{data:r}=await S.get(`/api/participants/${_.params.id}`,{withCredentials:!0,params:{isActive:y.value?1:0}}),f=Array.isArray(r.plans)?r.plans:[];for(const p of f)p.planId=p.planId??p.plan_id??((o=p.plan)==null?void 0:o.id)??p.cpId??p.cid??null,p.isActive=Number(p.isActive??p.is_active??((e=p.plan)==null?void 0:e.isActive)??((t=p.plan)==null?void 0:t.is_active)??1);b.value={participant:r.participant??null,plans:f}}finally{le.value=!1}},Le=async()=>{const{data:o}=await S.get("/api/plans?isActive=1",{withCredentials:!0});ve.value=o||[]},H=async()=>{V.value.loading=!0;try{const{data:o}=await S.get(`/api/participants/${_.params.id}/payout-history`,{withCredentials:!0,params:{isActive:y.value?1:0}});V.value.plans=(o==null?void 0:o.plans)||[]}finally{V.value.loading=!1}},K=async()=>{M.value.loading=!0;try{const{data:o}=await S.get(`/api/participants/${_.params.id}/required-source-inputs`,{withCredentials:!0});M.value={loading:!1,allInputs:Array.isArray(o==null?void 0:o.allInputs)?o.allInputs:[],plans:Array.isArray(o==null?void 0:o.plans)?o.plans:[]}}catch(o){console.error(o),M.value={loading:!1,allInputs:[],plans:[]}}};async function _e(){var o,e;Y.value="",h.value=!0,C.value=[];try{let r=new Set,f=0;const p=500;let P=1/0;for(;f<P&&f<5e3;){const{data:L}=await S.get("/api/source-data",{withCredentials:!0,params:{participantId:_.params.id,limit:p,offset:f}}),g=L||{},D=Array.isArray(g)?g:g.records||[];P=Number(g.total??D.length??0)||0;for(const Q of D){const Ce=(Q.recordScope??Q.record_scope??"").toString().trim();Ce&&r.add(Ce)}if(f+=p,!D.length)break}C.value=Array.from(r).sort(),C.value.length||(C.value=["ACTUAL"])}catch(t){console.error(t),Y.value=((e=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:e.error)||"Failed to load record scopes",C.value.length||(C.value=["ACTUAL"])}finally{h.value=!1;const t=new Set((E.value||[]).map(r=>String(r||"").trim()).filter(Boolean));if(t.size){const r=new Set([...C.value,...t]);C.value=Array.from(r).sort()}}}Fe(async()=>{await Promise.all([B(),Le(),H(),K(),_e()])}),ge(()=>_.params.id,async()=>{await Promise.all([B(),H(),K(),_e()])}),ge(y,async()=>{T.value=new Set,$.value="",await Promise.all([B(),H()])});const De=o=>me.push({name:"PlanDetail",params:{id:o}}),Ne=async()=>{z.value&&(await S.post(`/api/participants/${_.params.id}/plans`,{planId:Number(z.value)},{withCredentials:!0}),U.value=!1,await Promise.all([B(),H(),K()]))},$e=async o=>{confirm("Detach this plan from the participant? All historical calculations will be removed.")&&(await S.delete(`/api/participants/${_.params.id}/plans/${o}`,{withCredentials:!0}),await Promise.all([B(),H(),K()]))},Ve=()=>{G.value="",j.value=!0},Me=async()=>{var o,e;O.value=!0;try{await S.delete(`/api/participants/${_.params.id}`,{withCredentials:!0}),me.push({name:"ParticipantsList"})}catch(t){console.error(t),G.value=((e=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:e.error)||"Failed to delete"}finally{O.value=!1}},Te=async()=>{var r,f;if(!T.value.size)return;const o=Array.from(T.value),e=Array.isArray(E.value)?E.value.map(p=>String(p||"").trim()).filter(Boolean):[],t=e.length?e:["ACTUAL"];A.value=!0;try{const{data:p}=await S.post(`/api/participants/${_.params.id}/comp-statement`,{planIds:o,recordScopes:t},{withCredentials:!0,responseType:"blob"}),P=new Blob([p],{type:"text/html"}),L=URL.createObjectURL(P),g=document.createElement("a"),D=new Date,Q=`${D.getFullYear()}-${String(D.getMonth()+1).padStart(2,"0")}-${String(D.getDate()).padStart(2,"0")}`;g.href=L,g.download=`CompStatement_${((f=(r=b.value)==null?void 0:r.participant)==null?void 0:f.lastName)??"Participant"}_${Q}.html`,document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(L),R.value=!1}catch(p){console.error(p),alert("Failed to generate statement")}finally{A.value=!1}},be=N(()=>{var t;const o=y.value?1:0;return(Array.isArray((t=V.value)==null?void 0:t.plans)?V.value.plans:[]).filter(r=>{const f=r.isActive??r.is_active;return(f!=null?Number(f):Pe.value.get(Number(r.planId))??null)===o})});return(o,e)=>(i(),u("div",je,[le.value?(i(),u("div",Oe,[a(l(F))])):b.value.participant?(i(),u("div",he,[a(l(X),{class:"mb-3"},{default:s(()=>[a(l(ee),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:s(()=>[m("span",null,[n(" Participant: "+d(b.value.participant.firstName)+" "+d(b.value.participant.lastName)+" ",1),m("span",Ye,"(#"+d(b.value.participant.id)+")",1)]),m("div",Je,[a(l(we),{class:"btn btn-outline-primary me-2",to:{name:"ParticipantEdit",params:{id:l(_).params.id}}},{default:s(()=>e[15]||(e[15]=[n("Edit",-1)])),_:1,__:[15]},8,["to"]),a(l(c),{color:"danger",variant:"outline",onClick:Ve},{default:s(()=>e[16]||(e[16]=[n("Delete",-1)])),_:1,__:[16]}),a(l(c),{color:"primary",size:"sm",onClick:e[0]||(e[0]=t=>U.value=!0)},{default:s(()=>e[17]||(e[17]=[n("Attach Plan",-1)])),_:1,__:[17]}),a(l(c),{color:"warning",size:"sm",onClick:e[1]||(e[1]=t=>R.value=!0)},{default:s(()=>e[18]||(e[18]=[n("Comp Statement",-1)])),_:1,__:[18]})])]),_:1}),a(l(W),null,{default:s(()=>[a(l(qe),null,{default:s(()=>[a(l(oe),{md:"4"},{default:s(()=>[e[19]||(e[19]=m("strong",null,"Email:",-1)),n(" "+d(b.value.participant.email),1)]),_:1,__:[19]}),a(l(oe),{md:"4"},{default:s(()=>[e[20]||(e[20]=m("strong",null,"ID:",-1)),n(" "+d(b.value.participant.id),1)]),_:1,__:[20]}),a(l(oe),{md:"4"},{default:s(()=>[e[21]||(e[21]=m("strong",null,"Created:",-1)),n(" "+d(new Date(b.value.participant.createdAt).toLocaleString()),1)]),_:1,__:[21]})]),_:1})]),_:1})]),_:1}),a(l(X),{class:"mb-3"},{default:s(()=>[a(l(ee),{class:"fw-semibold"},{default:s(()=>e[22]||(e[22]=[n("Required Source Data Inputs",-1)])),_:1,__:[22]}),a(l(W),null,{default:s(()=>[M.value.loading?(i(),u("div",Ke,[a(l(F))])):(i(),u(w,{key:1},[M.value.allInputs.length?(i(),u("div",We,[e[23]||(e[23]=m("h6",{class:"mb-2"},"All required data source labels for this participant, based on their attached plans & computations.",-1)),m("div",Xe,[(i(!0),u(w,null,k(M.value.allInputs,t=>(i(),u("span",{key:"all-"+t,class:"badge rounded-pill text-bg-secondary me-2 mb-2"},d(t),1))),128))])])):(i(),u("div",Qe," No source data requirements detected for this participantâ€™s attached plans. "))],64))]),_:1})]),_:1}),a(l(X),null,{default:s(()=>[a(l(ee),{class:"fw-semibold d-flex align-items-center justify-content-between"},{default:s(()=>[e[26]||(e[26]=m("span",null,"Attached Plans",-1)),a(l(Be),{size:"sm"},{default:s(()=>[a(l(c),{color:y.value?"primary":"secondary",onClick:e[2]||(e[2]=t=>y.value=!0)},{default:s(()=>e[24]||(e[24]=[n("Active",-1)])),_:1,__:[24]},8,["color"]),a(l(c),{color:y.value?"secondary":"primary",onClick:e[3]||(e[3]=t=>y.value=!1)},{default:s(()=>e[25]||(e[25]=[n("Archived",-1)])),_:1,__:[25]},8,["color"])]),_:1})]),_:1,__:[26]}),a(l(W),null,{default:s(()=>[ae.value.length?(i(),u(w,{key:0},[a(l(Se),{modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=t=>$.value=t),placeholder:"Filter plansâ€¦",class:"mb-3"},null,8,["modelValue"]),a(l(Ae),{hover:"",responsive:""},{default:s(()=>[a(l(ke),null,{default:s(()=>[a(l(te),null,{default:s(()=>[a(l(x),null,{default:s(()=>e[27]||(e[27]=[n("Name",-1)])),_:1,__:[27]}),a(l(x),null,{default:s(()=>e[28]||(e[28]=[n("Plan Effective",-1)])),_:1,__:[28]}),a(l(x),null,{default:s(()=>e[29]||(e[29]=[n("Attached",-1)])),_:1,__:[29]}),a(l(x),null,{default:s(()=>e[30]||(e[30]=[n("Actions",-1)])),_:1,__:[30]})]),_:1})]),_:1}),a(l(xe),null,{default:s(()=>[(i(!0),u(w,null,k(ae.value,t=>(i(),Z(l(te),{key:t.planId},{default:s(()=>[a(l(I),null,{default:s(()=>[a(l(c),{class:"btn btn-sm btn-outline-primary me-2",onClick:Re(r=>De(t.planId),["stop"])},{default:s(()=>[n(d(t.name),1)]),_:2},1032,["onClick"]),e[31]||(e[31]=n("Â ",-1))]),_:2,__:[31]},1024),a(l(I),null,{default:s(()=>[n(d(t.planEffectiveStart||"â€”")+" â†’ "+d(t.planEffectiveEnd||"â€”"),1)]),_:2},1024),a(l(I),null,{default:s(()=>[n(d(new Date(t.attachedAt).toLocaleString()),1)]),_:2},1024),a(l(I),null,{default:s(()=>[a(l(c),{color:"secondary",size:"sm",onClick:r=>$e(t.planId)},{default:s(()=>e[32]||(e[32]=[n("Detach",-1)])),_:2,__:[32]},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})],64)):(i(),u("div",Ze,"No "+d(y.value?"active":"archived")+" plans attached.",1))]),_:1})]),_:1}),a(l(X),{class:"mt-3"},{default:s(()=>[a(l(ee),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:s(()=>[e[34]||(e[34]=m("span",null,"Payout History (by Plan & Period)",-1)),a(l(we),{class:"btn btn-sm btn-outline-primary",to:{name:"PlansList"}},{default:s(()=>e[33]||(e[33]=[n("View Plans",-1)])),_:1,__:[33]})]),_:1,__:[34]}),a(l(W),null,{default:s(()=>[V.value.loading?(i(),u("div",et,[a(l(F))])):(i(),u("div",tt,[be.value.length?q("",!0):(i(),u("div",lt,"No payout history for "+d(y.value?"active":"archived")+" plans.",1)),(i(!0),u(w,null,k(be.value,t=>(i(),u("div",{key:t.planId,class:"mb-4"},[m("div",at,[m("strong",st,d(t.planName),1),a(l(Ee),{color:"secondary",class:"me-2"},{default:s(()=>[n("v"+d(t.planVersion),1)]),_:2},1024)]),a(l(Ae),{hover:"",responsive:"",small:""},{default:s(()=>[a(l(ke),null,{default:s(()=>[a(l(te),null,{default:s(()=>[a(l(x),{style:{"min-width":"120px"}},{default:s(()=>e[35]||(e[35]=[n("Period",-1)])),_:1,__:[35]}),a(l(x),{style:{"min-width":"120px"}},{default:s(()=>e[36]||(e[36]=[n("Period End Date",-1)])),_:1,__:[36]}),a(l(x),{style:{"min-width":"160px","text-align":"center"}},{default:s(()=>e[37]||(e[37]=[n("Total Payout",-1)])),_:1,__:[37]}),a(l(x),null,{default:s(()=>e[38]||(e[38]=[n("Computations",-1)])),_:1,__:[38]})]),_:1})]),_:1}),a(l(xe),null,{default:s(()=>[(i(!0),u(w,null,k(t.periods,r=>(i(),Z(l(te),{key:r.periodStart+"|"+r.periodEnd+"|"+(r.periodLabel||"")},{default:s(()=>[a(l(I),null,{default:s(()=>[m("div",null,[n(d(new Date(r.periodStart).toISOString().split("T")[0])+" â­¾ ",1),e[39]||(e[39]=m("br",null,null,-1)),n(d(new Date(r.periodEnd).toISOString().split("T")[0]),1)])]),_:2},1024),a(l(I),null,{default:s(()=>[n(d(new Date(r.dueDate).toISOString().split("T")[0]),1),e[40]||(e[40]=m("br",null,null,-1)),r.periodLabel?(i(),u("small",nt,d(r.periodLabel),1)):q("",!0)]),_:2,__:[40]},1024),a(l(I),{style:{"text-align":"center"}},{default:s(()=>[m("strong",null,d(ce(r.total)),1)]),_:2},1024),a(l(I),null,{default:s(()=>[m("ul",ot,[(i(!0),u(w,null,k(r.lines,(f,p)=>(i(),u("li",{key:f.outputLabel+"|"+p},[m("span",it,d(f.outputLabel),1),m("strong",null,d(ce(f.amount)),1),m("small",rt,d(new Date(f.createdAt).toLocaleString()),1)]))),128))])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1}),a(l(pe),{visible:R.value,onClose:e[9]||(e[9]=t=>R.value=!1),alignment:"center",backdrop:"static"},{default:s(()=>[a(l(ie),null,{default:s(()=>[a(l(re),null,{default:s(()=>e[41]||(e[41]=[n("Generate Comp Statement",-1)])),_:1,__:[41]})]),_:1}),a(l(ue),null,{default:s(()=>[e[46]||(e[46]=m("div",{class:"mb-2 text-muted"},"Select plan(s) and record scope(s) to include:",-1)),J.value.length?(i(),u("div",dt,[a(l(Se),{modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=t=>$.value=t),placeholder:"Filter plansâ€¦",class:"mb-2",disabled:A.value},null,8,["modelValue","disabled"]),a(l(se),{for:"planSelectMulti",class:"mb-1"},{default:s(()=>e[42]||(e[42]=[n("Plans",-1)])),_:1,__:[42]}),a(l(ne),{id:"planSelectMulti",multiple:"",size:Ie.value,modelValue:fe.value,"onUpdate:modelValue":e[6]||(e[6]=t=>fe.value=t),disabled:A.value||!J.value.length,style:{"max-height":"260px",overflow:"auto"}},{default:s(()=>[(i(!0),u(w,null,k(J.value,t=>(i(),u("option",{key:t.id??t.planId,value:t.planId,disabled:!(t!=null&&t.planId)},d((t==null?void 0:t.name)??"Unnamed")+" (v"+d((t==null?void 0:t.version)??"?")+") ",9,pt))),128))]),_:1},8,["size","modelValue","disabled"]),a(l(se),{for:"scopeSelectMulti",class:"mb-1 mt-3"},{default:s(()=>e[43]||(e[43]=[n("Record Scopes",-1)])),_:1,__:[43]}),a(l(ne),{id:"scopeSelectMulti",multiple:"",size:Math.min(8,Math.max(4,(C.value||[]).length||4)),modelValue:E.value,"onUpdate:modelValue":e[7]||(e[7]=t=>E.value=t),disabled:A.value||h.value,style:{"max-height":"220px",overflow:"auto"}},{default:s(()=>[(i(!0),u(w,null,k(C.value,t=>(i(),u("option",{key:t,value:t},d(t),9,mt))),128))]),_:1},8,["size","modelValue","disabled"]),h.value?(i(),u("small",vt,[a(l(F),{size:"sm",class:"me-1"}),e[44]||(e[44]=n("Loading record scopesâ€¦ ",-1))])):Y.value?(i(),u("small",ft,d(Y.value),1)):(i(),u("small",ct,e[45]||(e[45]=[n(" Select one or more scopes (defaults to ",-1),m("strong",null,"ACTUAL",-1),n(" if none selected). ",-1)])))])):(i(),u("div",ut," This participant has no "+d(y.value?"active":"archived")+" plans. ",1))]),_:1,__:[46]}),a(l(de),null,{default:s(()=>[a(l(c),{color:"secondary",onClick:e[8]||(e[8]=t=>R.value=!1),disabled:A.value},{default:s(()=>e[47]||(e[47]=[n("Cancel",-1)])),_:1,__:[47]},8,["disabled"]),a(l(c),{color:"primary",onClick:Te,disabled:A.value||!T.value.size},{default:s(()=>[A.value?(i(),Z(l(F),{key:0,size:"sm",class:"me-2"})):q("",!0),e[48]||(e[48]=n(" Generate Statement ",-1))]),_:1,__:[48]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(l(pe),{visible:U.value,onClose:e[12]||(e[12]=t=>U.value=!1)},{default:s(()=>[a(l(ie),null,{default:s(()=>[a(l(re),null,{default:s(()=>e[49]||(e[49]=[n("Attach Plan",-1)])),_:1,__:[49]})]),_:1}),a(l(ue),null,{default:s(()=>[a(l(He),null,{default:s(()=>[m("div",yt,[a(l(se),{for:"planSelectSingle"},{default:s(()=>e[50]||(e[50]=[n("Available Plans",-1)])),_:1,__:[50]}),a(l(ne),{id:"planSelectSingle",modelValue:z.value,"onUpdate:modelValue":e[10]||(e[10]=t=>z.value=t)},{default:s(()=>[e[51]||(e[51]=m("option",{value:""},"Select a planâ€¦",-1)),(i(!0),u(w,null,k(ve.value,t=>(i(),u("option",{key:t.id,value:t.id},d(t.name)+" (v"+d(t.version)+")",9,_t))),128))]),_:1,__:[51]},8,["modelValue"])])]),_:1})]),_:1}),a(l(de),null,{default:s(()=>[a(l(c),{color:"secondary",onClick:e[11]||(e[11]=t=>U.value=!1)},{default:s(()=>e[52]||(e[52]=[n("Cancel",-1)])),_:1,__:[52]}),a(l(c),{color:"primary",disabled:!z.value,onClick:Ne},{default:s(()=>e[53]||(e[53]=[n("Attach",-1)])),_:1,__:[53]},8,["disabled"])]),_:1})]),_:1},8,["visible"]),a(l(pe),{visible:j.value,onClose:e[14]||(e[14]=t=>j.value=!1)},{default:s(()=>[a(l(ie),null,{default:s(()=>[a(l(re),null,{default:s(()=>e[54]||(e[54]=[n("Delete participant?",-1)])),_:1,__:[54]})]),_:1}),a(l(ue),null,{default:s(()=>[e[55]||(e[55]=n(" This cannot be undone. Continue? ",-1)),G.value?(i(),u("div",bt,d(G.value),1)):q("",!0)]),_:1,__:[55]}),a(l(de),null,{default:s(()=>[a(l(c),{color:"secondary",onClick:e[13]||(e[13]=t=>j.value=!1)},{default:s(()=>e[56]||(e[56]=[n("Cancel",-1)])),_:1,__:[56]}),a(l(c),{color:"danger",disabled:O.value,onClick:Me},{default:s(()=>[O.value?(i(),Z(l(F),{key:0,size:"sm",class:"me-2"})):q("",!0),e[57]||(e[57]=n(" Delete ",-1))]),_:1,__:[57]},8,["disabled"])]),_:1})]),_:1},8,["visible"])])):(i(),u("div",Ge,"Not found."))]))}};export{Vt as default};
