import{r as m,v as M,o as O,c as b,a as l,w as o,u as a,b as _,d as g,e as r,t as y,C as T,k as w,l as W,p as x,x as q,n as J,g as Z,h as B,q as h,i as H,j as i}from"./index-BXcD_kmr.js";import{C as S}from"./CAlert-BJ_GydCQ.js";import{C as E}from"./CButton-C0dYOckc.js";import{C as K}from"./CCardHeader-DcxfLPA6.js";import{C as P}from"./CForm-DWyBq6rl.js";import{C as G}from"./CFormInput-CmSSQgNv.js";import{C as Q}from"./CFormSelect-QfrdN0T-.js";import{C as $}from"./CFormTextarea-5VAS0g7X.js";import{C as X,a as V}from"./CRow-BZBZ-KlX.js";import{C as z}from"./CSpinner-DgGZRi-H.js";const Y={class:"p-3"},ee={key:0,class:"text-muted"},ae={key:0},le={key:0,class:"py-3"},te={key:1},oe={class:"d-flex justify-content-between align-items-center"},se={class:"d-flex gap-2"},ne={class:"mt-2"},ue={class:"d-flex gap-2 mt-4"},be={__name:"ElementEdit",setup(re){const F=h(),L=H(),A=m(!0),k=m(!1),c=m(""),s=m({name:"",scope:"payout",formula:"",notes:""}),C=m({createdAt:null,updatedAt:null}),R=M(()=>/^[A-Za-z_][A-Za-z0-9_]*$/.test(s.value.name||"")),N=M(()=>!!s.value.name&&R.value),f=m(!1),v=m(""),p=m(""),D=/\b(globalThis|global|process|require|module|exports|Function|eval|constructor|__proto__|child_process|fs|import)\b/;function I(){f.value=!0,v.value="",p.value="";const u=String(s.value.formula||"").trim();if(!u){p.value="ok",v.value="Empty formula is allowed.",f.value=!1;return}if(D.test(u)){p.value="err",v.value="Blocked: forbidden token.",f.value=!1;return}try{const e=/\breturn\b/.test(u),n=/\b(?:const|let|var)\b/.test(u)||/;|\n/.test(u),t=e?u:n?(()=>{throw new Error("Multi-line formulas must include an explicit `return ...`")})():`return (${u});`;new Function("sum","avg","min","max","count","clamp","period","participantId","planId",`"use strict"; ${t}`),p.value="ok",v.value="Looks good. Syntax check passed."}catch(e){p.value="err",v.value=`Syntax error: ${(e==null?void 0:e.message)||e}`}finally{f.value=!1}}async function U(){var u,e;A.value=!0,c.value="";try{const{data:n}=await B.get(`/api/element-definitions/${F.params.id}`,{withCredentials:!0}),t=(n==null?void 0:n.element)||n||{};s.value={name:t.name||"",scope:t.scope||"payout",formula:t.formula||"",notes:t.notes||""},C.value={createdAt:t.createdAt||null,updatedAt:t.updatedAt||null}}catch(n){c.value=((e=(u=n==null?void 0:n.response)==null?void 0:u.data)==null?void 0:e.error)||"Failed to load element"}finally{A.value=!1}}O(U);async function j(){var u,e,n,t;if(N.value){k.value=!0,c.value="";try{await B.put(`/api/element-definitions/${F.params.id}`,{name:s.value.name,scope:s.value.scope,formula:s.value.formula||null,notes:s.value.notes||null},{withCredentials:!0}),L.push({name:"ElementsList"})}catch(d){c.value=((e=(u=d==null?void 0:d.response)==null?void 0:u.data)==null?void 0:e.detail)||((t=(n=d==null?void 0:d.response)==null?void 0:n.data)==null?void 0:t.error)||(d==null?void 0:d.message)||"Save failed"}finally{k.value=!1}}}return(u,e)=>{const n=J("router-link");return i(),b("div",Y,[l(a(Z),null,{default:o(()=>[l(a(K),{class:"fw-semibold d-flex justify-content-between align-items-center"},{default:o(()=>[e[5]||(e[5]=_("span",null,"Edit Element",-1)),C.value.createdAt?(i(),b("small",ee,[r(" Created: "+y(new Date(C.value.createdAt).toLocaleString())+" ",1),C.value.updatedAt?(i(),b("span",ae," • Updated: "+y(new Date(C.value.updatedAt).toLocaleString()),1)):g("",!0)])):g("",!0)]),_:1,__:[5]}),l(a(T),null,{default:o(()=>[A.value?(i(),b("div",le,[l(a(z))])):(i(),b("div",te,[c.value?(i(),w(a(S),{key:0,color:"danger",class:"mb-3"},{default:o(()=>[r(y(c.value),1)]),_:1})):g("",!0),l(a(P),{onSubmit:W(j,["prevent"])},{default:o(()=>[l(a(X),{class:"g-3"},{default:o(()=>[l(a(V),{md:"6"},{default:o(()=>[l(a(x),null,{default:o(()=>e[6]||(e[6]=[r("Element Name",-1)])),_:1,__:[6]}),l(a(G),{modelValue:s.value.name,"onUpdate:modelValue":e[0]||(e[0]=t=>s.value.name=t),placeholder:"NEW_ARR"},null,8,["modelValue"]),_("small",{class:q(R.value?"text-body-secondary":"text-danger")}," Must be a valid JS identifier. ",2)]),_:1}),l(a(V),{md:"6"},{default:o(()=>[l(a(x),null,{default:o(()=>e[7]||(e[7]=[r("Scope",-1)])),_:1,__:[7]}),l(a(Q),{modelValue:s.value.scope,"onUpdate:modelValue":e[1]||(e[1]=t=>s.value.scope=t),options:[{label:"Per payout period",value:"payout"},{label:"Entire plan window",value:"plan"}]},null,8,["modelValue"])]),_:1}),l(a(V),{md:"12"},{default:o(()=>[_("div",oe,[l(a(x),{class:"mb-0"},{default:o(()=>e[8]||(e[8]=[r("Formula (JavaScript)",-1)])),_:1,__:[8]}),_("div",se,[l(a(E),{color:"secondary",variant:"outline",size:"sm",onClick:e[2]||(e[2]=t=>s.value.formula=(s.value.formula?s.value.formula+"\\n":"")+"0.05 * sum(NEW_ARR.value)")},{default:o(()=>e[9]||(e[9]=[r(" Insert example ",-1)])),_:1,__:[9]}),l(a(E),{color:"secondary",size:"sm",disabled:f.value,onClick:I},{default:o(()=>[r(y(f.value?"Validating…":"Validate syntax"),1)]),_:1},8,["disabled"])])]),l(a($),{modelValue:s.value.formula,"onUpdate:modelValue":e[3]||(e[3]=t=>s.value.formula=t),rows:"8",placeholder:"e.g. 0.05 * sum(NEW_ARR.value)",style:{"font-family":"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace"}},null,8,["modelValue"]),_("div",ne,[p.value==="ok"?(i(),w(a(S),{key:0,color:"success",class:"py-2"},{default:o(()=>[r(y(v.value),1)]),_:1})):p.value==="err"?(i(),w(a(S),{key:1,color:"danger",class:"py-2"},{default:o(()=>[r(y(v.value),1)]),_:1})):g("",!0)])]),_:1}),l(a(V),{md:"12"},{default:o(()=>[l(a(x),null,{default:o(()=>e[10]||(e[10]=[r("Notes",-1)])),_:1,__:[10]}),l(a($),{modelValue:s.value.notes,"onUpdate:modelValue":e[4]||(e[4]=t=>s.value.notes=t),rows:"3",placeholder:"Optional notes…"},null,8,["modelValue"])]),_:1})]),_:1}),_("div",ue,[l(a(E),{type:"submit",color:"primary",disabled:!N.value||k.value},{default:o(()=>[k.value?(i(),w(a(z),{key:0,size:"sm",class:"me-2"})):g("",!0),e[11]||(e[11]=r(" Save ",-1))]),_:1,__:[11]},8,["disabled"]),l(n,{class:"btn btn-secondary",to:{name:"ElementsList"}},{default:o(()=>e[12]||(e[12]=[r("Cancel",-1)])),_:1,__:[12]})])]),_:1})]))]),_:1})]),_:1})])}}};export{be as default};
